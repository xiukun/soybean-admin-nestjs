# 实体管理设计器完善开发需求文档

## 项目概述

本项目旨在完善低代码平台的实体管理设计器功能，解决当前存在的元素堆叠问题，实现自动布局、关系连线、性能优化等核心功能，提供完整的可视化实体关系设计体验。

## 当前问题分析

### 1. 现有问题
- **元素堆叠**: 实体节点初始化时位置重叠，缺乏智能布局
- **缺少关系连线**: 无法可视化展示实体间的关系
- **性能问题**: 大量实体渲染时性能不佳
- **布局保存**: 缺少布局状态的持久化机制
- **交互体验**: 缺少丰富的交互功能

### 2. 技术架构现状
- **前端**: 简化版实体设计器，基于 Vue 3 + DOM 操作
- **后端**: 完整的关系管理 API 已实现
- **数据模型**: 实体、字段、关系模型完善

## 核心需求

### 1. 实体节点布局优化

#### 1.1 自动布局算法
- **力导向布局**: 实现基于物理模拟的自动布局
- **层次布局**: 支持树形结构的层次化布局
- **网格布局**: 提供规整的网格对齐布局
- **圆形布局**: 支持环形分布布局

#### 1.2 布局配置
```typescript
interface LayoutConfig {
  type: 'force' | 'hierarchy' | 'grid' | 'circular';
  spacing: {
    nodeSpacing: number;
    rankSpacing: number;
  };
  animation: {
    enabled: boolean;
    duration: number;
    easing: string;
  };
}
```

#### 1.3 智能避让
- 节点重叠检测与自动调整
- 边界约束与画布适应
- 最小间距保证

### 2. 实体关系连线功能

#### 2.1 关系类型支持
- **一对一 (1:1)**: 直线连接，单箭头
- **一对多 (1:N)**: 直线连接，鸦爪箭头
- **多对一 (N:1)**: 直线连接，反向鸦爪箭头
- **多对多 (N:N)**: 虚线连接，双向箭头

#### 2.2 连线交互
- **拖拽创建**: 从源实体拖拽到目标实体创建关系
- **连线编辑**: 双击连线编辑关系属性
- **连线删除**: 选中连线后删除关系
- **连线样式**: 支持不同样式和颜色

#### 2.3 关系数据结构
```typescript
interface EntityRelationship {
  id: string;
  name: string;
  type: 'ONE_TO_ONE' | 'ONE_TO_MANY' | 'MANY_TO_ONE' | 'MANY_TO_MANY';
  sourceEntityId: string;
  targetEntityId: string;
  sourceFieldId?: string;
  targetFieldId?: string;
  description?: string;
  style: {
    lineColor: string;
    lineWidth: number;
    lineStyle: 'solid' | 'dashed' | 'dotted';
  };
}
```

### 3. 性能优化方案

#### 3.1 虚拟化渲染
- **视口裁剪**: 只渲染可见区域的实体
- **LOD (Level of Detail)**: 根据缩放级别调整渲染细节
- **批量更新**: 合并多个更新操作

#### 3.2 数据优化
- **懒加载**: 按需加载实体详细信息
- **缓存机制**: 缓存计算结果和渲染数据
- **增量更新**: 只更新变化的部分

#### 3.3 渲染优化
```typescript
interface PerformanceConfig {
  maxVisibleNodes: number; // 最大可见节点数
  renderThreshold: number; // 渲染阈值
  updateBatchSize: number; // 批量更新大小
  cacheSize: number; // 缓存大小
}
```

### 4. 布局状态管理

#### 4.1 状态持久化
- **本地存储**: 保存用户的布局偏好
- **服务端同步**: 将布局信息保存到数据库
- **版本管理**: 支持布局历史版本

#### 4.2 布局数据结构
```typescript
interface LayoutState {
  projectId: string;
  entities: Array<{
    id: string;
    x: number;
    y: number;
    width: number;
    height: number;
    color?: string;
  }>;
  relationships: Array<{
    id: string;
    points?: Array<{ x: number; y: number }>;
    style: RelationshipStyle;
  }>;
  viewport: {
    x: number;
    y: number;
    zoom: number;
  };
  layoutConfig: LayoutConfig;
  lastModified: string;
}
```

## 技术实现方案

### 1. 前端架构升级

#### 1.1 组件重构
```
src/views/lowcode/entity/components/
├── EntityDesigner.vue              # 主设计器组件
├── EntityNode.vue                  # 实体节点组件
├── RelationshipLine.vue            # 关系连线组件
├── DesignerToolbar.vue             # 工具栏组件
├── LayoutPanel.vue                 # 布局配置面板
├── PerformanceMonitor.vue          # 性能监控组件
└── hooks/
    ├── useEntityLayout.ts          # 布局逻辑
    ├── useRelationshipManager.ts   # 关系管理
    ├── usePerformanceOptimizer.ts  # 性能优化
    └── useLayoutPersistence.ts     # 布局持久化
```

#### 1.2 核心 Hook 实现

**useEntityLayout.ts**
```typescript
export function useEntityLayout() {
  const entities = ref<Entity[]>([]);
  const layoutConfig = ref<LayoutConfig>(defaultLayoutConfig);
  
  // 自动布局算法
  const applyAutoLayout = async (type: LayoutType) => {
    // 实现不同布局算法
  };
  
  // 避免重叠
  const resolveOverlaps = () => {
    // 检测并解决节点重叠
  };
  
  return {
    entities,
    layoutConfig,
    applyAutoLayout,
    resolveOverlaps
  };
}
```

**useRelationshipManager.ts**
```typescript
export function useRelationshipManager() {
  const relationships = ref<EntityRelationship[]>([]);
  
  // 创建关系
  const createRelationship = async (config: CreateRelationshipConfig) => {
    // 调用后端 API 创建关系
  };
  
  // 更新关系
  const updateRelationship = async (id: string, updates: Partial<EntityRelationship>) => {
    // 更新关系信息
  };
  
  // 删除关系
  const deleteRelationship = async (id: string) => {
    // 删除关系
  };
  
  return {
    relationships,
    createRelationship,
    updateRelationship,
    deleteRelationship
  };
}
```

### 2. 后端 API 扩展

#### 2.1 布局管理 API
```typescript
// 保存布局
POST /api/v1/entity-layouts
{
  projectId: string;
  layoutData: LayoutState;
}

// 获取布局
GET /api/v1/entity-layouts/:projectId

// 更新布局
PUT /api/v1/entity-layouts/:projectId

// 删除布局
DELETE /api/v1/entity-layouts/:projectId
```

#### 2.2 性能优化 API
```typescript
// 获取实体摘要（用于大量数据场景）
GET /api/v1/entities/summary?projectId=xxx&limit=100&offset=0

// 批量获取关系
POST /api/v1/relationships/batch
{
  entityIds: string[];
}
```

### 3. 数据库扩展

#### 3.1 布局表设计
```sql
CREATE TABLE entity_layouts (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  layout_data JSON NOT NULL,
  version INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_by VARCHAR(36),
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  INDEX idx_project_id (project_id)
);
```

## 开发任务分解

### 阶段一：基础功能完善 (1-2周)

#### 任务 1.1: 实体节点布局优化
- [ ] 实现智能初始化布局算法
- [ ] 添加节点重叠检测与避让
- [ ] 实现基础的自动布局功能
- [ ] 添加布局动画效果

#### 任务 1.2: 关系连线基础功能
- [ ] 实现关系数据获取与展示
- [ ] 添加基础连线渲染
- [ ] 实现连线样式配置
- [ ] 添加连线交互事件

#### 任务 1.3: 工具栏功能
- [ ] 完善设计器工具栏
- [ ] 添加缩放控制功能
- [ ] 实现画布适应功能
- [ ] 添加布局切换功能

### 阶段二：高级功能开发 (2-3周)

#### 任务 2.1: 关系管理完善
- [ ] 实现拖拽创建关系
- [ ] 添加关系编辑功能
- [ ] 实现关系删除功能
- [ ] 添加关系验证逻辑

#### 任务 2.2: 布局算法优化
- [ ] 实现力导向布局算法
- [ ] 添加层次布局算法
- [ ] 实现网格布局算法
- [ ] 添加圆形布局算法

#### 任务 2.3: 状态持久化
- [ ] 实现布局状态保存
- [ ] 添加布局状态恢复
- [ ] 实现布局历史管理
- [ ] 添加布局导入导出

### 阶段三：性能优化 (1-2周)

#### 任务 3.1: 渲染性能优化
- [ ] 实现虚拟化渲染
- [ ] 添加 LOD 渲染策略
- [ ] 实现批量更新机制
- [ ] 添加渲染缓存

#### 任务 3.2: 数据性能优化
- [ ] 实现懒加载机制
- [ ] 添加数据缓存策略
- [ ] 实现增量更新
- [ ] 添加性能监控

#### 任务 3.3: 用户体验优化
- [ ] 添加加载状态提示
- [ ] 实现操作撤销重做
- [ ] 添加快捷键支持
- [ ] 优化交互反馈

### 阶段四：测试与优化 (1周)

#### 任务 4.1: 功能测试
- [ ] 单元测试编写
- [ ] 集成测试编写
- [ ] E2E 测试编写
- [ ] 性能测试执行

#### 任务 4.2: 用户体验测试
- [ ] 可用性测试
- [ ] 性能基准测试
- [ ] 兼容性测试
- [ ] 压力测试

## 验收标准

### 功能验收
- [ ] 实体节点不再堆叠，初始化布局合理
- [ ] 支持多种自动布局算法
- [ ] 实体关系可视化连线正确显示
- [ ] 支持拖拽创建、编辑、删除关系
- [ ] 布局状态可以保存和恢复
- [ ] 大量实体（100+）渲染性能良好

### 性能验收
- [ ] 100个实体渲染时间 < 1秒
- [ ] 500个实体渲染时间 < 3秒
- [ ] 内存使用稳定，无明显泄漏
- [ ] 交互响应时间 < 100ms

### 用户体验验收
- [ ] 界面操作直观易懂
- [ ] 提供丰富的视觉反馈
- [ ] 支持键盘快捷键操作
- [ ] 错误处理友好

## 风险评估

### 技术风险
- **复杂度风险**: 布局算法实现复杂度较高
- **性能风险**: 大量数据渲染可能影响性能
- **兼容性风险**: 不同浏览器的渲染差异

### 解决方案
- 采用成熟的布局算法库
- 实现渐进式性能优化
- 充分的浏览器兼容性测试

## 总结

本开发需求文档详细规划了实体管理设计器的完善方案，涵盖了布局优化、关系连线、性能优化等核心功能。通过分阶段的开发计划，确保项目能够稳步推进，最终交付一个功能完善、性能优良的可视化实体关系设计器。