# 低代码平台开发需求文档

## 📋 项目概述

### 项目名称
低代码平台代码生成器完善项目

### 项目目标
完善现有低代码平台的代码生成功能，实现从实体定义到可运行API的完整自动化流程，支持Amis框架兼容的业务应用快速开发。

### 技术栈
- **后端**: NestJS + Fastify + PostgreSQL + Prisma
- **前端**: Vue 3 + Naive UI + Amis
- **架构**: DDD + CQRS + 微服务
- **模板引擎**: Handlebars

## 🎯 开发需求分解

### 阶段一：核心功能实现 (优先级: 🔴 最高)

#### 需求1.1：代码生成模板系统完善
**需求编号**: REQ-001  
**优先级**: P0 (最高)  
**预计工时**: 3-4天  
**负责模块**: lowcode-platform-backend

**功能描述**:
完善代码生成模板系统，实现完整的NestJS应用代码生成能力。

**详细需求**:
1. **实现缺失的代码模板**
   - `entity-controller.hbs` - NestJS控制器模板
   - `entity-module.hbs` - NestJS模块模板
   - `prisma-schema.hbs` - Prisma数据库模式模板
   - `amis-page.hbs` - Amis前端页面模板

2. **模板变量系统增强**
   - 支持复杂数据类型映射
   - 支持关系字段处理
   - 支持验证规则生成
   - 支持Amis组件配置

3. **模板验证机制**
   - 模板语法验证
   - 变量完整性检查
   - 生成代码语法检查

**验收标准**:
- [ ] 所有模板文件创建完成
- [ ] 模板能正确处理实体元数据
- [ ] 生成的代码通过TypeScript编译
- [ ] 模板变量覆盖率100%

**技术实现要点**:
```typescript
// 模板文件位置
src/resources/templates/
├── entity-controller.hbs     # 新增
├── entity-module.hbs         # 新增  
├── prisma-schema.hbs         # 新增
├── amis-page.hbs            # 新增
├── entity-model.hbs         # 已存在
├── entity-dto.hbs           # 已存在
└── entity-base-service.hbs  # 已存在
```

#### 需求1.2：代码生成器核心逻辑实现
**需求编号**: REQ-002  
**优先级**: P0 (最高)  
**预计工时**: 4-5天  
**负责模块**: lowcode-platform-backend

**功能描述**:
实现代码生成器的核心逻辑，确保能够实际生成并写入代码文件到目标服务。

**详细需求**:
1. **完善AmisBackendManagerService**
   - 实现文件写入逻辑
   - 实现目录结构创建
   - 实现文件覆盖策略
   - 实现备份机制

2. **实现Base/Biz分层生成**
   - Base层代码自动生成（可覆盖）
   - Biz层代码智能生成（保护用户修改）
   - 继承关系正确建立

3. **实现Prisma Schema自动更新**
   - 根据实体定义生成Schema
   - 处理关系映射
   - 执行数据库迁移

4. **实现服务热重启机制**
   - 代码生成后自动重启amis-lowcode-backend
   - 模块热加载
   - 健康检查

**验收标准**:
- [ ] 代码文件能正确写入amis-lowcode-backend
- [ ] Base/Biz分层结构正确
- [ ] Prisma Schema自动更新
- [ ] 服务能自动重启并正常运行

**技术实现要点**:
```typescript
// 核心服务实现
export class AmisBackendManagerService {
  async writeGeneratedFiles(files: GeneratedFile[]): Promise<void>
  async generatePrismaSchema(metadata: ProjectMetadata): Promise<void>
  async updateAppModule(entities: Entity[]): Promise<void>
  async restartAmisBackend(): Promise<void>
}
```

#### 需求1.3：Amis兼容API格式实现
**需求编号**: REQ-003  
**优先级**: P0 (最高)  
**预计工时**: 2-3天  
**负责模块**: amis-lowcode-backend

**功能描述**:
实现Amis框架兼容的API响应格式，确保生成的API能够与Amis前端组件正常交互。

**详细需求**:
1. **统一响应格式处理**
   - 实现AmisResponseInterceptor
   - 标准化成功响应格式
   - 标准化错误响应格式

2. **分页数据格式适配**
   - 实现Amis分页格式
   - 支持排序参数处理
   - 支持筛选参数处理

3. **CRUD操作标准化**
   - 列表查询接口
   - 详情查询接口
   - 创建接口
   - 更新接口
   - 删除接口

**验收标准**:
- [ ] 所有API响应符合Amis格式规范
- [ ] 分页、排序、筛选功能正常
- [ ] 错误处理符合Amis要求
- [ ] 前端Amis组件能正常调用API

**技术实现要点**:
```typescript
// Amis响应格式
interface AmisResponse<T> {
  status: 0 | 1;           // 0: 成功, 1: 失败
  msg: string;             // 消息
  data: T;                 // 数据
  count?: number;          // 总数 (分页时)
}

// 响应拦截器
@Injectable()
export class AmisResponseInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any>
}
```

### 阶段二：系统集成优化 (优先级: 🟡 中等)

#### 需求2.1：服务间通信优化
**需求编号**: REQ-004  
**优先级**: P1 (高)  
**预计工时**: 3-4天  
**负责模块**: 全栈

**功能描述**:
优化三个微服务之间的通信机制，提高系统稳定性和性能。

**详细需求**:
1. **实现统一错误处理**
   - 跨服务错误传播
   - 统一错误码定义
   - 错误日志聚合

2. **实现服务健康检查**
   - 各服务健康状态监控
   - 依赖服务检查
   - 自动故障恢复

3. **实现请求链路追踪**
   - 请求ID传递
   - 调用链监控
   - 性能指标收集

**验收标准**:
- [ ] 服务间通信稳定可靠
- [ ] 错误处理完善
- [ ] 监控指标完整

#### 需求2.2：数据同步机制实现
**需求编号**: REQ-005  
**优先级**: P1 (高)  
**预计工时**: 2-3天  
**负责模块**: lowcode-platform-backend + amis-lowcode-backend

**功能描述**:
实现lowcode-platform-backend和amis-lowcode-backend之间的数据同步机制。

**详细需求**:
1. **实现元数据同步**
   - 实体变更事件发布
   - 字段变更同步
   - 关系变更同步

2. **实现增量更新**
   - 变更检测机制
   - 增量代码生成
   - 数据库迁移自动化

**验收标准**:
- [ ] 元数据变更能自动同步
- [ ] 增量更新功能正常
- [ ] 数据一致性得到保证

### 阶段三：功能增强 (优先级: 🟢 低)

#### 需求3.1：可视化设计器实现
**需求编号**: REQ-006  
**优先级**: P2 (中)  
**预计工时**: 5-7天  
**负责模块**: frontend

**功能描述**:
实现拖拽式可视化实体设计器，提升用户体验。

**详细需求**:
1. **实体图形化设计**
   - 拖拽式实体创建
   - 可视化字段编辑
   - 实体关系连线

2. **实时预览功能**
   - 代码实时预览
   - 数据库结构预览
   - API接口预览

**验收标准**:
- [ ] 可视化设计器功能完整
- [ ] 用户体验良好
- [ ] 实时预览准确

#### 需求3.2：代码编辑器集成
**需求编号**: REQ-007  
**优先级**: P2 (中)  
**预计工时**: 3-4天  
**负责模块**: frontend

**功能描述**:
集成在线代码编辑器，支持模板和生成代码的在线编辑。

**详细需求**:
1. **Monaco Editor集成**
   - TypeScript语法支持
   - 代码提示功能
   - 错误检查

2. **代码格式化**
   - Prettier集成
   - ESLint检查
   - 自动修复建议

**验收标准**:
- [ ] 代码编辑器功能完整
- [ ] 语法支持准确
- [ ] 格式化功能正常

## 🧪 测试需求

### 单元测试需求
**需求编号**: TEST-001  
**覆盖率要求**: ≥80%  
**负责模块**: 全栈

**测试范围**:
- 代码生成器核心逻辑
- 模板引擎功能
- API接口逻辑
- 工具函数

### 集成测试需求
**需求编号**: TEST-002  
**覆盖率要求**: ≥70%  
**负责模块**: 全栈

**测试范围**:
- 服务间通信
- 数据库操作
- 代码生成流程
- API接口调用

### E2E测试需求
**需求编号**: TEST-003  
**覆盖率要求**: 核心流程100%  
**负责模块**: 全栈

**测试范围**:
- 完整代码生成流程
- 用户界面交互
- 跨浏览器兼容性

## 📊 性能需求

### 响应时间要求
- API响应时间: P95 < 500ms
- 代码生成时间: < 30秒
- 页面加载时间: < 3秒

### 吞吐量要求
- API QPS: > 500
- 并发用户数: > 100
- 数据库连接数: < 50

### 资源使用要求
- 内存使用: < 2GB
- CPU使用率: < 80%
- 磁盘IO: < 100MB/s

## 🔒 安全需求

### 认证授权
- JWT token验证
- 权限控制
- 会话管理

### 数据安全
- SQL注入防护
- XSS防护
- 数据加密

### API安全
- 请求限流
- 参数验证
- 错误信息脱敏

## 📅 开发计划

### 第一周 (REQ-001, REQ-002)
- 完善代码生成模板系统
- 实现代码生成器核心逻辑

### 第二周 (REQ-003, TEST-001)
- 实现Amis兼容API格式
- 完成单元测试

### 第三周 (REQ-004, REQ-005)
- 优化服务间通信
- 实现数据同步机制

### 第四周 (TEST-002, TEST-003)
- 完成集成测试
- 完成E2E测试

### 第五-六周 (REQ-006, REQ-007)
- 实现可视化设计器
- 集成代码编辑器

## 🎯 验收标准

### 功能验收
- [ ] 所有P0需求100%完成
- [ ] 所有P1需求100%完成
- [ ] 核心业务流程端到端可用

### 质量验收
- [ ] 单元测试覆盖率≥80%
- [ ] 集成测试覆盖率≥70%
- [ ] 性能指标达到要求

### 文档验收
- [ ] API文档完整
- [ ] 用户手册完整
- [ ] 部署文档完整

## 📞 联系方式

**项目负责人**: [待定]  
**技术负责人**: [待定]  
**测试负责人**: [待定]  

---

*本文档版本: v1.0*  
*最后更新: 2025-07-21*
