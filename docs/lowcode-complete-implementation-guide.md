# ä½ä»£ç å¹³å°å®Œæ•´å®æ–½æŒ‡å—

## ğŸ¯ é¡¹ç›®æ¶æ„æ€»è§ˆ

### æœåŠ¡æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Soybean Admin NestJS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  frontend/          â”‚  backend/           â”‚  lowcode-platform-  â”‚
â”‚  (ç«¯å£: 9527)       â”‚  (ç«¯å£: 9527)       â”‚  backend/           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  (ç«¯å£: 3000)       â”‚
â”‚  â”‚ Vue 3 + Naive  â”‚â”‚  â”‚ NestJS + Fastifyâ”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ UI + Amis      â”‚â”‚  â”‚ + PostgreSQL    â”‚â”‚  â”‚ NestJS + Fastifyâ”‚â”‚
â”‚  â”‚                â”‚â”‚  â”‚                 â”‚â”‚  â”‚ + PostgreSQL    â”‚â”‚
â”‚  â”‚ - ç³»ç»Ÿç®¡ç†ç•Œé¢  â”‚â”‚  â”‚ - ç”¨æˆ·è®¤è¯      â”‚â”‚  â”‚ - é¡¹ç›®ç®¡ç†      â”‚â”‚
â”‚  â”‚ - ä½ä»£ç ç®¡ç†    â”‚â”‚  â”‚ - æƒé™æ§åˆ¶      â”‚â”‚  â”‚ - å®ä½“ç®¡ç†      â”‚â”‚
â”‚  â”‚ - ä»£ç ç”Ÿæˆç•Œé¢  â”‚â”‚  â”‚ - ç³»ç»Ÿé…ç½®      â”‚â”‚  â”‚ - æ¨¡æ¿ç®¡ç†      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚ - ä»£ç ç”Ÿæˆå™¨    â”‚â”‚
â”‚                     â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    amis-lowcode-backend/                        â”‚
â”‚                        (ç«¯å£: 9521)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              NestJS + Fastify + PostgreSQL                 â”‚â”‚
â”‚  â”‚                                                            â”‚â”‚
â”‚  â”‚  src/base/     â”‚  src/biz/      â”‚  src/shared/            â”‚â”‚
â”‚  â”‚  (ç”Ÿæˆçš„ä»£ç )   â”‚  (è‡ªå®šä¹‰ä»£ç )   â”‚  (å…±äº«æ¨¡å—)             â”‚â”‚
â”‚  â”‚  - controllers â”‚  - controllers â”‚  - guards               â”‚â”‚
â”‚  â”‚  - services    â”‚  - services    â”‚  - interceptors         â”‚â”‚
â”‚  â”‚  - dto         â”‚  - modules     â”‚  - decorators           â”‚â”‚
â”‚  â”‚  - entities    â”‚                â”‚  - services             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç•Œé¢   â”‚â”€â”€â”€â–¶â”‚ lowcode-platform â”‚â”€â”€â”€â–¶â”‚  amis-lowcode-     â”‚
â”‚  ä»£ç ç”Ÿæˆ    â”‚    â”‚    -backend      â”‚    â”‚     backend        â”‚
â”‚             â”‚    â”‚   (ä»£ç ç”Ÿæˆå™¨)    â”‚    â”‚   (ç”Ÿæˆçš„API)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                        â”‚
       â”‚                     â–¼                        â”‚
       â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚            â”‚   æ¨¡æ¿å¼•æ“      â”‚               â”‚
       â”‚            â”‚   å…ƒæ•°æ®èšåˆ    â”‚               â”‚
       â”‚            â”‚   æ–‡ä»¶ç”Ÿæˆ      â”‚               â”‚
       â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                     â”‚                        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Amiså‰ç«¯      â”‚
                    â”‚   æ•°æ®å±•ç¤º      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å®Œæ•´å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºAmisä½ä»£ç ä¸šåŠ¡åç«¯

#### 1.1 è¿è¡Œåˆ›å»ºè„šæœ¬
```bash
cd soybean-admin-nestjs
chmod +x scripts/create-amis-backend.sh
./scripts/create-amis-backend.sh
```

#### 1.2 é…ç½®ç¯å¢ƒ
```bash
cd amis-lowcode-backend
cp .env.example .env

# ç¼–è¾‘.envæ–‡ä»¶
vim .env
```

é…ç½®å†…å®¹ï¼š
```bash
# æ•°æ®åº“é…ç½® (ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“)
DATABASE_URL="postgresql://postgres:password@localhost:5432/amis_lowcode_db"

# åº”ç”¨é…ç½®
PORT=9521
NODE_ENV=development

# JWTé…ç½®
JWT_SECRET="amis-lowcode-jwt-secret-change-in-production"
JWT_EXPIRES_IN="7d"
```

#### 1.3 åˆå§‹åŒ–æ•°æ®åº“
```bash
# ç”ŸæˆPrismaå®¢æˆ·ç«¯
npm run prisma:generate

# åˆ›å»ºæ•°æ®åº“ (å¦‚æœä¸å­˜åœ¨)
createdb amis_lowcode_db

# å¯åŠ¨æœåŠ¡éªŒè¯
npm run start:dev
```

éªŒè¯è®¿é—®ï¼š
- http://localhost:9521/api/v1 - åº”ç”¨ä¿¡æ¯
- http://localhost:9521/api/v1/docs - APIæ–‡æ¡£
- http://localhost:9521/api/v1/health - å¥åº·æ£€æŸ¥

### ç¬¬äºŒæ­¥ï¼šåœ¨lowcode-platform-backendä¸­å®ç°ä»£ç ç”Ÿæˆå™¨

#### 2.1 åˆ›å»ºä»£ç ç”Ÿæˆæ§åˆ¶å™¨
```bash
cd ../lowcode-platform-backend/src/api/lowcode
```

åˆ›å»º `code-generation.controller.ts`ï¼š
```typescript
import { Controller, Post, Get, Body, Param, Query } from '@nestjs/common';
import { CommandBus, QueryBus } from '@nestjs/cqrs';
import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
import { GenerateCodeCommand, GetGenerationProgressQuery } from './commands-queries';
import { GenerateCodeDto } from './dto/code-generation.dto';

@Controller({ path: 'code-generation', version: '1' })
@ApiTags('code-generation')
export class CodeGenerationController {
  constructor(
    private readonly commandBus: CommandBus,
    private readonly queryBus: QueryBus,
  ) {}

  @Post('generate')
  @ApiOperation({ summary: 'Generate code from templates' })
  async generateCode(@Body() generateCodeDto: GenerateCodeDto) {
    const command = new GenerateCodeCommand(
      generateCodeDto.projectId,
      generateCodeDto.templateIds,
      generateCodeDto.entityIds,
      '../amis-lowcode-backend/src', // ç”Ÿæˆç›®æ ‡è·¯å¾„
      generateCodeDto.variables,
      generateCodeDto.options,
    );

    const result = await this.commandBus.execute(command);
    return {
      status: 0,
      msg: 'success',
      data: result,
    };
  }

  @Get('progress/:taskId')
  @ApiOperation({ summary: 'Get generation progress' })
  async getProgress(@Param('taskId') taskId: string) {
    const query = new GetGenerationProgressQuery(taskId);
    const progress = await this.queryBus.execute(query);
    return {
      status: 0,
      msg: 'success',
      data: progress,
    };
  }
}
```

#### 2.2 åˆ›å»ºä»£ç ç”ŸæˆDTO
åˆ›å»º `dto/code-generation.dto.ts`ï¼š
```typescript
import { ApiProperty } from '@nestjs/swagger';
import { IsString, IsArray, IsObject, IsOptional, IsEnum } from 'class-validator';

export enum GenerationArchitecture {
  BASE_BIZ = 'base-biz',
  STANDARD = 'standard',
}

export enum GenerationFramework {
  NESTJS = 'nestjs',
  EXPRESS = 'express',
}

export class GenerationOptionsDto {
  @ApiProperty({ description: 'Overwrite existing files' })
  overwriteExisting: boolean;

  @ApiProperty({ description: 'Generate test files' })
  generateTests: boolean;

  @ApiProperty({ description: 'Generate documentation' })
  generateDocs: boolean;

  @ApiProperty({ description: 'Architecture pattern', enum: GenerationArchitecture })
  @IsEnum(GenerationArchitecture)
  architecture: GenerationArchitecture;

  @ApiProperty({ description: 'Target framework', enum: GenerationFramework })
  @IsEnum(GenerationFramework)
  framework: GenerationFramework;
}

export class GenerateCodeDto {
  @ApiProperty({ description: 'Project ID' })
  @IsString()
  projectId: string;

  @ApiProperty({ description: 'Template IDs' })
  @IsArray()
  @IsString({ each: true })
  templateIds: string[];

  @ApiPropertyOptional({ description: 'Entity IDs to generate for' })
  @IsOptional()
  @IsArray()
  @IsString({ each: true })
  entityIds?: string[];

  @ApiProperty({ description: 'Template variables' })
  @IsObject()
  variables: Record<string, any>;

  @ApiProperty({ description: 'Generation options', type: GenerationOptionsDto })
  @IsObject()
  options: GenerationOptionsDto;
}
```

#### 2.3 å®ç°ä»£ç ç”Ÿæˆå‘½ä»¤å¤„ç†å™¨
åˆ›å»º `lib/bounded-contexts/code-generation/application/handlers/generate-code.handler.ts`ï¼š
```typescript
import { CommandHandler, ICommandHandler } from '@nestjs/cqrs';
import { Injectable, Logger } from '@nestjs/common';
import { GenerateCodeCommand } from '../commands/generate-code.command';
import { IntelligentCodeGeneratorService } from '../services/intelligent-code-generator.service';
import { AmisBackendManagerService } from '../services/amis-backend-manager.service';
import { MetadataAggregatorService } from '@lib/bounded-contexts/metadata/application/services/metadata-aggregator.service';

@Injectable()
@CommandHandler(GenerateCodeCommand)
export class GenerateCodeHandler implements ICommandHandler<GenerateCodeCommand> {
  private readonly logger = new Logger(GenerateCodeHandler.name);

  constructor(
    private readonly codeGenerator: IntelligentCodeGeneratorService,
    private readonly amisBackendManager: AmisBackendManagerService,
    private readonly metadataService: MetadataAggregatorService,
  ) {}

  async execute(command: GenerateCodeCommand): Promise<any> {
    const startTime = Date.now();
    const taskId = this.generateTaskId();

    try {
      this.logger.log(`Starting code generation for project: ${command.projectId}`);

      // 1. è·å–é¡¹ç›®å…ƒæ•°æ®
      const metadata = await this.metadataService.getProjectMetadata(command.projectId);
      this.logger.log(`Retrieved metadata for ${metadata.entities.length} entities`);

      // 2. ç”Ÿæˆä»£ç æ–‡ä»¶
      const generatedFiles = await this.codeGenerator.generateFiles({
        projectId: command.projectId,
        templateIds: command.templateIds,
        entityIds: command.entityIds,
        outputPath: command.outputPath,
        variables: command.variables,
        options: command.options,
      });

      this.logger.log(`Generated ${generatedFiles.length} files`);

      // 3. å†™å…¥amis-lowcode-backend
      await this.amisBackendManager.writeGeneratedFiles(generatedFiles);

      // 4. æ›´æ–°Prisma schema
      await this.amisBackendManager.generatePrismaSchema(metadata);

      // 5. æ›´æ–°app.module.ts
      await this.amisBackendManager.updateAppModule(metadata.entities);

      // 6. é‡å¯amis-lowcode-backendæœåŠ¡
      await this.amisBackendManager.restartAmisBackend();

      const duration = Date.now() - startTime;
      this.logger.log(`Code generation completed in ${duration}ms`);

      return {
        success: true,
        taskId,
        filesGenerated: generatedFiles.length,
        outputPath: command.outputPath,
        errors: [],
        warnings: [],
        metadata: {
          projectId: command.projectId,
          templatesUsed: command.templateIds,
          entitiesProcessed: command.entityIds || [],
          generatedAt: new Date(),
          duration,
        },
      };

    } catch (error) {
      this.logger.error(`Code generation failed: ${error.message}`, error.stack);
      
      return {
        success: false,
        taskId,
        filesGenerated: 0,
        outputPath: command.outputPath,
        errors: [error.message],
        warnings: [],
        metadata: {
          projectId: command.projectId,
          templatesUsed: command.templateIds,
          entitiesProcessed: command.entityIds || [],
          generatedAt: new Date(),
          duration: Date.now() - startTime,
        },
      };
    }
  }

  private generateTaskId(): string {
    return `gen_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }
}
```

#### 2.4 å®ç°Amisåç«¯ç®¡ç†æœåŠ¡
åˆ›å»º `lib/bounded-contexts/code-generation/application/services/amis-backend-manager.service.ts`ï¼š
```typescript
import { Injectable, Logger } from '@nestjs/common';
import { exec } from 'child_process';
import { promisify } from 'util';
import * as fs from 'fs-extra';
import * as path from 'path';
import { ProjectMetadata, EntityMetadata } from '@lib/bounded-contexts/metadata/domain/metadata.model';
import { GeneratedFile } from '../domain/generation-result.model';

const execAsync = promisify(exec);

@Injectable()
export class AmisBackendManagerService {
  private readonly amisBackendPath = path.resolve(__dirname, '../../../../../../amis-lowcode-backend');
  private readonly logger = new Logger(AmisBackendManagerService.name);

  async writeGeneratedFiles(files: GeneratedFile[]): Promise<void> {
    this.logger.log(`Writing ${files.length} generated files to amis-lowcode-backend`);

    for (const file of files) {
      const fullPath = path.join(this.amisBackendPath, file.path);
      await fs.ensureDir(path.dirname(fullPath));
      await fs.writeFile(fullPath, file.content);
      this.logger.debug(`Generated file: ${file.path}`);
    }

    this.logger.log('All files written successfully');
  }

  async updateAppModule(entities: EntityMetadata[]): Promise<void> {
    const appModulePath = path.join(this.amisBackendPath, 'src/app.module.ts');
    
    const moduleImports = entities.map(entity => 
      `import { ${entity.name}Module } from '@modules/${entity.code}.module';`
    ).join('\n');

    const moduleList = entities.map(entity => `${entity.name}Module`).join(',\n    ');

    const appModuleContent = `import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { PrismaService } from '@shared/services/prisma.service';
${moduleImports}

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath: ['.env.local', '.env'],
    }),
    ${moduleList}
  ],
  controllers: [AppController],
  providers: [AppService, PrismaService],
})
export class AppModule {
  // This module is dynamically updated by the code generator
}`;

    await fs.writeFile(appModulePath, appModuleContent);
    this.logger.log('Updated app.module.ts with generated modules');
  }

  async generatePrismaSchema(metadata: ProjectMetadata): Promise<void> {
    const schemaPath = path.join(this.amisBackendPath, 'prisma/schema.prisma');
    const schemaContent = this.buildPrismaSchema(metadata);
    
    await fs.writeFile(schemaPath, schemaContent);
    this.logger.log('Generated Prisma schema');
    
    try {
      // ç”ŸæˆPrismaå®¢æˆ·ç«¯
      const generateCommand = `cd ${this.amisBackendPath} && npx prisma generate`;
      await execAsync(generateCommand);
      this.logger.log('Generated Prisma client');
    } catch (error) {
      this.logger.error('Failed to generate Prisma client', error);
      throw error;
    }
  }

  async restartAmisBackend(): Promise<void> {
    try {
      this.logger.log('Restarting amis-lowcode-backend service...');
      
      // å‘é€é‡å¯ä¿¡å·
      const restartCommand = `cd ${this.amisBackendPath} && npm run restart:dev`;
      await execAsync(restartCommand);
      
      this.logger.log('Amis backend service restarted successfully');
    } catch (error) {
      this.logger.warn('Failed to restart amis backend service automatically', error.message);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºé‡å¯å¤±è´¥ä¸åº”è¯¥å½±å“ä»£ç ç”Ÿæˆçš„æˆåŠŸçŠ¶æ€
    }
  }

  private buildPrismaSchema(metadata: ProjectMetadata): string {
    let schema = `// Auto-generated Prisma schema for ${metadata.project.name}
// Generated at: ${new Date().toISOString()}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

`;

    // ç”Ÿæˆå®ä½“æ¨¡å‹
    for (const entity of metadata.entities) {
      schema += this.generatePrismaModel(entity);
      schema += '\n';
    }

    return schema;
  }

  private generatePrismaModel(entity: EntityMetadata): string {
    let model = `model ${entity.name} {\n`;
    
    // ç”Ÿæˆå­—æ®µ
    for (const field of entity.fields) {
      const fieldType = this.mapFieldTypeToPrisma(field);
      const attributes = this.buildFieldAttributes(field);
      model += `  ${field.code} ${fieldType}${attributes}\n`;
    }

    // ç”Ÿæˆå…³ç³»
    for (const relation of entity.relationships.outgoing) {
      const relationType = relation.relationType === 'oneToMany' ? '[]' : 
                          relation.relationType === 'manyToOne' ? '?' : '';
      model += `  ${relation.relationshipName} ${relation.targetEntityName}${relationType}\n`;
    }

    model += `\n  @@map("${entity.tableName}")\n`;
    model += '}';

    return model;
  }

  private mapFieldTypeToPrisma(field: any): string {
    const typeMap: Record<string, string> = {
      'string': 'String',
      'text': 'String',
      'integer': 'Int',
      'bigint': 'BigInt',
      'decimal': 'Decimal',
      'boolean': 'Boolean',
      'date': 'DateTime',
      'datetime': 'DateTime',
      'timestamp': 'DateTime',
      'json': 'Json',
      'uuid': 'String',
    };

    return typeMap[field.type] || 'String';
  }

  private buildFieldAttributes(field: any): string {
    let attributes = '';
    
    if (field.isPrimaryKey) {
      attributes += ' @id';
      if (field.type === 'string') {
        attributes += ' @default(cuid())';
      }
    }
    
    if (field.isUnique && !field.isPrimaryKey) {
      attributes += ' @unique';
    }
    
    if (!field.nullable && !field.isPrimaryKey) {
      // Prismaé»˜è®¤å­—æ®µä¸ºå¿…å¡«ï¼Œåªæœ‰å¯ç©ºå­—æ®µéœ€è¦æ ‡è®°
    } else if (field.nullable) {
      attributes += '?';
    }
    
    if (field.defaultValue && !field.isPrimaryKey) {
      if (field.type === 'datetime' && field.defaultValue === 'now()') {
        attributes += ' @default(now())';
      } else if (field.type === 'datetime' && field.code === 'updatedAt') {
        attributes += ' @updatedAt';
      } else {
        attributes += ` @default(${field.defaultValue})`;
      }
    }
    
    if (field.length && (field.type === 'string' || field.type === 'text')) {
      attributes += ` @db.VarChar(${field.length})`;
    }

    return attributes;
  }
}
```

### ç¬¬ä¸‰æ­¥ï¼šæ³¨å†Œä»£ç ç”Ÿæˆæ¨¡å—

#### 3.1 åœ¨lowcode-platform-backendä¸­æ³¨å†Œæ¨¡å—
ç¼–è¾‘ `src/app.module.ts`ï¼Œæ·»åŠ ä»£ç ç”Ÿæˆæ¨¡å—ï¼š
```typescript
import { CodeGenerationModule } from '@lib/bounded-contexts/code-generation/code-generation.module';

@Module({
  imports: [
    // ... å…¶ä»–æ¨¡å—
    CodeGenerationModule,
  ],
  // ...
})
export class AppModule {}
```

#### 3.2 åˆ›å»ºä»£ç ç”Ÿæˆæ¨¡å—
åˆ›å»º `lib/bounded-contexts/code-generation/code-generation.module.ts`ï¼š
```typescript
import { Module } from '@nestjs/common';
import { CqrsModule } from '@nestjs/cqrs';
import { CodeGenerationController } from '@api/lowcode/code-generation.controller';
import { GenerateCodeHandler } from './application/handlers/generate-code.handler';
import { IntelligentCodeGeneratorService } from './application/services/intelligent-code-generator.service';
import { AmisBackendManagerService } from './application/services/amis-backend-manager.service';
import { FileSystemManagerService } from './application/services/file-system-manager.service';
import { MetadataModule } from '../metadata/metadata.module';
import { TemplateModule } from '../template/template.module';

@Module({
  imports: [
    CqrsModule,
    MetadataModule,
    TemplateModule,
  ],
  controllers: [CodeGenerationController],
  providers: [
    GenerateCodeHandler,
    IntelligentCodeGeneratorService,
    AmisBackendManagerService,
    FileSystemManagerService,
  ],
  exports: [
    IntelligentCodeGeneratorService,
    AmisBackendManagerService,
  ],
})
export class CodeGenerationModule {}
```

### ç¬¬å››æ­¥ï¼šæµ‹è¯•å’ŒéªŒè¯

#### 4.1 å¯åŠ¨æ‰€æœ‰æœåŠ¡
```bash
# å¯åŠ¨ä¸»åç«¯æœåŠ¡
cd backend
npm run start:dev

# å¯åŠ¨ä½ä»£ç å¹³å°åç«¯
cd ../lowcode-platform-backend
npm run start:dev

# å¯åŠ¨amisä½ä»£ç ä¸šåŠ¡åç«¯
cd ../amis-lowcode-backend
npm run start:dev

# å¯åŠ¨å‰ç«¯
cd ../frontend
npm run dev
```

#### 4.2 éªŒè¯æœåŠ¡çŠ¶æ€
- ä¸»åç«¯: http://localhost:9527
- ä½ä»£ç å¹³å°åç«¯: http://localhost:9521
- Amisä¸šåŠ¡åç«¯: http://localhost:9521 (ä¸ä½ä»£ç å¹³å°å…±äº«ç«¯å£)
- å‰ç«¯: http://localhost:9527

#### 4.3 æµ‹è¯•ä»£ç ç”Ÿæˆ
1. è®¿é—®å‰ç«¯ä½ä»£ç ç®¡ç†ç•Œé¢
2. åˆ›å»ºé¡¹ç›®å’Œå®ä½“
3. åˆ›å»ºä»£ç æ¨¡æ¿
4. è¿›å…¥ä»£ç ç”Ÿæˆé¡µé¢
5. é€‰æ‹©é¡¹ç›®ã€æ¨¡æ¿ã€å®ä½“
6. ç‚¹å‡»ç”Ÿæˆä»£ç 
7. æŸ¥çœ‹ç”Ÿæˆç»“æœå’ŒAPIæ–‡æ¡£

## ğŸ¯ æˆåŠŸéªŒè¯æ ‡å‡†

### åŠŸèƒ½éªŒè¯
- [ ] amis-lowcode-backendæœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] ä»£ç ç”Ÿæˆå™¨APIæ­£å¸¸å“åº”
- [ ] ç”Ÿæˆçš„ä»£ç å†™å…¥æ­£ç¡®ç›®å½•
- [ ] Prisma schemaè‡ªåŠ¨æ›´æ–°
- [ ] ç”Ÿæˆçš„APIç¬¦åˆAmisæ ¼å¼è§„èŒƒ
- [ ] å‰ç«¯å¯ä»¥æ­£å¸¸è°ƒç”¨ç”Ÿæˆçš„API

### æ€§èƒ½éªŒè¯
- [ ] å•ä¸ªå®ä½“ç”Ÿæˆæ—¶é—´ < 5ç§’
- [ ] å®Œæ•´é¡¹ç›®ç”Ÿæˆæ—¶é—´ < 30ç§’
- [ ] ç”Ÿæˆçš„APIå“åº”æ—¶é—´ < 2ç§’
- [ ] æœåŠ¡é‡å¯æ—¶é—´ < 10ç§’

### è´¨é‡éªŒè¯
- [ ] ç”Ÿæˆçš„ä»£ç é€šè¿‡TypeScriptç¼–è¯‘
- [ ] ç”Ÿæˆçš„APIæ–‡æ¡£å®Œæ•´
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸
- [ ] æ—¥å¿—è®°å½•å®Œæ•´æ¸…æ™°

## ğŸš€ éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
- ä½¿ç”¨è„šæœ¬è‡ªåŠ¨åˆ›å»ºå’Œé…ç½®é¡¹ç›®
- é…ç½®çƒ­é‡è½½å’Œè‡ªåŠ¨é‡å¯
- å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•

### ç”Ÿäº§ç¯å¢ƒ
- ä½¿ç”¨Dockerå®¹å™¨åŒ–éƒ¨ç½²
- é…ç½®è´Ÿè½½å‡è¡¡å’Œå¥åº·æ£€æŸ¥
- å¯ç”¨ç›‘æ§å’Œå‘Šè­¦
- å®šæœŸå¤‡ä»½ç”Ÿæˆçš„ä»£ç 

è¿™ä¸ªå®Œæ•´çš„å®æ–½æŒ‡å—æä¾›äº†ä»é›¶å¼€å§‹åˆ›å»ºå’Œé…ç½®æ•´ä¸ªä½ä»£ç å¹³å°çš„è¯¦ç»†æ­¥éª¤ï¼Œç¡®ä¿ä»£ç ç”Ÿæˆå™¨èƒ½å¤Ÿæ­£ç¡®åœ°åœ¨lowcode-platform-backendä¸­å®ç°ï¼Œå¹¶å°†ç”Ÿæˆçš„ä»£ç å†™å…¥amis-lowcode-backendä¸­è¿è¡Œã€‚
