# 低代码平台API接口规范

## 📋 接口设计原则

### Amis兼容性规范
所有API接口必须符合Amis框架的响应格式要求，确保前端组件能够正常解析和使用数据。

#### 标准响应格式
```typescript
interface AmisResponse<T> {
  status: 0 | 1;           // 0: 成功, 1: 失败
  msg: string;             // 响应消息
  data: T;                 // 响应数据
  count?: number;          // 总数 (分页查询时必须)
}
```

#### 分页响应格式
```typescript
interface AmisPaginationResponse<T> {
  status: 0;
  msg: "success";
  data: {
    items: T[];            // 数据列表
    total: number;         // 总记录数
  };
  count: number;           // 总记录数 (与data.total相同)
}
```

## 🎯 代码生成相关API

### 1. 代码生成接口

#### POST /api/v1/code-generation/generate
**功能**: 执行代码生成任务

**请求参数**:
```typescript
interface GenerateCodeRequest {
  projectId: string;                    // 项目ID
  templateIds: string[];               // 模板ID列表
  entityIds: string[];                 // 实体ID列表
  outputPath?: string;                 // 输出路径 (可选)
  variables?: Record<string, any>;     // 模板变量 (可选)
  options: {
    overwriteExisting: boolean;        // 是否覆盖已存在文件
    generateTests: boolean;            // 是否生成测试文件
    generateDocs: boolean;             // 是否生成文档
    architecture: string;              // 架构类型: "base-biz" | "standard"
    framework: string;                 // 框架类型: "nestjs" | "express"
  };
}
```

**响应格式**:
```typescript
interface GenerateCodeResponse {
  status: 0;
  msg: "代码生成任务已启动";
  data: {
    taskId: string;                    // 任务ID
    filesGenerated: number;            // 生成文件数量
    outputPath: string;                // 输出路径
    errors: string[];                  // 错误信息列表
    warnings: string[];                // 警告信息列表
    fileTree: FileTreeNode[];          // 文件树结构
    metadata: {
      projectId: string;
      templatesUsed: string[];
      entitiesProcessed: string[];
      generatedAt: string;             // ISO日期字符串
      duration: number;                // 生成耗时(毫秒)
    };
  };
}
```

#### GET /api/v1/code-generation/progress/:taskId
**功能**: 获取代码生成进度

**响应格式**:
```typescript
interface GenerationProgressResponse {
  status: 0;
  msg: "success";
  data: {
    percentage: number;                // 进度百分比 (0-100)
    status: 'pending' | 'running' | 'success' | 'failed';
    message: string;                   // 当前状态描述
    logs: Array<{
      level: 'info' | 'warn' | 'error';
      message: string;
      timestamp: string;               // ISO日期字符串
    }>;
  };
}
```

### 2. 模板管理接口

#### GET /api/v1/templates
**功能**: 获取模板列表

**查询参数**:
```typescript
interface TemplateListQuery {
  current?: number;                    // 当前页码
  size?: number;                       // 每页大小
  category?: string;                   // 模板分类
  language?: string;                   // 编程语言
  framework?: string;                  // 框架类型
  search?: string;                     // 搜索关键词
}
```

**响应格式**:
```typescript
interface TemplateListResponse {
  status: 0;
  msg: "success";
  data: {
    items: Array<{
      id: string;
      name: string;
      code: string;
      category: string;
      language: string;
      framework: string;
      description: string;
      template: string;                // 模板内容
      variables: Array<{
        name: string;
        type: string;
        required: boolean;
        description: string;
        defaultValue?: any;
      }>;
      status: 'DRAFT' | 'PUBLISHED' | 'DEPRECATED';
      createdAt: string;
      updatedAt: string;
    }>;
    total: number;
  };
  count: number;
}
```

## 🏗️ 生成的业务API规范

### 1. 标准CRUD接口

#### GET /api/v1/{entity}
**功能**: 获取实体列表

**查询参数**:
```typescript
interface EntityListQuery {
  current?: number;                    // 当前页码，默认1
  size?: number;                       // 每页大小，默认10
  sort?: string;                       // 排序字段，格式: "field:asc|desc"
  search?: string;                     // 搜索关键词
  [key: string]: any;                  // 其他筛选条件
}
```

**响应格式**:
```typescript
interface EntityListResponse<T> {
  status: 0;
  msg: "success";
  data: {
    items: T[];                        // 实体数据列表
    total: number;                     // 总记录数
  };
  count: number;                       // 总记录数
}
```

#### GET /api/v1/{entity}/:id
**功能**: 获取实体详情

**响应格式**:
```typescript
interface EntityDetailResponse<T> {
  status: 0;
  msg: "success";
  data: T;                             // 实体详情数据
}
```

#### POST /api/v1/{entity}
**功能**: 创建实体

**请求体**: 根据实体定义的字段结构

**响应格式**:
```typescript
interface EntityCreateResponse<T> {
  status: 0;
  msg: "创建成功";
  data: T;                             // 创建后的实体数据
}
```

#### PUT /api/v1/{entity}/:id
**功能**: 更新实体

**请求体**: 根据实体定义的字段结构（部分字段）

**响应格式**:
```typescript
interface EntityUpdateResponse<T> {
  status: 0;
  msg: "更新成功";
  data: T;                             // 更新后的实体数据
}
```

#### DELETE /api/v1/{entity}/:id
**功能**: 删除实体

**响应格式**:
```typescript
interface EntityDeleteResponse {
  status: 0;
  msg: "删除成功";
  data: {
    id: string;                        // 被删除的实体ID
    deletedAt: string;                 // 删除时间
  };
}
```

### 2. 批量操作接口

#### POST /api/v1/{entity}/batch
**功能**: 批量创建实体

**请求体**:
```typescript
interface BatchCreateRequest<T> {
  items: T[];                          // 要创建的实体数据列表
  options?: {
    skipErrors: boolean;               // 是否跳过错误继续处理
    validateOnly: boolean;             // 是否只验证不实际创建
  };
}
```

**响应格式**:
```typescript
interface BatchCreateResponse<T> {
  status: 0;
  msg: "批量创建完成";
  data: {
    success: T[];                      // 成功创建的实体
    failed: Array<{
      item: T;                         // 失败的实体数据
      error: string;                   // 错误信息
    }>;
    total: number;                     // 总数
    successCount: number;              // 成功数量
    failedCount: number;               // 失败数量
  };
}
```

#### DELETE /api/v1/{entity}/batch
**功能**: 批量删除实体

**请求体**:
```typescript
interface BatchDeleteRequest {
  ids: string[];                       // 要删除的实体ID列表
}
```

**响应格式**:
```typescript
interface BatchDeleteResponse {
  status: 0;
  msg: "批量删除完成";
  data: {
    deletedIds: string[];              // 成功删除的ID列表
    failedIds: Array<{
      id: string;
      error: string;
    }>;
    deletedCount: number;              // 删除数量
    failedCount: number;               // 失败数量
  };
}
```

### 3. 关联查询接口

#### GET /api/v1/{entity}/:id/{relation}
**功能**: 获取实体的关联数据

**查询参数**: 与列表查询相同

**响应格式**:
```typescript
interface RelationListResponse<T> {
  status: 0;
  msg: "success";
  data: {
    items: T[];                        // 关联实体数据列表
    total: number;                     // 总记录数
    relation: {
      type: 'ONE_TO_MANY' | 'MANY_TO_ONE' | 'MANY_TO_MANY';
      sourceEntity: string;
      targetEntity: string;
      sourceField: string;
      targetField: string;
    };
  };
  count: number;
}
```

## 🔒 错误处理规范

### 错误响应格式
```typescript
interface ErrorResponse {
  status: 1;                           // 错误状态
  msg: string;                         // 错误消息
  data: null;                          // 错误时数据为null
  error?: {
    code: string;                      // 错误代码
    details: string;                   // 详细错误信息
    field?: string;                    // 相关字段 (验证错误时)
    timestamp: string;                 // 错误发生时间
  };
}
```

### 常见错误代码
```typescript
enum ErrorCodes {
  // 通用错误
  INTERNAL_ERROR = 'INTERNAL_ERROR',
  INVALID_REQUEST = 'INVALID_REQUEST',
  UNAUTHORIZED = 'UNAUTHORIZED',
  FORBIDDEN = 'FORBIDDEN',
  NOT_FOUND = 'NOT_FOUND',
  
  // 业务错误
  ENTITY_NOT_FOUND = 'ENTITY_NOT_FOUND',
  DUPLICATE_ENTITY = 'DUPLICATE_ENTITY',
  VALIDATION_FAILED = 'VALIDATION_FAILED',
  RELATION_CONSTRAINT = 'RELATION_CONSTRAINT',
  
  // 代码生成错误
  TEMPLATE_NOT_FOUND = 'TEMPLATE_NOT_FOUND',
  GENERATION_FAILED = 'GENERATION_FAILED',
  FILE_WRITE_ERROR = 'FILE_WRITE_ERROR',
  SERVICE_RESTART_FAILED = 'SERVICE_RESTART_FAILED'
}
```

## 📊 性能要求

### 响应时间要求
- 列表查询: < 200ms (P95)
- 详情查询: < 100ms (P95)
- 创建操作: < 300ms (P95)
- 更新操作: < 300ms (P95)
- 删除操作: < 200ms (P95)
- 代码生成: < 30s

### 分页限制
- 默认每页大小: 10
- 最大每页大小: 100
- 最大查询记录数: 10000

### 并发限制
- 单用户QPS限制: 100
- 全局QPS限制: 1000
- 代码生成并发限制: 5

## 🔐 安全规范

### 认证要求
- 所有API接口都需要JWT认证
- Token有效期: 24小时
- 支持Token刷新机制

### 权限控制
- 基于角色的访问控制(RBAC)
- 支持资源级权限控制
- 支持字段级权限控制

### 数据验证
- 所有输入参数必须验证
- 使用DTO进行数据传输
- 支持自定义验证规则

### 安全头设置
```typescript
// 必须设置的安全头
{
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
  'Content-Security-Policy': "default-src 'self'"
}
```

## 📝 接口文档生成

### Swagger配置
```typescript
// 自动生成API文档
@ApiTags('实体管理')
@Controller('entities')
export class EntityController {
  @Get()
  @ApiOperation({ summary: '获取实体列表' })
  @ApiResponse({ status: 200, description: '成功', type: EntityListResponse })
  @ApiResponse({ status: 400, description: '请求参数错误' })
  @ApiResponse({ status: 401, description: '未授权' })
  async findAll(@Query() query: EntityListQuery) {
    // 实现逻辑
  }
}
```

### 接口测试
- 提供Postman集合文件
- 提供接口测试用例
- 支持自动化接口测试

---

*本文档版本: v1.0*  
*最后更新: 2025-07-21*
