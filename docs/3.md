# ä½ä»£ç å¹³å°APIæ¥å£è§„èŒƒ

## ğŸ“‹ æ¥å£è®¾è®¡åŸåˆ™

### Amiså…¼å®¹æ€§è§„èŒƒ
æ‰€æœ‰APIæ¥å£å¿…é¡»ç¬¦åˆAmisæ¡†æ¶çš„å“åº”æ ¼å¼è¦æ±‚ï¼Œç¡®ä¿å‰ç«¯ç»„ä»¶èƒ½å¤Ÿæ­£å¸¸è§£æå’Œä½¿ç”¨æ•°æ®ã€‚

#### æ ‡å‡†å“åº”æ ¼å¼
```typescript
interface AmisResponse<T> {
  status: 0 | 1;           // 0: æˆåŠŸ, 1: å¤±è´¥
  msg: string;             // å“åº”æ¶ˆæ¯
  data: T;                 // å“åº”æ•°æ®
  count?: number;          // æ€»æ•° (åˆ†é¡µæŸ¥è¯¢æ—¶å¿…é¡»)
}
```

#### åˆ†é¡µå“åº”æ ¼å¼
```typescript
interface AmisPaginationResponse<T> {
  status: 0;
  msg: "success";
  data: {
    items: T[];            // æ•°æ®åˆ—è¡¨
    total: number;         // æ€»è®°å½•æ•°
  };
  count: number;           // æ€»è®°å½•æ•° (ä¸data.totalç›¸åŒ)
}
```

## ğŸ¯ ä»£ç ç”Ÿæˆç›¸å…³API

### 1. ä»£ç ç”Ÿæˆæ¥å£

#### POST /api/v1/code-generation/generate
**åŠŸèƒ½**: æ‰§è¡Œä»£ç ç”Ÿæˆä»»åŠ¡

**è¯·æ±‚å‚æ•°**:
```typescript
interface GenerateCodeRequest {
  projectId: string;                    // é¡¹ç›®ID
  templateIds: string[];               // æ¨¡æ¿IDåˆ—è¡¨
  entityIds: string[];                 // å®ä½“IDåˆ—è¡¨
  outputPath?: string;                 // è¾“å‡ºè·¯å¾„ (å¯é€‰)
  variables?: Record<string, any>;     // æ¨¡æ¿å˜é‡ (å¯é€‰)
  options: {
    overwriteExisting: boolean;        // æ˜¯å¦è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶
    generateTests: boolean;            // æ˜¯å¦ç”Ÿæˆæµ‹è¯•æ–‡ä»¶
    generateDocs: boolean;             // æ˜¯å¦ç”Ÿæˆæ–‡æ¡£
    architecture: string;              // æ¶æ„ç±»å‹: "base-biz" | "standard"
    framework: string;                 // æ¡†æ¶ç±»å‹: "nestjs" | "express"
  };
}
```

**å“åº”æ ¼å¼**:
```typescript
interface GenerateCodeResponse {
  status: 0;
  msg: "ä»£ç ç”Ÿæˆä»»åŠ¡å·²å¯åŠ¨";
  data: {
    taskId: string;                    // ä»»åŠ¡ID
    filesGenerated: number;            // ç”Ÿæˆæ–‡ä»¶æ•°é‡
    outputPath: string;                // è¾“å‡ºè·¯å¾„
    errors: string[];                  // é”™è¯¯ä¿¡æ¯åˆ—è¡¨
    warnings: string[];                // è­¦å‘Šä¿¡æ¯åˆ—è¡¨
    fileTree: FileTreeNode[];          // æ–‡ä»¶æ ‘ç»“æ„
    metadata: {
      projectId: string;
      templatesUsed: string[];
      entitiesProcessed: string[];
      generatedAt: string;             // ISOæ—¥æœŸå­—ç¬¦ä¸²
      duration: number;                // ç”Ÿæˆè€—æ—¶(æ¯«ç§’)
    };
  };
}
```

#### GET /api/v1/code-generation/progress/:taskId
**åŠŸèƒ½**: è·å–ä»£ç ç”Ÿæˆè¿›åº¦

**å“åº”æ ¼å¼**:
```typescript
interface GenerationProgressResponse {
  status: 0;
  msg: "success";
  data: {
    percentage: number;                // è¿›åº¦ç™¾åˆ†æ¯” (0-100)
    status: 'pending' | 'running' | 'success' | 'failed';
    message: string;                   // å½“å‰çŠ¶æ€æè¿°
    logs: Array<{
      level: 'info' | 'warn' | 'error';
      message: string;
      timestamp: string;               // ISOæ—¥æœŸå­—ç¬¦ä¸²
    }>;
  };
}
```

### 2. æ¨¡æ¿ç®¡ç†æ¥å£

#### GET /api/v1/templates
**åŠŸèƒ½**: è·å–æ¨¡æ¿åˆ—è¡¨

**æŸ¥è¯¢å‚æ•°**:
```typescript
interface TemplateListQuery {
  current?: number;                    // å½“å‰é¡µç 
  size?: number;                       // æ¯é¡µå¤§å°
  category?: string;                   // æ¨¡æ¿åˆ†ç±»
  language?: string;                   // ç¼–ç¨‹è¯­è¨€
  framework?: string;                  // æ¡†æ¶ç±»å‹
  search?: string;                     // æœç´¢å…³é”®è¯
}
```

**å“åº”æ ¼å¼**:
```typescript
interface TemplateListResponse {
  status: 0;
  msg: "success";
  data: {
    items: Array<{
      id: string;
      name: string;
      code: string;
      category: string;
      language: string;
      framework: string;
      description: string;
      template: string;                // æ¨¡æ¿å†…å®¹
      variables: Array<{
        name: string;
        type: string;
        required: boolean;
        description: string;
        defaultValue?: any;
      }>;
      status: 'DRAFT' | 'PUBLISHED' | 'DEPRECATED';
      createdAt: string;
      updatedAt: string;
    }>;
    total: number;
  };
  count: number;
}
```

## ğŸ—ï¸ ç”Ÿæˆçš„ä¸šåŠ¡APIè§„èŒƒ

### 1. æ ‡å‡†CRUDæ¥å£

#### GET /api/v1/{entity}
**åŠŸèƒ½**: è·å–å®ä½“åˆ—è¡¨

**æŸ¥è¯¢å‚æ•°**:
```typescript
interface EntityListQuery {
  current?: number;                    // å½“å‰é¡µç ï¼Œé»˜è®¤1
  size?: number;                       // æ¯é¡µå¤§å°ï¼Œé»˜è®¤10
  sort?: string;                       // æ’åºå­—æ®µï¼Œæ ¼å¼: "field:asc|desc"
  search?: string;                     // æœç´¢å…³é”®è¯
  [key: string]: any;                  // å…¶ä»–ç­›é€‰æ¡ä»¶
}
```

**å“åº”æ ¼å¼**:
```typescript
interface EntityListResponse<T> {
  status: 0;
  msg: "success";
  data: {
    items: T[];                        // å®ä½“æ•°æ®åˆ—è¡¨
    total: number;                     // æ€»è®°å½•æ•°
  };
  count: number;                       // æ€»è®°å½•æ•°
}
```

#### GET /api/v1/{entity}/:id
**åŠŸèƒ½**: è·å–å®ä½“è¯¦æƒ…

**å“åº”æ ¼å¼**:
```typescript
interface EntityDetailResponse<T> {
  status: 0;
  msg: "success";
  data: T;                             // å®ä½“è¯¦æƒ…æ•°æ®
}
```

#### POST /api/v1/{entity}
**åŠŸèƒ½**: åˆ›å»ºå®ä½“

**è¯·æ±‚ä½“**: æ ¹æ®å®ä½“å®šä¹‰çš„å­—æ®µç»“æ„

**å“åº”æ ¼å¼**:
```typescript
interface EntityCreateResponse<T> {
  status: 0;
  msg: "åˆ›å»ºæˆåŠŸ";
  data: T;                             // åˆ›å»ºåçš„å®ä½“æ•°æ®
}
```

#### PUT /api/v1/{entity}/:id
**åŠŸèƒ½**: æ›´æ–°å®ä½“

**è¯·æ±‚ä½“**: æ ¹æ®å®ä½“å®šä¹‰çš„å­—æ®µç»“æ„ï¼ˆéƒ¨åˆ†å­—æ®µï¼‰

**å“åº”æ ¼å¼**:
```typescript
interface EntityUpdateResponse<T> {
  status: 0;
  msg: "æ›´æ–°æˆåŠŸ";
  data: T;                             // æ›´æ–°åçš„å®ä½“æ•°æ®
}
```

#### DELETE /api/v1/{entity}/:id
**åŠŸèƒ½**: åˆ é™¤å®ä½“

**å“åº”æ ¼å¼**:
```typescript
interface EntityDeleteResponse {
  status: 0;
  msg: "åˆ é™¤æˆåŠŸ";
  data: {
    id: string;                        // è¢«åˆ é™¤çš„å®ä½“ID
    deletedAt: string;                 // åˆ é™¤æ—¶é—´
  };
}
```

### 2. æ‰¹é‡æ“ä½œæ¥å£

#### POST /api/v1/{entity}/batch
**åŠŸèƒ½**: æ‰¹é‡åˆ›å»ºå®ä½“

**è¯·æ±‚ä½“**:
```typescript
interface BatchCreateRequest<T> {
  items: T[];                          // è¦åˆ›å»ºçš„å®ä½“æ•°æ®åˆ—è¡¨
  options?: {
    skipErrors: boolean;               // æ˜¯å¦è·³è¿‡é”™è¯¯ç»§ç»­å¤„ç†
    validateOnly: boolean;             // æ˜¯å¦åªéªŒè¯ä¸å®é™…åˆ›å»º
  };
}
```

**å“åº”æ ¼å¼**:
```typescript
interface BatchCreateResponse<T> {
  status: 0;
  msg: "æ‰¹é‡åˆ›å»ºå®Œæˆ";
  data: {
    success: T[];                      // æˆåŠŸåˆ›å»ºçš„å®ä½“
    failed: Array<{
      item: T;                         // å¤±è´¥çš„å®ä½“æ•°æ®
      error: string;                   // é”™è¯¯ä¿¡æ¯
    }>;
    total: number;                     // æ€»æ•°
    successCount: number;              // æˆåŠŸæ•°é‡
    failedCount: number;               // å¤±è´¥æ•°é‡
  };
}
```

#### DELETE /api/v1/{entity}/batch
**åŠŸèƒ½**: æ‰¹é‡åˆ é™¤å®ä½“

**è¯·æ±‚ä½“**:
```typescript
interface BatchDeleteRequest {
  ids: string[];                       // è¦åˆ é™¤çš„å®ä½“IDåˆ—è¡¨
}
```

**å“åº”æ ¼å¼**:
```typescript
interface BatchDeleteResponse {
  status: 0;
  msg: "æ‰¹é‡åˆ é™¤å®Œæˆ";
  data: {
    deletedIds: string[];              // æˆåŠŸåˆ é™¤çš„IDåˆ—è¡¨
    failedIds: Array<{
      id: string;
      error: string;
    }>;
    deletedCount: number;              // åˆ é™¤æ•°é‡
    failedCount: number;               // å¤±è´¥æ•°é‡
  };
}
```

### 3. å…³è”æŸ¥è¯¢æ¥å£

#### GET /api/v1/{entity}/:id/{relation}
**åŠŸèƒ½**: è·å–å®ä½“çš„å…³è”æ•°æ®

**æŸ¥è¯¢å‚æ•°**: ä¸åˆ—è¡¨æŸ¥è¯¢ç›¸åŒ

**å“åº”æ ¼å¼**:
```typescript
interface RelationListResponse<T> {
  status: 0;
  msg: "success";
  data: {
    items: T[];                        // å…³è”å®ä½“æ•°æ®åˆ—è¡¨
    total: number;                     // æ€»è®°å½•æ•°
    relation: {
      type: 'ONE_TO_MANY' | 'MANY_TO_ONE' | 'MANY_TO_MANY';
      sourceEntity: string;
      targetEntity: string;
      sourceField: string;
      targetField: string;
    };
  };
  count: number;
}
```

## ğŸ”’ é”™è¯¯å¤„ç†è§„èŒƒ

### é”™è¯¯å“åº”æ ¼å¼
```typescript
interface ErrorResponse {
  status: 1;                           // é”™è¯¯çŠ¶æ€
  msg: string;                         // é”™è¯¯æ¶ˆæ¯
  data: null;                          // é”™è¯¯æ—¶æ•°æ®ä¸ºnull
  error?: {
    code: string;                      // é”™è¯¯ä»£ç 
    details: string;                   // è¯¦ç»†é”™è¯¯ä¿¡æ¯
    field?: string;                    // ç›¸å…³å­—æ®µ (éªŒè¯é”™è¯¯æ—¶)
    timestamp: string;                 // é”™è¯¯å‘ç”Ÿæ—¶é—´
  };
}
```

### å¸¸è§é”™è¯¯ä»£ç 
```typescript
enum ErrorCodes {
  // é€šç”¨é”™è¯¯
  INTERNAL_ERROR = 'INTERNAL_ERROR',
  INVALID_REQUEST = 'INVALID_REQUEST',
  UNAUTHORIZED = 'UNAUTHORIZED',
  FORBIDDEN = 'FORBIDDEN',
  NOT_FOUND = 'NOT_FOUND',
  
  // ä¸šåŠ¡é”™è¯¯
  ENTITY_NOT_FOUND = 'ENTITY_NOT_FOUND',
  DUPLICATE_ENTITY = 'DUPLICATE_ENTITY',
  VALIDATION_FAILED = 'VALIDATION_FAILED',
  RELATION_CONSTRAINT = 'RELATION_CONSTRAINT',
  
  // ä»£ç ç”Ÿæˆé”™è¯¯
  TEMPLATE_NOT_FOUND = 'TEMPLATE_NOT_FOUND',
  GENERATION_FAILED = 'GENERATION_FAILED',
  FILE_WRITE_ERROR = 'FILE_WRITE_ERROR',
  SERVICE_RESTART_FAILED = 'SERVICE_RESTART_FAILED'
}
```

## ğŸ“Š æ€§èƒ½è¦æ±‚

### å“åº”æ—¶é—´è¦æ±‚
- åˆ—è¡¨æŸ¥è¯¢: < 200ms (P95)
- è¯¦æƒ…æŸ¥è¯¢: < 100ms (P95)
- åˆ›å»ºæ“ä½œ: < 300ms (P95)
- æ›´æ–°æ“ä½œ: < 300ms (P95)
- åˆ é™¤æ“ä½œ: < 200ms (P95)
- ä»£ç ç”Ÿæˆ: < 30s

### åˆ†é¡µé™åˆ¶
- é»˜è®¤æ¯é¡µå¤§å°: 10
- æœ€å¤§æ¯é¡µå¤§å°: 100
- æœ€å¤§æŸ¥è¯¢è®°å½•æ•°: 10000

### å¹¶å‘é™åˆ¶
- å•ç”¨æˆ·QPSé™åˆ¶: 100
- å…¨å±€QPSé™åˆ¶: 1000
- ä»£ç ç”Ÿæˆå¹¶å‘é™åˆ¶: 5

## ğŸ” å®‰å…¨è§„èŒƒ

### è®¤è¯è¦æ±‚
- æ‰€æœ‰APIæ¥å£éƒ½éœ€è¦JWTè®¤è¯
- Tokenæœ‰æ•ˆæœŸ: 24å°æ—¶
- æ”¯æŒTokenåˆ·æ–°æœºåˆ¶

### æƒé™æ§åˆ¶
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- æ”¯æŒèµ„æºçº§æƒé™æ§åˆ¶
- æ”¯æŒå­—æ®µçº§æƒé™æ§åˆ¶

### æ•°æ®éªŒè¯
- æ‰€æœ‰è¾“å…¥å‚æ•°å¿…é¡»éªŒè¯
- ä½¿ç”¨DTOè¿›è¡Œæ•°æ®ä¼ è¾“
- æ”¯æŒè‡ªå®šä¹‰éªŒè¯è§„åˆ™

### å®‰å…¨å¤´è®¾ç½®
```typescript
// å¿…é¡»è®¾ç½®çš„å®‰å…¨å¤´
{
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
  'Content-Security-Policy': "default-src 'self'"
}
```

## ğŸ“ æ¥å£æ–‡æ¡£ç”Ÿæˆ

### Swaggeré…ç½®
```typescript
// è‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£
@ApiTags('å®ä½“ç®¡ç†')
@Controller('entities')
export class EntityController {
  @Get()
  @ApiOperation({ summary: 'è·å–å®ä½“åˆ—è¡¨' })
  @ApiResponse({ status: 200, description: 'æˆåŠŸ', type: EntityListResponse })
  @ApiResponse({ status: 400, description: 'è¯·æ±‚å‚æ•°é”™è¯¯' })
  @ApiResponse({ status: 401, description: 'æœªæˆæƒ' })
  async findAll(@Query() query: EntityListQuery) {
    // å®ç°é€»è¾‘
  }
}
```

### æ¥å£æµ‹è¯•
- æä¾›Postmané›†åˆæ–‡ä»¶
- æä¾›æ¥å£æµ‹è¯•ç”¨ä¾‹
- æ”¯æŒè‡ªåŠ¨åŒ–æ¥å£æµ‹è¯•

---

*æœ¬æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æœ€åæ›´æ–°: 2025-07-21*
