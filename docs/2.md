# ä½ä»£ç å¹³å°æŠ€æœ¯å®ç°è§„èŒƒ

## ğŸ“‹ æŠ€æœ¯æ¶æ„è§„èŒƒ

### ä»£ç ç”Ÿæˆå™¨æ¶æ„è®¾è®¡

```typescript
// ä»£ç ç”Ÿæˆå™¨æ ¸å¿ƒæ¶æ„
lowcode-platform-backend/src/
â”œâ”€â”€ lib/bounded-contexts/code-generation/
â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ intelligent-code-generator.service.ts    # æ ¸å¿ƒç”ŸæˆæœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ amis-backend-manager.service.ts         # ç›®æ ‡æœåŠ¡ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ template-engine.service.ts              # æ¨¡æ¿å¼•æ“
â”‚   â”‚   â”‚   â””â”€â”€ file-system-manager.service.ts          # æ–‡ä»¶ç³»ç»Ÿç®¡ç†
â”‚   â”‚   â””â”€â”€ handlers/
â”‚   â”‚       â””â”€â”€ generate-code.handler.ts                # ç”Ÿæˆå‘½ä»¤å¤„ç†å™¨
â”‚   â””â”€â”€ infrastructure/
â”‚       â”œâ”€â”€ templates/                                  # æ¨¡æ¿ä»“å‚¨
â”‚       â””â”€â”€ file-writers/                              # æ–‡ä»¶å†™å…¥å™¨
â””â”€â”€ resources/templates/                                # æ¨¡æ¿æ–‡ä»¶
    â”œâ”€â”€ entity-controller.hbs                          # æ§åˆ¶å™¨æ¨¡æ¿
    â”œâ”€â”€ entity-module.hbs                              # æ¨¡å—æ¨¡æ¿
    â”œâ”€â”€ prisma-schema.hbs                              # Schemaæ¨¡æ¿
    â””â”€â”€ amis-page.hbs                                  # é¡µé¢æ¨¡æ¿
```

### ç›®æ ‡æœåŠ¡æ¶æ„è®¾è®¡

```typescript
// amis-lowcode-backend åˆ†å±‚æ¶æ„
amis-lowcode-backend/src/
â”œâ”€â”€ base/                                              # åŸºç¡€ä»£ç å±‚ (è‡ªåŠ¨ç”Ÿæˆ)
â”‚   â”œâ”€â”€ controllers/                                   # åŸºç¡€æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ {entity}.base.controller.ts
â”‚   â”œâ”€â”€ services/                                      # åŸºç¡€æœåŠ¡
â”‚   â”‚   â””â”€â”€ {entity}.base.service.ts
â”‚   â”œâ”€â”€ dto/                                          # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â””â”€â”€ {entity}.dto.ts
â”‚   â””â”€â”€ entities/                                     # å®ä½“æ¨¡å‹
â”‚       â””â”€â”€ {entity}.entity.ts
â”œâ”€â”€ biz/                                              # ä¸šåŠ¡ä»£ç å±‚ (å¯æ‰©å±•)
â”‚   â”œâ”€â”€ controllers/                                   # ä¸šåŠ¡æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ {entity}.controller.ts
â”‚   â”œâ”€â”€ services/                                      # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â””â”€â”€ {entity}.service.ts
â”‚   â””â”€â”€ modules/                                       # ä¸šåŠ¡æ¨¡å—
â”‚       â””â”€â”€ {entity}.module.ts
â””â”€â”€ shared/                                           # å…±äº«æ¨¡å—
    â”œâ”€â”€ interceptors/
    â”‚   â””â”€â”€ amis-response.interceptor.ts              # Amiså“åº”æ‹¦æˆªå™¨
    â”œâ”€â”€ decorators/
    â”‚   â””â”€â”€ amis-api.decorator.ts                     # Amis APIè£…é¥°å™¨
    â””â”€â”€ utils/
        â””â”€â”€ amis-response.util.ts                     # Amiså“åº”å·¥å…·
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°è§„èŒƒ

### 1. ä»£ç æ¨¡æ¿è§„èŒƒ

#### 1.1 æ§åˆ¶å™¨æ¨¡æ¿ (entity-controller.hbs)

```handlebars
import { Controller, Get, Post, Put, Delete, Body, Param, Query } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
import { {{pascalCase entity.code}}BaseController } from '../base/controllers/{{kebabCase entity.code}}.base.controller';
import { {{pascalCase entity.code}}Service } from '../services/{{kebabCase entity.code}}.service';
import { Create{{pascalCase entity.code}}Dto, Update{{pascalCase entity.code}}Dto } from '../dto/{{kebabCase entity.code}}.dto';
import { AmisResponse } from '../shared/decorators/amis-api.decorator';

@ApiTags('{{entity.name}}')
@Controller('{{kebabCase entity.code}}')
export class {{pascalCase entity.code}}Controller extends {{pascalCase entity.code}}BaseController {
  constructor(private readonly {{camelCase entity.code}}Service: {{pascalCase entity.code}}Service) {
    super({{camelCase entity.code}}Service);
  }

  @Get()
  @ApiOperation({ summary: 'è·å–{{entity.name}}åˆ—è¡¨' })
  @AmisResponse()
  async findAll(@Query() query: any) {
    return super.findAll(query);
  }

  @Get(':id')
  @ApiOperation({ summary: 'è·å–{{entity.name}}è¯¦æƒ…' })
  @AmisResponse()
  async findOne(@Param('id') id: string) {
    return super.findOne(id);
  }

  @Post()
  @ApiOperation({ summary: 'åˆ›å»º{{entity.name}}' })
  @AmisResponse()
  async create(@Body() createDto: Create{{pascalCase entity.code}}Dto) {
    return super.create(createDto);
  }

  @Put(':id')
  @ApiOperation({ summary: 'æ›´æ–°{{entity.name}}' })
  @AmisResponse()
  async update(@Param('id') id: string, @Body() updateDto: Update{{pascalCase entity.code}}Dto) {
    return super.update(id, updateDto);
  }

  @Delete(':id')
  @ApiOperation({ summary: 'åˆ é™¤{{entity.name}}' })
  @AmisResponse()
  async remove(@Param('id') id: string) {
    return super.remove(id);
  }
}
```

#### 1.2 æ¨¡å—æ¨¡æ¿ (entity-module.hbs)

```handlebars
import { Module } from '@nestjs/common';
import { {{pascalCase entity.code}}Controller } from '../controllers/{{kebabCase entity.code}}.controller';
import { {{pascalCase entity.code}}Service } from '../services/{{kebabCase entity.code}}.service';
import { PrismaModule } from '../shared/prisma/prisma.module';

@Module({
  imports: [PrismaModule],
  controllers: [{{pascalCase entity.code}}Controller],
  providers: [{{pascalCase entity.code}}Service],
  exports: [{{pascalCase entity.code}}Service],
})
export class {{pascalCase entity.code}}Module {}
```

#### 1.3 Prisma Schemaæ¨¡æ¿ (prisma-schema.hbs)

```handlebars
{{#each entities}}
model {{pascalCase code}} {
  {{#each fields}}
  {{camelCase code}} {{prismaType type}}{{#if nullable}}?{{/if}}{{#if primaryKey}} @id{{/if}}{{#if uniqueConstraint}} @unique{{/if}}{{#if defaultValue}} @default({{defaultValue}}){{/if}}{{#if comment}} // {{comment}}{{/if}}
  {{/each}}
  
  {{#each relationships}}
  {{#if (eq type 'ONE_TO_MANY')}}
  {{camelCase targetEntity.code}}s {{pascalCase targetEntity.code}}[]
  {{/if}}
  {{#if (eq type 'MANY_TO_ONE')}}
  {{camelCase targetEntity.code}} {{pascalCase targetEntity.code}} @relation(fields: [{{camelCase sourceField.code}}], references: [{{camelCase targetField.code}}])
  {{camelCase sourceField.code}} String
  {{/if}}
  {{#if (eq type 'MANY_TO_MANY')}}
  {{camelCase targetEntity.code}}s {{pascalCase targetEntity.code}}[]
  {{/if}}
  {{/each}}

  @@map("{{tableName}}")
}

{{/each}}
```

### 2. Amiså…¼å®¹æ€§å®ç°è§„èŒƒ

#### 2.1 å“åº”æ‹¦æˆªå™¨å®ç°

```typescript
// shared/interceptors/amis-response.interceptor.ts
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

export interface AmisResponse<T> {
  status: 0 | 1;
  msg: string;
  data: T;
  count?: number;
}

@Injectable()
export class AmisResponseInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<AmisResponse<any>> {
    return next.handle().pipe(
      map(data => {
        // å¤„ç†åˆ†é¡µæ•°æ®
        if (data && typeof data === 'object' && 'items' in data && 'total' in data) {
          return {
            status: 0,
            msg: 'success',
            data: {
              items: data.items,
              total: data.total
            },
            count: data.total
          };
        }

        // å¤„ç†æ™®é€šæ•°æ®
        return {
          status: 0,
          msg: 'success',
          data: data
        };
      })
    );
  }
}
```

#### 2.2 Amis APIè£…é¥°å™¨

```typescript
// shared/decorators/amis-api.decorator.ts
import { applyDecorators, UseInterceptors } from '@nestjs/common';
import { AmisResponseInterceptor } from '../interceptors/amis-response.interceptor';

export function AmisResponse() {
  return applyDecorators(
    UseInterceptors(AmisResponseInterceptor)
  );
}
```

### 3. æ–‡ä»¶ç”ŸæˆæœåŠ¡å®ç°è§„èŒƒ

#### 3.1 AmisBackendManagerServiceå®ç°

```typescript
// application/services/amis-backend-manager.service.ts
import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import * as fs from 'fs-extra';
import * as path from 'path';

export interface GeneratedFile {
  path: string;
  content: string;
  type: 'base' | 'biz';
  overwrite: boolean;
}

@Injectable()
export class AmisBackendManagerService {
  private readonly logger = new Logger(AmisBackendManagerService.name);
  private readonly amisBackendPath: string;

  constructor(private configService: ConfigService) {
    this.amisBackendPath = this.configService.get<string>('AMIS_BACKEND_PATH') || 
      path.join(process.cwd(), '../amis-lowcode-backend');
  }

  async writeGeneratedFiles(files: GeneratedFile[]): Promise<void> {
    this.logger.log(`Writing ${files.length} generated files...`);

    for (const file of files) {
      const fullPath = path.join(this.amisBackendPath, 'src', file.path);
      
      // ç¡®ä¿ç›®å½•å­˜åœ¨
      await fs.ensureDir(path.dirname(fullPath));
      
      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸å…è®¸è¦†ç›–
      if (!file.overwrite && await fs.pathExists(fullPath)) {
        this.logger.warn(`File exists and overwrite disabled: ${file.path}`);
        continue;
      }

      // å†™å…¥æ–‡ä»¶
      await fs.writeFile(fullPath, file.content, 'utf8');
      this.logger.log(`Generated file: ${file.path}`);
    }
  }

  async generatePrismaSchema(metadata: ProjectMetadata): Promise<void> {
    this.logger.log('Generating Prisma schema...');
    
    const schemaPath = path.join(this.amisBackendPath, 'prisma/schema.prisma');
    const templatePath = path.join(process.cwd(), 'src/resources/templates/prisma-schema.hbs');
    
    // ä½¿ç”¨æ¨¡æ¿å¼•æ“ç”Ÿæˆschema
    const template = await fs.readFile(templatePath, 'utf8');
    const compiledTemplate = Handlebars.compile(template);
    const schemaContent = compiledTemplate(metadata);
    
    // å†™å…¥schemaæ–‡ä»¶
    await fs.writeFile(schemaPath, schemaContent, 'utf8');
    
    // æ‰§è¡Œprisma generate
    await this.executePrismaGenerate();
  }

  async updateAppModule(entities: Entity[]): Promise<void> {
    this.logger.log('Updating app.module.ts...');
    
    const appModulePath = path.join(this.amisBackendPath, 'src/app.module.ts');
    
    // ç”Ÿæˆæ¨¡å—å¯¼å…¥ä»£ç 
    const imports = entities.map(entity => 
      `import { ${entity.code}Module } from './biz/modules/${entity.code.toLowerCase()}.module';`
    ).join('\n');
    
    const modules = entities.map(entity => `${entity.code}Module`).join(',\n    ');
    
    const appModuleContent = `
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { PrismaModule } from './shared/prisma/prisma.module';
${imports}

@Module({
  imports: [
    ConfigModule.forRoot(),
    PrismaModule,
    ${modules}
  ],
})
export class AppModule {}
`;

    await fs.writeFile(appModulePath, appModuleContent, 'utf8');
  }

  async restartAmisBackend(): Promise<void> {
    this.logger.log('Restarting amis-lowcode-backend service...');
    
    // å®ç°æœåŠ¡é‡å¯é€»è¾‘
    // å¯ä»¥é€šè¿‡PM2ã€Dockeræˆ–å…¶ä»–æ–¹å¼é‡å¯æœåŠ¡
    try {
      const { exec } = require('child_process');
      await new Promise((resolve, reject) => {
        exec('cd ../amis-lowcode-backend && npm run start:dev', (error, stdout, stderr) => {
          if (error) {
            reject(error);
          } else {
            resolve(stdout);
          }
        });
      });
      
      this.logger.log('Service restarted successfully');
    } catch (error) {
      this.logger.error('Failed to restart service:', error);
      throw error;
    }
  }

  private async executePrismaGenerate(): Promise<void> {
    const { exec } = require('child_process');
    return new Promise((resolve, reject) => {
      exec('cd ../amis-lowcode-backend && npx prisma generate', (error, stdout, stderr) => {
        if (error) {
          reject(error);
        } else {
          resolve();
        }
      });
    });
  }
}
```

### 4. æ¨¡æ¿å¼•æ“æœåŠ¡å®ç°è§„èŒƒ

#### 4.1 TemplateEngineServiceå®ç°

```typescript
// application/services/template-engine.service.ts
import { Injectable, Logger } from '@nestjs/common';
import * as Handlebars from 'handlebars';
import * as fs from 'fs-extra';
import * as path from 'path';

@Injectable()
export class TemplateEngineService {
  private readonly logger = new Logger(TemplateEngineService.name);
  private readonly templatesPath: string;

  constructor() {
    this.templatesPath = path.join(process.cwd(), 'src/resources/templates');
    this.registerHelpers();
  }

  async renderTemplate(templateName: string, data: any): Promise<string> {
    const templatePath = path.join(this.templatesPath, `${templateName}.hbs`);
    
    if (!await fs.pathExists(templatePath)) {
      throw new Error(`Template not found: ${templateName}`);
    }

    const templateContent = await fs.readFile(templatePath, 'utf8');
    const compiledTemplate = Handlebars.compile(templateContent);
    
    return compiledTemplate(data);
  }

  private registerHelpers(): void {
    // æ³¨å†ŒHandlebarsåŠ©æ‰‹å‡½æ•°
    Handlebars.registerHelper('pascalCase', (str: string) => {
      return str.charAt(0).toUpperCase() + str.slice(1).replace(/_([a-z])/g, (g) => g[1].toUpperCase());
    });

    Handlebars.registerHelper('camelCase', (str: string) => {
      return str.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
    });

    Handlebars.registerHelper('kebabCase', (str: string) => {
      return str.replace(/_/g, '-').toLowerCase();
    });

    Handlebars.registerHelper('prismaType', (type: string) => {
      const typeMap = {
        'STRING': 'String',
        'INTEGER': 'Int',
        'FLOAT': 'Float',
        'BOOLEAN': 'Boolean',
        'DATE': 'DateTime',
        'TEXT': 'String',
        'JSON': 'Json'
      };
      return typeMap[type] || 'String';
    });

    Handlebars.registerHelper('eq', (a: any, b: any) => a === b);
  }
}
```

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env
DATABASE_URL="postgresql://username:password@localhost:5432/lowcode_platform"
AMIS_BACKEND_PATH="../amis-lowcode-backend"
REDIS_URL="redis://localhost:6379"
JWT_SECRET="your-jwt-secret"
```

### ä¾èµ–åŒ…é…ç½®

```json
{
  "dependencies": {
    "handlebars": "^4.7.7",
    "fs-extra": "^11.1.1",
    "chokidar": "^3.5.3"
  },
  "devDependencies": {
    "@types/handlebars": "^4.1.0",
    "@types/fs-extra": "^11.0.1"
  }
}
```

## ğŸ“ ä»£ç è§„èŒƒ

### TypeScriptè§„èŒƒ
- ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼
- æ‰€æœ‰å‡½æ•°å¿…é¡»æœ‰è¿”å›ç±»å‹å£°æ˜
- ä½¿ç”¨æ¥å£å®šä¹‰æ•°æ®ç»“æ„
- éµå¾ªESLintè§„åˆ™

### å‘½åè§„èŒƒ
- ç±»åä½¿ç”¨PascalCase
- æ–¹æ³•åä½¿ç”¨camelCase
- å¸¸é‡ä½¿ç”¨UPPER_SNAKE_CASE
- æ–‡ä»¶åä½¿ç”¨kebab-case

### æ³¨é‡Šè§„èŒƒ
- æ‰€æœ‰å…¬å…±æ–¹æ³•å¿…é¡»æœ‰JSDocæ³¨é‡Š
- å¤æ‚é€»è¾‘å¿…é¡»æœ‰è¡Œå†…æ³¨é‡Š
- æ¥å£å’Œç±»å‹å¿…é¡»æœ‰è¯´æ˜æ³¨é‡Š

---

*æœ¬æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æœ€åæ›´æ–°: 2025-07-21*
