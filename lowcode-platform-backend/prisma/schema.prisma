// Lowcode Platform Backend Service - Core Low-code Platform Tables
// This schema contains only low-code platform specific tables
// System management tables are handled by the backend service

generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/client"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["lowcode"]
}

model Project {
  id          String         @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  name        String         @db.VarChar(100)
  code        String         @unique @db.VarChar(100)
  description String?
  version     String?        @default("1.0.0") @db.VarChar(20)
  config      Json?          @default("{}")
  status      String?        @default("ACTIVE") @db.VarChar(20)
  createdBy   String         @map("created_by") @db.VarChar(36)
  createdAt   DateTime?      @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy   String?        @map("updated_by") @db.VarChar(36)
  updatedAt   DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  apiConfigs  ApiConfig[]
  apis        Api[]
  entities    Entity[]
  queries     LowcodeQuery[]
  relations   Relation[]

  @@map("lowcode_projects")
  @@schema("lowcode")
}

model Entity {
  id              String         @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  projectId       String         @map("project_id") @db.VarChar(36)
  name            String         @db.VarChar(100)
  code            String         @db.VarChar(100)
  tableName       String         @map("table_name") @db.VarChar(100)
  description     String?
  category        String?        @db.VarChar(50)
  diagramPosition Json?          @map("diagram_position")
  config          Json?          @default("{}")
  version         String?        @default("1.0.0") @db.VarChar(20)
  status          String?        @default("DRAFT") @db.VarChar(20)
  createdBy       String         @map("created_by") @db.VarChar(36)
  createdAt       DateTime?      @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy       String?        @map("updated_by") @db.VarChar(36)
  updatedAt       DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  apiConfigs      ApiConfig[]
  apis            Api[]
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  fields          Field[]
  queries         LowcodeQuery[]
  sourceRelations Relation[]     @relation("SourceEntity")
  targetRelations Relation[]     @relation("TargetEntity")

  @@unique([projectId, code])
  @@unique([projectId, tableName])
  @@index([projectId], map: "idx_lowcode_entities_project_id")
  @@index([status], map: "idx_lowcode_entities_status")
  @@map("lowcode_entities")
  @@schema("lowcode")
}

model Field {
  id               String     @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  entityId         String     @map("entity_id") @db.VarChar(36)
  name             String     @db.VarChar(100)
  code             String     @db.VarChar(100)
  type             String     @db.VarChar(50)
  length           Int?
  precision        Int?
  scale            Int?
  nullable         Boolean?   @default(true)
  required         Boolean?   @default(false)
  uniqueConstraint Boolean?   @default(false) @map("unique_constraint")
  indexed          Boolean?   @default(false)
  primaryKey       Boolean?   @default(false) @map("primary_key")
  defaultValue     String?    @map("default_value")
  validationRules  Json?      @map("validation_rules")
  validation       Json?
  referenceConfig  Json?      @map("reference_config")
  config           Json?
  enumOptions      Json?      @map("enum_options")
  comment          String?
  sortOrder        Int?       @default(0) @map("sort_order")
  createdBy        String     @map("created_by") @db.VarChar(36)
  createdAt        DateTime?  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy        String?    @map("updated_by") @db.VarChar(36)
  updatedAt        DateTime?  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  entity           Entity     @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sourceRelations  Relation[] @relation("SourceField")
  targetRelations  Relation[] @relation("TargetField")

  @@unique([entityId, code])
  @@index([entityId], map: "idx_lowcode_fields_entity_id")
  @@map("lowcode_fields")
  @@schema("lowcode")
}

model Relation {
  id              String    @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  projectId       String    @map("project_id") @db.VarChar(36)
  name            String    @db.VarChar(100)
  code            String    @db.VarChar(100)
  description     String?
  type            String    @db.VarChar(50)
  sourceEntityId  String    @map("source_entity_id") @db.VarChar(36)
  sourceFieldId   String?   @map("source_field_id") @db.VarChar(36)
  targetEntityId  String    @map("target_entity_id") @db.VarChar(36)
  targetFieldId   String?   @map("target_field_id") @db.VarChar(36)
  foreignKeyName  String?   @map("foreign_key_name") @db.VarChar(100)
  joinTableConfig Json?     @map("join_table_config")
  onDelete        String?   @default("RESTRICT") @map("on_delete") @db.VarChar(20)
  onUpdate        String?   @default("RESTRICT") @map("on_update") @db.VarChar(20)
  config          Json?     @default("{}")
  status          String?   @default("ACTIVE") @db.VarChar(20)
  indexed         Boolean?  @default(true)
  indexName       String?   @map("index_name") @db.VarChar(100)
  createdBy       String    @map("created_by") @db.VarChar(36)
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy       String?   @map("updated_by") @db.VarChar(36)
  updatedAt       DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sourceEntity    Entity    @relation("SourceEntity", fields: [sourceEntityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sourceField     Field?    @relation("SourceField", fields: [sourceFieldId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  targetEntity    Entity    @relation("TargetEntity", fields: [targetEntityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  targetField     Field?    @relation("TargetField", fields: [targetFieldId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([projectId, code])
  @@index([projectId], map: "idx_lowcode_relations_project_id")
  @@index([sourceEntityId], map: "idx_lowcode_relations_source_entity")
  @@index([targetEntityId], map: "idx_lowcode_relations_target_entity")
  @@map("lowcode_relations")
  @@schema("lowcode")
}

model ApiConfig {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  projectId   String    @map("project_id") @db.VarChar(36)
  name        String    @db.VarChar(100)
  code        String    @db.VarChar(100)
  description String?
  method      String    @db.VarChar(10)
  path        String    @db.VarChar(500)
  entityId    String?   @map("entity_id") @db.VarChar(36)
  parameters  Json?     @default("[]")
  responses   Json?     @default("[]")
  security    Json?     @default("{\"type\": \"none\"}")
  config      Json?     @default("{}")
  status      String?   @default("DRAFT") @db.VarChar(20)
  version     String?   @default("1.0.0") @db.VarChar(20)
  createdBy   String    @map("created_by") @db.VarChar(36)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy   String?   @map("updated_by") @db.VarChar(36)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  entity      Entity?   @relation(fields: [entityId], references: [id], onUpdate: NoAction)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([projectId, code])
  @@unique([projectId, method, path])
  @@index([projectId], map: "idx_lowcode_api_configs_project_id")
  @@map("lowcode_api_configs")
  @@schema("lowcode")
}

model Api {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  projectId      String    @map("project_id") @db.VarChar(36)
  entityId       String?   @map("entity_id") @db.VarChar(36)
  name           String    @db.VarChar(100)
  code           String    @db.VarChar(100)
  path           String    @db.VarChar(200)
  method         String    @db.VarChar(10)
  description    String?
  requestConfig  Json?     @map("request_config")
  responseConfig Json?     @map("response_config")
  queryConfig    Json?     @map("query_config")
  authConfig     Json?     @map("auth_config")
  version        String?   @default("1.0.0") @db.VarChar(20)
  status         String?   @default("DRAFT") @db.VarChar(20)
  createdBy      String    @map("created_by") @db.VarChar(36)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy      String?   @map("updated_by") @db.VarChar(36)
  updatedAt      DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  entity         Entity?   @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([projectId, code])
  @@unique([projectId, path, method])
  @@index([entityId], map: "idx_lowcode_apis_entity_id")
  @@index([projectId], map: "idx_lowcode_apis_project_id")
  @@map("lowcode_apis")
  @@schema("lowcode")
}

model LowcodeQuery {
  id                String    @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  projectId         String    @map("project_id") @db.VarChar(36)
  name              String    @db.VarChar(100)
  description       String?
  baseEntityId      String    @map("base_entity_id") @db.VarChar(36)
  baseEntityAlias   String?   @default("main") @map("base_entity_alias") @db.VarChar(50)
  joins             Json?     @default("[]")
  fields            Json?     @default("[]")
  filters           Json?     @default("[]")
  sorting           Json?     @default("[]")
  groupBy           Json?     @default("[]") @map("group_by")
  having_conditions Json?     @default("[]")
  limit             Int?      @map("limit_count")
  offset            Int?      @map("offset_count")
  status            String?   @default("DRAFT") @db.VarChar(20)
  sqlQuery          String?   @map("sql_query")
  executionStats    Json?     @map("execution_stats")
  createdBy         String    @map("created_by") @db.VarChar(36)
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy         String?   @map("updated_by") @db.VarChar(36)
  updatedAt         DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  baseEntity        Entity    @relation(fields: [baseEntityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([projectId, name])
  @@index([baseEntityId], map: "idx_lowcode_queries_base_entity_id")
  @@index([projectId], map: "idx_lowcode_queries_project_id")
  @@index([status], map: "idx_lowcode_queries_status")
  @@map("lowcode_queries")
  @@schema("lowcode")
}

model CodegenTask {
  id         String    @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  projectId  String    @map("project_id") @db.VarChar(36)
  name       String    @db.VarChar(100)
  type       String    @db.VarChar(50)
  config     Json?     @default("{}")
  status     String?   @default("PENDING") @db.VarChar(20)
  progress   Int?      @default(0)
  result     Json?
  errorMsg   String?   @map("error_msg")
  outputPath String?   @map("output_path") @db.VarChar(500)
  createdBy  String    @map("created_by") @db.VarChar(36)
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([projectId], map: "idx_lowcode_codegen_tasks_project_id")
  @@index([status], map: "idx_lowcode_codegen_tasks_status")
  @@map("lowcode_codegen_tasks")
  @@schema("lowcode")
}

model CodeTemplate {
  id          String             @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  name        String             @db.VarChar(100)
  code        String             @unique @db.VarChar(100)
  type        String             @db.VarChar(50)
  language    String             @db.VarChar(20)
  framework   String             @db.VarChar(50)
  description String?
  content     String
  variables   Json?              @default("[]")
  version     String?            @default("1.0.0") @db.VarChar(20)
  status      String?            @default("ACTIVE") @db.VarChar(20)
  createdBy   String             @map("created_by") @db.VarChar(36)
  createdAt   DateTime?          @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy   String?            @map("updated_by") @db.VarChar(36)
  updatedAt   DateTime?          @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  category    String?            @default("CONTROLLER") @db.VarChar(50)
  tags        Json?              @default("[]")
  isPublic    Boolean?           @default(false) @map("is_public")
  versions    TemplateVersion[]

  @@index([category], map: "idx_lowcode_code_templates_category")
  @@index([language], map: "idx_lowcode_code_templates_language")
  @@index([framework], map: "idx_lowcode_code_templates_framework")
  @@index([status], map: "idx_lowcode_code_templates_status")
  @@index([isPublic], map: "idx_lowcode_code_templates_is_public")
  @@map("lowcode_code_templates")
  @@schema("lowcode")
}

model TemplateVersion {
  id         String        @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  templateId String        @map("template_id") @db.VarChar(36)
  version    String        @db.VarChar(20)
  content    String
  variables  Json?         @default("[]")
  changelog  String?
  createdBy  String        @map("created_by") @db.VarChar(36)
  createdAt  DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  template   CodeTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version], map: "lowcode_template_versions_template_id_version_key")
  @@index([templateId], map: "idx_lowcode_template_versions_template_id")
  @@index([version], map: "idx_lowcode_template_versions_version")
  @@map("lowcode_template_versions")
  @@schema("lowcode")
}


