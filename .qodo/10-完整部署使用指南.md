# SoybeanAdmin NestJS 低代码平台 - 完整部署和使用指南

## 🎯 项目概述

SoybeanAdmin NestJS 是一个现代化的企业级低代码平台，结合了 Vue3 前端和 NestJS 后端，提供完整的可视化开发体验。

### 核心特性

- 🚀 **现代技术栈**: Vue3 + Vite6 + NestJS + Fastify + Prisma
- 🎨 **可视化设计**: 拖拽式实体建模、关系图、代码生成
- 🏗️ **微服务架构**: 清晰的模块边界，支持水平扩展
- 🛡️ **企业级安全**: JWT认证 + RBAC权限控制 + 审计日志
- 📊 **智能生成**: 基于模板的代码生成引擎，支持多种架构模式
- 🔧 **灵活部署**: Docker容器化部署，支持多环境配置

## 📋 系统要求

### 开发环境
- Node.js 18+ 
- PostgreSQL 13+
- Docker & Docker Compose
- Git

### 系统配置建议
- **内存**: 8GB+ (推荐16GB)
- **CPU**: 4核+ (推荐8核)
- **硬盘**: 50GB可用空间
- **操作系统**: macOS 10.15+ / Ubuntu 20.04+ / Windows 10+

## 🚀 快速开始

### 1. 克隆项目

```bash
git clone <repository-url>
cd soybean-admin-nestjs
```

### 2. 一键启动脚本

我们提供了一键启动脚本，自动完成所有初始化工作：

```bash
# 给予执行权限
chmod +x start-lowcode-platform.sh

# 运行一键启动脚本
./start-lowcode-platform.sh
```

### 3. 手动启动（可选）

如果需要手动控制每个步骤：

#### 3.1 启动数据库

```bash
# 启动PostgreSQL数据库
docker-compose up -d postgres
```

#### 3.2 启动后端服务

```bash
# 启动低代码平台后端 (端口3002)
cd lowcode-platform-backend
npm install
npm run prisma:generate
npm run prisma:migrate
npm run start:dev

# 启动amis动态后端 (端口9522)
cd ../amis-lowcode-backend
npm install
npm run prisma:generate
npm run start:dev
```

#### 3.3 启动前端

```bash
# 启动前端界面 (端口5173)
cd ../frontend
npm install
npm run dev
```

## 🌐 访问地址

启动成功后，可以通过以下地址访问：

| 服务 | 地址 | 说明 |
|------|------|------|
| 前端界面 | http://localhost:5173 | 主要用户界面 |
| 低代码平台后端 | http://localhost:3002 | 核心业务API |
| API文档 | http://localhost:3002/api-docs | Swagger API文档 |
| Amis动态后端 | http://localhost:9522 | 动态服务生成 |
| Amis API文档 | http://localhost:9522/api/v1/docs | Amis服务文档 |

## 📖 功能使用指南

### 1. 项目管理

#### 创建项目
1. 访问前端界面
2. 导航到"项目管理"页面
3. 点击"创建项目"按钮
4. 填写项目信息：
   - **项目名称**: 中文名称，如"电商管理系统"
   - **项目代码**: 英文标识，如"ecommerce-admin"
   - **技术架构**: 选择NestJS + Base-Biz架构
   - **数据库**: 选择PostgreSQL
   - **描述**: 项目详细说明

#### 项目配置
- **框架选择**: NestJS (推荐)、Express、Koa
- **架构模式**: Base-Biz、DDD、Clean Architecture
- **编程语言**: TypeScript (推荐)、JavaScript
- **数据库**: PostgreSQL (推荐)、MySQL、MongoDB

### 2. 实体建模

#### 创建实体
1. 在项目中点击"实体管理"
2. 创建新实体，如"用户"、"商品"、"订单"
3. 配置实体属性：
   - **实体名称**: 中文名称
   - **实体代码**: 英文代码（PascalCase）
   - **表名**: 数据库表名（snake_case）
   - **分类**: 核心实体、业务实体、辅助实体

#### 字段设计
为每个实体添加字段：

**基础字段类型**:
- `STRING`: 字符串（可设置长度）
- `INTEGER`: 整数
- `DECIMAL`: 小数（可设置精度）
- `BOOLEAN`: 布尔值
- `DATETIME`: 日期时间
- `TEXT`: 长文本
- `ENUM`: 枚举值

**字段配置**:
- **必填性**: 是否允许空值
- **唯一性**: 是否需要唯一约束
- **默认值**: 字段默认值
- **验证规则**: 正则表达式、长度限制等
- **索引**: 是否创建数据库索引

### 3. 关系建模

#### 关系类型
- **一对一** (ONE_TO_ONE): 用户 ↔ 用户资料
- **一对多** (ONE_TO_MANY): 用户 → 订单
- **多对多** (MANY_TO_MANY): 用户 ↔ 角色

#### 配置关系
1. 选择源实体和目标实体
2. 设置关系类型
3. 配置外键约束：
   - **级联删除**: CASCADE、SET_NULL、RESTRICT
   - **级联更新**: CASCADE、RESTRICT
4. 设置关系字段名

### 4. 查询管理

#### 创建查询
1. 选择基础实体
2. 配置查询条件：
   - **字段选择**: 要查询的字段
   - **过滤条件**: WHERE条件
   - **排序规则**: ORDER BY
   - **分组统计**: GROUP BY (可选)
   - **表连接**: JOIN其他实体

#### 查询示例
```sql
-- 查询活跃用户的订单统计
SELECT 
  u.id as userId,
  u.username,
  COUNT(o.id) as orderCount,
  SUM(o.totalAmount) as totalAmount
FROM users u
LEFT JOIN orders o ON u.id = o.userId
WHERE u.status = 'ACTIVE'
GROUP BY u.id, u.username
ORDER BY totalAmount DESC
```

### 5. 代码生成

#### 配置生成选项
1. 选择目标项目
2. 配置生成参数：
   - **输出路径**: 代码生成目录
   - **包命名**: 如`com.company.project`
   - **作者信息**: 代码注释中的作者
   - **版本信息**: 项目版本号

#### 支持的代码模板
- **实体类**: TypeORM实体定义
- **DTO类**: 数据传输对象
- **控制器**: REST API控制器
- **服务类**: 业务逻辑服务
- **仓储类**: 数据访问层
- **模块定义**: NestJS模块配置

#### 生成架构支持
1. **Base-Biz双层架构**:
   - Base层：基础CRUD操作
   - Biz层：业务逻辑扩展

2. **DDD领域驱动设计**:
   - 领域实体、值对象
   - 领域服务、应用服务
   - 命令和查询分离

### 6. API配置

#### 自动生成API
系统会自动为每个实体生成REST API：
- `GET /api/entities` - 查询列表
- `GET /api/entities/:id` - 获取详情
- `POST /api/entities` - 创建新记录
- `PUT /api/entities/:id` - 更新记录
- `DELETE /api/entities/:id` - 删除记录

#### API定制
- **路径定制**: 自定义API路径前缀
- **权限控制**: 配置访问权限
- **参数验证**: 添加输入验证
- **响应格式**: 自定义返回格式
- **中间件**: 添加自定义中间件

### 7. 动态部署

#### Amis动态服务
系统支持将设计的实体动态部署为Amis后端服务：

1. **选择项目**: 在项目列表中选择要部署的项目
2. **点击部署**: 点击项目操作菜单中的"部署项目"
3. **配置端口**: 选择服务运行端口（默认自动分配）
4. **启动服务**: 系统自动生成代码并启动服务

#### 部署后功能
- 自动生成的REST API
- 实时数据CRUD操作  
- 支持复杂查询和关联
- 自动生成API文档

## 🧪 测试验证

### 自动化测试

运行完整的系统测试：

```bash
# 基础系统测试
./test-system.sh

# 端到端集成测试
./e2e-integration-test.sh
```

### 手动测试流程

1. **创建测试项目**:
   - 项目名称: "测试电商系统"
   - 项目代码: "test-ecommerce"

2. **设计实体模型**:
   - 用户实体（username, email, phone）
   - 商品实体（name, price, stock）
   - 订单实体（orderNumber, userId, totalAmount）

3. **配置实体关系**:
   - 用户 → 订单 (一对多)

4. **生成代码**:
   - 选择NestJS + TypeScript
   - 生成完整的CRUD代码

5. **部署验证**:
   - 部署为Amis动态服务
   - 测试API接口
   - 验证数据操作

## 🐛 故障排除

### 常见问题

#### 1. 端口占用
```bash
# 检查端口占用
lsof -i :3002
lsof -i :9522
lsof -i :5173

# 杀死占用进程
kill -9 <PID>
```

#### 2. 数据库连接问题
```bash
# 检查数据库状态
docker-compose ps postgres

# 重启数据库
docker-compose restart postgres

# 查看数据库日志
docker-compose logs postgres
```

#### 3. 依赖安装问题
```bash
# 清理依赖缓存
rm -rf node_modules package-lock.json
npm cache clean --force
npm install

# 使用yarn（如果npm有问题）
yarn install
```

#### 4. Prisma相关问题
```bash
# 重新生成Prisma客户端
npx prisma generate

# 重置数据库
npx prisma migrate reset

# 查看数据库状态
npx prisma studio
```

### 日志查看

#### 应用日志
```bash
# lowcode-platform-backend日志
tail -f lowcode-platform-backend/logs/app.log

# amis-lowcode-backend日志
tail -f amis-lowcode-backend/logs/app.log
```

#### 容器日志
```bash
# 数据库日志
docker-compose logs -f postgres

# 所有服务日志
docker-compose logs -f
```

### 性能优化

#### 数据库优化
1. 为经常查询的字段添加索引
2. 使用数据库连接池
3. 启用查询缓存

#### 应用优化
1. 启用Redis缓存
2. 使用CDN加速静态资源
3. 启用Gzip压缩

## 📊 监控和运维

### 健康检查

```bash
# 检查所有服务健康状态
curl http://localhost:3002/api/v1/health
curl http://localhost:9522/api/v1/health
```

### 性能监控

访问性能指标端点：
- http://localhost:3002/api/v1/health/metrics
- http://localhost:3002/api/v1/health/detailed

### 备份策略

#### 数据库备份
```bash
# 创建数据库备份
docker exec -t soybean-postgres pg_dumpall -c -U soybean > backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复数据库
docker exec -i soybean-postgres psql -U soybean < backup_20250822_225800.sql
```

#### 代码备份
```bash
# 创建项目备份
tar -czf lowcode-platform-backup-$(date +%Y%m%d).tar.gz \
  --exclude=node_modules \
  --exclude=.git \
  --exclude=dist \
  .
```

## 🚀 生产部署

### 环境配置

#### 生产环境变量
```bash
# 应用配置
NODE_ENV=production
PORT=3000
API_PREFIX=api/v1

# 数据库配置
DATABASE_URL=postgresql://username:password@localhost:5432/production_db

# JWT配置
JWT_SECRET=your-super-secure-production-secret
JWT_EXPIRES_IN=7d

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379

# 日志配置
LOG_LEVEL=warn
LOG_FORMAT=json
```

#### Docker部署
```bash
# 构建生产镜像
docker build -t lowcode-platform:latest .

# 使用docker-compose部署
docker-compose -f docker-compose.prod.yml up -d
```

#### Kubernetes部署
```yaml
# kubernetes deployment配置示例
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lowcode-platform
spec:
  replicas: 3
  selector:
    matchLabels:
      app: lowcode-platform
  template:
    metadata:
      labels:
        app: lowcode-platform
    spec:
      containers:
      - name: lowcode-platform
        image: lowcode-platform:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: database-secret
              key: url
```

### 反向代理配置

#### Nginx配置
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location /api/ {
        proxy_pass http://localhost:3002/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        proxy_pass http://localhost:5173/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 📚 扩展开发

### 自定义模板

#### 创建模板
1. 在数据库中添加新的代码模板
2. 使用Handlebars语法编写模板
3. 定义模板变量和约束

#### 模板示例
```handlebars
// {{entityName}}.controller.ts
import { Controller, Get, Post, Put, Delete } from '@nestjs/common';
import { {{pascalCase entityName}}Service } from './{{kebabCase entityName}}.service';

@Controller('{{kebabCase entityName}}')
export class {{pascalCase entityName}}Controller {
  constructor(
    private readonly {{camelCase entityName}}Service: {{pascalCase entityName}}Service
  ) {}

  @Get()
  findAll() {
    return this.{{camelCase entityName}}Service.findAll();
  }
  
  // 其他CRUD操作...
}
```

### 插件开发

#### 前端插件
```typescript
// 自定义组件插件
export interface LowcodePlugin {
  name: string;
  version: string;
  components: ComponentDefinition[];
  actions: ActionDefinition[];
}
```

#### 后端扩展
```typescript
// 自定义代码生成器
@Injectable()
export class CustomCodeGenerator implements CodeGenerator {
  async generate(context: GenerationContext): Promise<GeneratedCode> {
    // 实现自定义生成逻辑
  }
}
```

## 🤝 贡献指南

### 开发流程
1. Fork项目
2. 创建功能分支
3. 提交代码变更
4. 创建Pull Request

### 代码规范
- 使用ESLint + Prettier
- 遵循TypeScript严格模式
- 编写单元测试
- 添加API文档

### 测试要求
- 单元测试覆盖率 > 80%
- 集成测试通过
- E2E测试验证

## 📞 技术支持

### 联系方式
- GitHub Issues: 报告问题和功能请求
- 邮箱: support@example.com
- 文档: 查看在线文档

### 社区资源
- 技术博客: 最佳实践和使用技巧
- 视频教程: 上手指南和高级用法
- 示例项目: 完整的应用示例

---

**版本**: v1.0.0  
**更新时间**: 2025年8月22日  
**维护团队**: SoybeanAdmin开发团队

🎉 祝您使用愉快！如有问题，请随时联系我们。