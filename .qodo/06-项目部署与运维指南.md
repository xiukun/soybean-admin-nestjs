# SoybeanAdmin NestJS 项目部署与运维指南

## 🚀 部署方案概览

### 部署架构选择

| 部署方案 | 适用场景 | 复杂度 | 可扩展性 |
|---------|----------|--------|----------|
| **Docker Compose** | 开发测试、小型生产 | 低 | 中 |
| **Docker Swarm** | 中型生产环境 | 中 | 高 |
| **Kubernetes** | 大型生产环境 | 高 | 极高 |
| **云服务平台** | 快速上线、托管服务 | 低 | 高 |

## 🐳 Docker Compose 快速部署

### 一键启动
```bash
# 克隆项目
git clone https://github.com/soybeanjs/soybean-admin-nestjs.git
cd soybean-admin-nestjs

# 一键启动所有服务
./start-services.sh

# 或手动启动
docker-compose up --build -d
```

### 核心服务配置
```yaml
# docker-compose.yml 核心配置
version: '3.8'

services:
  # 前端管理系统
  frontend:
    build: ./frontend
    ports: ["9527:80"]
    depends_on: [backend, lowcode-platform, amis-backend]

  # 低代码设计器
  lowcode-designer:
    build: 
      context: .
      dockerfile: lowcode-designer/Dockerfile
    ports: ["9555:80"]

  # 主后端服务
  backend:
    build: ./backend
    ports: ["9528:9528"]
    environment:
      NODE_ENV: production
      DATABASE_URL: 'postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=backend'
      REDIS_HOST: 'redis'
      JWT_SECRET: 'JWT_SECRET-soybean-admin-nest!@#123.'
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }

  # 低代码平台服务
  lowcode-platform:
    build: ./lowcode-platform-backend
    ports: ["3002:3002"]
    environment:
      DATABASE_URL: 'postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=lowcode'

  # 动态业务运行时
  amis-backend:
    build: ./amis-lowcode-backend
    ports: ["9522:9522"]
    environment:
      DATABASE_URL: 'postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=amis'

  # PostgreSQL 数据库
  postgres:
    image: postgres:16.3
    ports: ["25432:5432"]
    environment:
      POSTGRES_PASSWORD: 'soybean@123.'
      POSTGRES_USER: soybean
      POSTGRES_DB: soybean-admin-nest-backend
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./deploy/postgres:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U soybean"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis/redis-stack:7.2.0
    ports: ["26379:6379"]
    command: redis-server --requirepass 123456 --maxmemory 256mb
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "123456", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  redis_data:

networks:
  soybean-admin:
    driver: bridge
```

### 环境配置管理
```bash
# .env 环境配置文件
# 数据库配置
DATABASE_URL="postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=backend"

# Redis配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=123456

# JWT配置
JWT_SECRET="JWT_SECRET-soybean-admin-nest!@#123."
JWT_EXPIRE_IN=3600

# 应用配置
NODE_ENV=production
APP_PORT=9528
DOC_SWAGGER_ENABLE=true

# CORS配置
CORS_ENABLED=true
CORS_ORIGIN="http://localhost:9527,http://127.0.0.1:9527"

# 服务间通信配置
LOWCODE_PLATFORM_URL=http://lowcode-platform:3002
AMIS_BACKEND_URL=http://amis-backend:9522
```

## 🔧 生产环境部署

### Nginx 反向代理配置
```nginx
# nginx.conf 核心配置
upstream backend_service {
    least_conn;
    server backend1:9528 max_fails=3 fail_timeout=30s;
    server backend2:9528 max_fails=3 fail_timeout=30s;
}

upstream lowcode_platform_service {
    least_conn;
    server lowcode-platform1:3002 max_fails=3 fail_timeout=30s;
    server lowcode-platform2:3002 max_fails=3 fail_timeout=30s;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL配置
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # 主后端API
    location /api/v1/ {
        proxy_pass http://backend_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 低代码平台API
    location /lowcode/api/v1/ {
        rewrite ^/lowcode/api/v1/(.*) /api/v1/$1 break;
        proxy_pass http://lowcode_platform_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 静态资源
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
        
        # 缓存策略
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### Docker Swarm 集群部署
```yaml
# docker-compose.swarm.yml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports: ["80:80", "443:443"]
    deploy:
      replicas: 2
      placement:
        constraints: [node.role == manager]

  backend:
    image: soybean-admin-backend:latest
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://soybean:password@postgres:5432/soybean-admin-nest-backend?schema=backend
    deploy:
      replicas: 3
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  postgres:
    image: postgres:16.3
    environment:
      POSTGRES_DB: soybean-admin-nest-backend
      POSTGRES_USER: soybean
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      replicas: 1
      placement:
        constraints: [node.role == manager]

networks:
  soybean-network:
    driver: overlay

volumes:
  postgres_data:
```

#### Swarm 部署命令
```bash
# 初始化Swarm集群
docker swarm init

# 部署服务栈
docker stack deploy -c docker-compose.swarm.yml soybean-admin

# 查看服务状态
docker stack services soybean-admin

# 扩缩容服务
docker service scale soybean-admin_backend=5

# 更新服务
docker service update --image soybean-admin-backend:v2 soybean-admin_backend
```

## 🔍 监控与日志

### 应用监控 (Prometheus + Grafana)
```yaml
# monitoring/docker-compose.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    ports: ["9090:9090"]
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus

  grafana:
    image: grafana/grafana:latest
    ports: ["3000:3000"]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  prometheus_data:
  grafana_data:
```

### Prometheus 配置
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'backend'
    static_configs:
      - targets: ['backend:9528']
    metrics_path: '/metrics'

  - job_name: 'lowcode-platform'
    static_configs:
      - targets: ['lowcode-platform:3002']
    metrics_path: '/metrics'

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
```

### 日志管理 (ELK Stack)
```yaml
# logging/docker-compose.yml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports: ["9200:9200"]

  kibana:
    image: docker.elastic.co/kibana/kibana:8.8.0
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports: ["5601:5601"]

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.8.0
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
```

## 🛡️ 安全配置

### SSL/TLS 配置
```bash
# Let's Encrypt 自动证书
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

### 防火墙配置
```bash
# UFW 防火墙规则
sudo ufw enable

# 允许基础端口
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS

# 允许应用端口（仅内网）
sudo ufw allow from 10.0.0.0/8 to any port 9528
sudo ufw allow from 10.0.0.0/8 to any port 3002
sudo ufw allow from 10.0.0.0/8 to any port 25432
```

### 备份策略
```bash
#!/bin/bash
# backup-database.sh

BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="soybean-admin-nest-backend"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 全量备份
PGPASSWORD='soybean@123.' pg_dump \
  -h localhost \
  -p 25432 \
  -U soybean \
  -d $DB_NAME \
  --format=custom \
  --compress=9 \
  --file=$BACKUP_DIR/backup_${DATE}.dump

# 删除7天前的备份
find $BACKUP_DIR -name "backup_*.dump" -mtime +7 -delete

echo "数据库备份完成: backup_${DATE}.dump"
```

### 自动化备份任务
```bash
# 添加到crontab
sudo crontab -e

# 每天凌晨2点执行备份
0 2 * * * /path/to/backup-database.sh

# 每周日执行完整系统备份
0 3 * * 0 /path/to/full-backup.sh
```

## 📊 性能调优

### 数据库优化
```sql
-- PostgreSQL 性能配置
# postgresql.conf 关键参数
shared_buffers = 256MB              # 共享缓冲区
effective_cache_size = 1GB          # 有效缓存大小
work_mem = 4MB                      # 工作内存
maintenance_work_mem = 64MB         # 维护工作内存
max_connections = 200               # 最大连接数
checkpoint_completion_target = 0.9  # 检查点完成目标
```

### Redis 优化
```bash
# redis.conf 关键配置
maxmemory 512mb                     # 最大内存
maxmemory-policy allkeys-lru        # 内存淘汰策略
save 900 1                          # 持久化策略
save 300 10
save 60 10000
```

### 应用性能优化
```typescript
// NestJS 性能配置
@Module({
  imports: [
    // 连接池配置
    TypeOrmModule.forRoot({
      type: 'postgres',
      host: 'localhost',
      port: 5432,
      username: 'soybean',
      password: 'soybean@123.',
      database: 'soybean-admin-nest-backend',
      
      // 连接池配置
      poolSize: 20,                 // 连接池大小
      acquireTimeout: 60000,        // 获取连接超时
      timeout: 60000,               // 查询超时
      
      // 缓存配置
      cache: {
        type: 'redis',
        options: {
          host: 'localhost',
          port: 6379,
          password: '123456'
        }
      }
    }),
    
    // 缓存模块配置
    CacheModule.register({
      ttl: 300,                     // 5分钟TTL
      max: 1000,                    // 最大缓存条目
      isGlobal: true
    })
  ]
})
export class AppModule {}
```

## 🚨 故障排除

### 常见问题诊断
```bash
# 服务状态检查
docker-compose ps
docker-compose logs service-name

# 资源使用检查
docker stats
df -h
free -h

# 网络连接检查
netstat -tulpn
ss -tulpn

# 应用日志检查
tail -f /var/log/nginx/error.log
docker logs -f container-name
```

### 性能监控脚本
```bash
#!/bin/bash
# performance-monitor.sh

echo "=== 系统资源使用情况 ==="
echo "CPU使用率:"
top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1

echo "内存使用率:"
free | grep Mem | awk '{printf("%.2f%%\n", $3/$2 * 100.0)}'

echo "磁盘使用率:"
df -h | grep -vE '^Filesystem|tmpfs|cdrom' | awk '{print $5 " " $1}'

echo "=== 数据库连接数 ==="
PGPASSWORD='soybean@123.' psql -h localhost -p 25432 -U soybean -d soybean-admin-nest-backend -c "SELECT count(*) FROM pg_stat_activity;"

echo "=== Redis内存使用 ==="
redis-cli -h localhost -p 26379 -a 123456 info memory | grep used_memory_human

echo "=== Docker容器状态 ==="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

### 自动化运维脚本
```bash
#!/bin/bash
# auto-ops.sh

# 清理Docker资源
cleanup_docker() {
    docker system prune -f
    docker volume prune -f
    docker image prune -f
}

# 重启服务
restart_services() {
    docker-compose restart
}

# 健康检查
health_check() {
    services=("backend:9528" "lowcode-platform:3002" "postgres:25432")
    
    for service in "${services[@]}"; do
        IFS=':' read -r name port <<< "$service"
        if nc -z localhost "$port"; then
            echo "✅ $name ($port) - 运行正常"
        else
            echo "❌ $name ($port) - 服务异常"
            # 可以在这里添加告警逻辑
        fi
    done
}

# 主执行逻辑
case "$1" in
    "cleanup")
        cleanup_docker
        ;;
    "restart")
        restart_services
        ;;
    "health")
        health_check
        ;;
    *)
        echo "用法: $0 {cleanup|restart|health}"
        exit 1
        ;;
esac
```

## 📋 运维检查清单

### 日常检查项目
- [ ] 服务状态检查 (docker-compose ps)
- [ ] 资源使用检查 (内存、CPU、磁盘)
- [ ] 日志错误检查
- [ ] 数据库连接数检查
- [ ] 备份任务执行状态
- [ ] SSL证书有效期检查

### 周期性维护
- [ ] 数据库性能分析
- [ ] 日志文件清理
- [ ] 系统更新检查
- [ ] 安全补丁更新
- [ ] 监控告警测试
- [ ] 灾难恢复演练

### 应急响应流程
1. **问题发现**: 监控告警或用户反馈
2. **快速评估**: 确定影响范围和严重程度
3. **临时修复**: 实施临时解决方案
4. **根因分析**: 分析问题根本原因
5. **永久修复**: 实施永久解决方案
6. **经验总结**: 记录问题和解决方案

这个运维指南提供了完整的部署、监控、安全和维护方案，确保SoybeanAdmin NestJS项目在生产环境中稳定可靠地运行。