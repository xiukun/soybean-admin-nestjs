# SoybeanAdmin NestJS é¡¹ç›®éƒ¨ç½²ä¸è¿ç»´æŒ‡å—

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆæ¦‚è§ˆ

### éƒ¨ç½²æ¶æ„é€‰æ‹©

| éƒ¨ç½²æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | å¯æ‰©å±•æ€§ |
|---------|----------|--------|----------|
| **Docker Compose** | å¼€å‘æµ‹è¯•ã€å°å‹ç”Ÿäº§ | ä½ | ä¸­ |
| **Docker Swarm** | ä¸­å‹ç”Ÿäº§ç¯å¢ƒ | ä¸­ | é«˜ |
| **Kubernetes** | å¤§å‹ç”Ÿäº§ç¯å¢ƒ | é«˜ | æé«˜ |
| **äº‘æœåŠ¡å¹³å°** | å¿«é€Ÿä¸Šçº¿ã€æ‰˜ç®¡æœåŠ¡ | ä½ | é«˜ |

## ğŸ³ Docker Compose å¿«é€Ÿéƒ¨ç½²

### ä¸€é”®å¯åŠ¨
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/soybeanjs/soybean-admin-nestjs.git
cd soybean-admin-nestjs

# ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start-services.sh

# æˆ–æ‰‹åŠ¨å¯åŠ¨
docker-compose up --build -d
```

### æ ¸å¿ƒæœåŠ¡é…ç½®
```yaml
# docker-compose.yml æ ¸å¿ƒé…ç½®
version: '3.8'

services:
  # å‰ç«¯ç®¡ç†ç³»ç»Ÿ
  frontend:
    build: ./frontend
    ports: ["9527:80"]
    depends_on: [backend, lowcode-platform, amis-backend]

  # ä½ä»£ç è®¾è®¡å™¨
  lowcode-designer:
    build: 
      context: .
      dockerfile: lowcode-designer/Dockerfile
    ports: ["9555:80"]

  # ä¸»åç«¯æœåŠ¡
  backend:
    build: ./backend
    ports: ["9528:9528"]
    environment:
      NODE_ENV: production
      DATABASE_URL: 'postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=backend'
      REDIS_HOST: 'redis'
      JWT_SECRET: 'JWT_SECRET-soybean-admin-nest!@#123.'
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }

  # ä½ä»£ç å¹³å°æœåŠ¡
  lowcode-platform:
    build: ./lowcode-platform-backend
    ports: ["3002:3002"]
    environment:
      DATABASE_URL: 'postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=lowcode'

  # åŠ¨æ€ä¸šåŠ¡è¿è¡Œæ—¶
  amis-backend:
    build: ./amis-lowcode-backend
    ports: ["9522:9522"]
    environment:
      DATABASE_URL: 'postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=amis'

  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:16.3
    ports: ["25432:5432"]
    environment:
      POSTGRES_PASSWORD: 'soybean@123.'
      POSTGRES_USER: soybean
      POSTGRES_DB: soybean-admin-nest-backend
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./deploy/postgres:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U soybean"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis ç¼“å­˜
  redis:
    image: redis/redis-stack:7.2.0
    ports: ["26379:6379"]
    command: redis-server --requirepass 123456 --maxmemory 256mb
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "123456", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  redis_data:

networks:
  soybean-admin:
    driver: bridge
```

### ç¯å¢ƒé…ç½®ç®¡ç†
```bash
# .env ç¯å¢ƒé…ç½®æ–‡ä»¶
# æ•°æ®åº“é…ç½®
DATABASE_URL="postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=backend"

# Redisé…ç½®
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=123456

# JWTé…ç½®
JWT_SECRET="JWT_SECRET-soybean-admin-nest!@#123."
JWT_EXPIRE_IN=3600

# åº”ç”¨é…ç½®
NODE_ENV=production
APP_PORT=9528
DOC_SWAGGER_ENABLE=true

# CORSé…ç½®
CORS_ENABLED=true
CORS_ORIGIN="http://localhost:9527,http://127.0.0.1:9527"

# æœåŠ¡é—´é€šä¿¡é…ç½®
LOWCODE_PLATFORM_URL=http://lowcode-platform:3002
AMIS_BACKEND_URL=http://amis-backend:9522
```

## ğŸ”§ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### Nginx åå‘ä»£ç†é…ç½®
```nginx
# nginx.conf æ ¸å¿ƒé…ç½®
upstream backend_service {
    least_conn;
    server backend1:9528 max_fails=3 fail_timeout=30s;
    server backend2:9528 max_fails=3 fail_timeout=30s;
}

upstream lowcode_platform_service {
    least_conn;
    server lowcode-platform1:3002 max_fails=3 fail_timeout=30s;
    server lowcode-platform2:3002 max_fails=3 fail_timeout=30s;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSLé…ç½®
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # ä¸»åç«¯API
    location /api/v1/ {
        proxy_pass http://backend_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ä½ä»£ç å¹³å°API
    location /lowcode/api/v1/ {
        rewrite ^/lowcode/api/v1/(.*) /api/v1/$1 break;
        proxy_pass http://lowcode_platform_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # é™æ€èµ„æº
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜ç­–ç•¥
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### Docker Swarm é›†ç¾¤éƒ¨ç½²
```yaml
# docker-compose.swarm.yml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports: ["80:80", "443:443"]
    deploy:
      replicas: 2
      placement:
        constraints: [node.role == manager]

  backend:
    image: soybean-admin-backend:latest
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://soybean:password@postgres:5432/soybean-admin-nest-backend?schema=backend
    deploy:
      replicas: 3
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  postgres:
    image: postgres:16.3
    environment:
      POSTGRES_DB: soybean-admin-nest-backend
      POSTGRES_USER: soybean
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      replicas: 1
      placement:
        constraints: [node.role == manager]

networks:
  soybean-network:
    driver: overlay

volumes:
  postgres_data:
```

#### Swarm éƒ¨ç½²å‘½ä»¤
```bash
# åˆå§‹åŒ–Swarmé›†ç¾¤
docker swarm init

# éƒ¨ç½²æœåŠ¡æ ˆ
docker stack deploy -c docker-compose.swarm.yml soybean-admin

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker stack services soybean-admin

# æ‰©ç¼©å®¹æœåŠ¡
docker service scale soybean-admin_backend=5

# æ›´æ–°æœåŠ¡
docker service update --image soybean-admin-backend:v2 soybean-admin_backend
```

## ğŸ” ç›‘æ§ä¸æ—¥å¿—

### åº”ç”¨ç›‘æ§ (Prometheus + Grafana)
```yaml
# monitoring/docker-compose.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    ports: ["9090:9090"]
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus

  grafana:
    image: grafana/grafana:latest
    ports: ["3000:3000"]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  prometheus_data:
  grafana_data:
```

### Prometheus é…ç½®
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'backend'
    static_configs:
      - targets: ['backend:9528']
    metrics_path: '/metrics'

  - job_name: 'lowcode-platform'
    static_configs:
      - targets: ['lowcode-platform:3002']
    metrics_path: '/metrics'

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
```

### æ—¥å¿—ç®¡ç† (ELK Stack)
```yaml
# logging/docker-compose.yml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports: ["9200:9200"]

  kibana:
    image: docker.elastic.co/kibana/kibana:8.8.0
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports: ["5601:5601"]

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.8.0
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### SSL/TLS é…ç½®
```bash
# Let's Encrypt è‡ªåŠ¨è¯ä¹¦
sudo apt-get install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ : 0 12 * * * /usr/bin/certbot renew --quiet
```

### é˜²ç«å¢™é…ç½®
```bash
# UFW é˜²ç«å¢™è§„åˆ™
sudo ufw enable

# å…è®¸åŸºç¡€ç«¯å£
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS

# å…è®¸åº”ç”¨ç«¯å£ï¼ˆä»…å†…ç½‘ï¼‰
sudo ufw allow from 10.0.0.0/8 to any port 9528
sudo ufw allow from 10.0.0.0/8 to any port 3002
sudo ufw allow from 10.0.0.0/8 to any port 25432
```

### å¤‡ä»½ç­–ç•¥
```bash
#!/bin/bash
# backup-database.sh

BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="soybean-admin-nest-backend"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
PGPASSWORD='soybean@123.' pg_dump \
  -h localhost \
  -p 25432 \
  -U soybean \
  -d $DB_NAME \
  --format=custom \
  --compress=9 \
  --file=$BACKUP_DIR/backup_${DATE}.dump

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.dump" -mtime +7 -delete

echo "æ•°æ®åº“å¤‡ä»½å®Œæˆ: backup_${DATE}.dump"
```

### è‡ªåŠ¨åŒ–å¤‡ä»½ä»»åŠ¡
```bash
# æ·»åŠ åˆ°crontab
sudo crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½
0 2 * * * /path/to/backup-database.sh

# æ¯å‘¨æ—¥æ‰§è¡Œå®Œæ•´ç³»ç»Ÿå¤‡ä»½
0 3 * * 0 /path/to/full-backup.sh
```

## ğŸ“Š æ€§èƒ½è°ƒä¼˜

### æ•°æ®åº“ä¼˜åŒ–
```sql
-- PostgreSQL æ€§èƒ½é…ç½®
# postgresql.conf å…³é”®å‚æ•°
shared_buffers = 256MB              # å…±äº«ç¼“å†²åŒº
effective_cache_size = 1GB          # æœ‰æ•ˆç¼“å­˜å¤§å°
work_mem = 4MB                      # å·¥ä½œå†…å­˜
maintenance_work_mem = 64MB         # ç»´æŠ¤å·¥ä½œå†…å­˜
max_connections = 200               # æœ€å¤§è¿æ¥æ•°
checkpoint_completion_target = 0.9  # æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
```

### Redis ä¼˜åŒ–
```bash
# redis.conf å…³é”®é…ç½®
maxmemory 512mb                     # æœ€å¤§å†…å­˜
maxmemory-policy allkeys-lru        # å†…å­˜æ·˜æ±°ç­–ç•¥
save 900 1                          # æŒä¹…åŒ–ç­–ç•¥
save 300 10
save 60 10000
```

### åº”ç”¨æ€§èƒ½ä¼˜åŒ–
```typescript
// NestJS æ€§èƒ½é…ç½®
@Module({
  imports: [
    // è¿æ¥æ± é…ç½®
    TypeOrmModule.forRoot({
      type: 'postgres',
      host: 'localhost',
      port: 5432,
      username: 'soybean',
      password: 'soybean@123.',
      database: 'soybean-admin-nest-backend',
      
      // è¿æ¥æ± é…ç½®
      poolSize: 20,                 // è¿æ¥æ± å¤§å°
      acquireTimeout: 60000,        // è·å–è¿æ¥è¶…æ—¶
      timeout: 60000,               // æŸ¥è¯¢è¶…æ—¶
      
      // ç¼“å­˜é…ç½®
      cache: {
        type: 'redis',
        options: {
          host: 'localhost',
          port: 6379,
          password: '123456'
        }
      }
    }),
    
    // ç¼“å­˜æ¨¡å—é…ç½®
    CacheModule.register({
      ttl: 300,                     // 5åˆ†é’ŸTTL
      max: 1000,                    // æœ€å¤§ç¼“å­˜æ¡ç›®
      isGlobal: true
    })
  ]
})
export class AppModule {}
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è¯Šæ–­
```bash
# æœåŠ¡çŠ¶æ€æ£€æŸ¥
docker-compose ps
docker-compose logs service-name

# èµ„æºä½¿ç”¨æ£€æŸ¥
docker stats
df -h
free -h

# ç½‘ç»œè¿æ¥æ£€æŸ¥
netstat -tulpn
ss -tulpn

# åº”ç”¨æ—¥å¿—æ£€æŸ¥
tail -f /var/log/nginx/error.log
docker logs -f container-name
```

### æ€§èƒ½ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# performance-monitor.sh

echo "=== ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ ==="
echo "CPUä½¿ç”¨ç‡:"
top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1

echo "å†…å­˜ä½¿ç”¨ç‡:"
free | grep Mem | awk '{printf("%.2f%%\n", $3/$2 * 100.0)}'

echo "ç£ç›˜ä½¿ç”¨ç‡:"
df -h | grep -vE '^Filesystem|tmpfs|cdrom' | awk '{print $5 " " $1}'

echo "=== æ•°æ®åº“è¿æ¥æ•° ==="
PGPASSWORD='soybean@123.' psql -h localhost -p 25432 -U soybean -d soybean-admin-nest-backend -c "SELECT count(*) FROM pg_stat_activity;"

echo "=== Rediså†…å­˜ä½¿ç”¨ ==="
redis-cli -h localhost -p 26379 -a 123456 info memory | grep used_memory_human

echo "=== Dockerå®¹å™¨çŠ¶æ€ ==="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

### è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬
```bash
#!/bin/bash
# auto-ops.sh

# æ¸…ç†Dockerèµ„æº
cleanup_docker() {
    docker system prune -f
    docker volume prune -f
    docker image prune -f
}

# é‡å¯æœåŠ¡
restart_services() {
    docker-compose restart
}

# å¥åº·æ£€æŸ¥
health_check() {
    services=("backend:9528" "lowcode-platform:3002" "postgres:25432")
    
    for service in "${services[@]}"; do
        IFS=':' read -r name port <<< "$service"
        if nc -z localhost "$port"; then
            echo "âœ… $name ($port) - è¿è¡Œæ­£å¸¸"
        else
            echo "âŒ $name ($port) - æœåŠ¡å¼‚å¸¸"
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘Šè­¦é€»è¾‘
        fi
    done
}

# ä¸»æ‰§è¡Œé€»è¾‘
case "$1" in
    "cleanup")
        cleanup_docker
        ;;
    "restart")
        restart_services
        ;;
    "health")
        health_check
        ;;
    *)
        echo "ç”¨æ³•: $0 {cleanup|restart|health}"
        exit 1
        ;;
esac
```

## ğŸ“‹ è¿ç»´æ£€æŸ¥æ¸…å•

### æ—¥å¸¸æ£€æŸ¥é¡¹ç›®
- [ ] æœåŠ¡çŠ¶æ€æ£€æŸ¥ (docker-compose ps)
- [ ] èµ„æºä½¿ç”¨æ£€æŸ¥ (å†…å­˜ã€CPUã€ç£ç›˜)
- [ ] æ—¥å¿—é”™è¯¯æ£€æŸ¥
- [ ] æ•°æ®åº“è¿æ¥æ•°æ£€æŸ¥
- [ ] å¤‡ä»½ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
- [ ] SSLè¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥

### å‘¨æœŸæ€§ç»´æŠ¤
- [ ] æ•°æ®åº“æ€§èƒ½åˆ†æ
- [ ] æ—¥å¿—æ–‡ä»¶æ¸…ç†
- [ ] ç³»ç»Ÿæ›´æ–°æ£€æŸ¥
- [ ] å®‰å…¨è¡¥ä¸æ›´æ–°
- [ ] ç›‘æ§å‘Šè­¦æµ‹è¯•
- [ ] ç¾éš¾æ¢å¤æ¼”ç»ƒ

### åº”æ€¥å“åº”æµç¨‹
1. **é—®é¢˜å‘ç°**: ç›‘æ§å‘Šè­¦æˆ–ç”¨æˆ·åé¦ˆ
2. **å¿«é€Ÿè¯„ä¼°**: ç¡®å®šå½±å“èŒƒå›´å’Œä¸¥é‡ç¨‹åº¦
3. **ä¸´æ—¶ä¿®å¤**: å®æ–½ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
4. **æ ¹å› åˆ†æ**: åˆ†æé—®é¢˜æ ¹æœ¬åŸå› 
5. **æ°¸ä¹…ä¿®å¤**: å®æ–½æ°¸ä¹…è§£å†³æ–¹æ¡ˆ
6. **ç»éªŒæ€»ç»“**: è®°å½•é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

è¿™ä¸ªè¿ç»´æŒ‡å—æä¾›äº†å®Œæ•´çš„éƒ¨ç½²ã€ç›‘æ§ã€å®‰å…¨å’Œç»´æŠ¤æ–¹æ¡ˆï¼Œç¡®ä¿SoybeanAdmin NestJSé¡¹ç›®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¨³å®šå¯é åœ°è¿è¡Œã€‚