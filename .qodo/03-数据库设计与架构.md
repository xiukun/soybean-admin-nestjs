# SoybeanAdmin NestJS 数据库设计与架构

## 🗄️ 数据库架构概览

### 多Schema架构设计

SoybeanAdmin NestJS 采用 PostgreSQL 的多Schema架构，实现业务逻辑的清晰分离：

```sql
-- 数据库: soybean-admin-nest-backend
├── 📊 Schema: backend        # 主业务系统数据
├── 🔧 Schema: lowcode       # 低代码平台数据  
└── 🎯 Schema: amis          # 动态生成业务数据
```

### 设计原则
1. **领域分离**: 按业务领域划分Schema
2. **数据隔离**: 不同业务数据物理隔离
3. **扩展性**: 易于添加新的业务域
4. **安全性**: 细粒度的访问控制

## 📊 Backend Schema 核心表设计

### 用户权限管理

```sql
-- 系统用户表
CREATE TABLE backend.sys_user (
  id            VARCHAR(36) PRIMARY KEY,           -- 用户ID (ULID)
  username      VARCHAR(50) UNIQUE NOT NULL,       -- 用户名
  password      VARCHAR(255) NOT NULL,             -- 密码哈希
  domain        VARCHAR(50) NOT NULL,              -- 所属域
  email         VARCHAR(100) UNIQUE,               -- 邮箱
  phone_number  VARCHAR(20) UNIQUE,                -- 手机号
  nick_name     VARCHAR(50) NOT NULL,              -- 昵称
  status        VARCHAR(20) DEFAULT 'ENABLED',     -- 状态
  tenant_id     VARCHAR(36),                       -- 租户ID
  created_at    TIMESTAMP DEFAULT NOW(),
  created_by    VARCHAR(36) NOT NULL,
  updated_at    TIMESTAMP DEFAULT NOW(),
  updated_by    VARCHAR(36)
);

-- 角色表
CREATE TABLE backend.sys_role (
  id            VARCHAR(36) PRIMARY KEY,
  code          VARCHAR(50) UNIQUE NOT NULL,
  name          VARCHAR(100) NOT NULL,
  description   TEXT,
  pid           VARCHAR(36) DEFAULT '0',           -- 支持角色层级
  status        VARCHAR(20) DEFAULT 'ENABLED',
  created_at    TIMESTAMP DEFAULT NOW(),
  created_by    VARCHAR(36) NOT NULL
);

-- 用户角色关联表
CREATE TABLE backend.sys_user_role (
  user_id       VARCHAR(36) NOT NULL,
  role_id       VARCHAR(36) NOT NULL,
  PRIMARY KEY (user_id, role_id)
);

-- 菜单权限表
CREATE TABLE backend.sys_menu (
  id            SERIAL PRIMARY KEY,
  menu_type     VARCHAR(20) NOT NULL,              -- directory/menu/lowcode
  menu_name     VARCHAR(64) NOT NULL,
  route_name    VARCHAR(64) UNIQUE NOT NULL,
  route_path    VARCHAR(128) NOT NULL,
  component     VARCHAR(64) NOT NULL,
  status        VARCHAR(20) DEFAULT 'ENABLED',
  pid           INTEGER DEFAULT 0,
  sequence      INTEGER NOT NULL,                  -- 排序
  lowcode_page_id VARCHAR(36),                     -- 低代码页面关联
  created_at    TIMESTAMP DEFAULT NOW()
);

-- Casbin权限规则表
CREATE TABLE backend.casbin_rule (
  id            SERIAL PRIMARY KEY,
  ptype         VARCHAR(255) NOT NULL,             -- 策略类型
  v0            VARCHAR(255),                      -- 主体
  v1            VARCHAR(255),                      -- 资源
  v2            VARCHAR(255),                      -- 动作
  v3            VARCHAR(255)                       -- 效果
);
```

### 多租户架构

```sql
-- 企业表
CREATE TABLE backend.enterprise (
  id            VARCHAR(36) PRIMARY KEY,
  name          VARCHAR(100) UNIQUE NOT NULL,
  description   TEXT,
  status        VARCHAR(20) DEFAULT 'ENABLED',
  created_at    TIMESTAMP DEFAULT NOW()
);

-- 租户表
CREATE TABLE backend.tenant (
  id            VARCHAR(36) PRIMARY KEY,
  name          VARCHAR(100) NOT NULL,
  enterprise_id VARCHAR(36) NOT NULL,
  plan_id       VARCHAR(36),
  status        VARCHAR(20) DEFAULT 'ENABLED',
  created_at    TIMESTAMP DEFAULT NOW(),
  UNIQUE(enterprise_id, name),
  FOREIGN KEY (enterprise_id) REFERENCES backend.enterprise(id)
);

-- 应用空间表
CREATE TABLE backend.app_space (
  id            VARCHAR(36) PRIMARY KEY,
  name          VARCHAR(100) NOT NULL,
  tenant_id     VARCHAR(36) NOT NULL,
  status        VARCHAR(20) DEFAULT 'ENABLED',
  created_at    TIMESTAMP DEFAULT NOW(),
  UNIQUE(tenant_id, name),
  FOREIGN KEY (tenant_id) REFERENCES backend.tenant(id)
);
```

### 审计日志系统

```sql
-- 登录日志表
CREATE TABLE backend.sys_login_log (
  id            VARCHAR(36) PRIMARY KEY,
  user_id       VARCHAR(36) NOT NULL,
  username      VARCHAR(50) NOT NULL,
  domain        VARCHAR(50) NOT NULL,
  login_time    TIMESTAMP DEFAULT NOW(),
  ip            VARCHAR(45) NOT NULL,              -- 支持IPv6
  address       VARCHAR(255) NOT NULL,             -- 地理位置
  user_agent    TEXT NOT NULL,
  request_id    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMP DEFAULT NOW()
);

-- 操作日志表（支持分区）
CREATE TABLE backend.sys_operation_log (
  id            VARCHAR(36) PRIMARY KEY,
  user_id       VARCHAR(36) NOT NULL,
  username      VARCHAR(50) NOT NULL,
  module_name   VARCHAR(100) NOT NULL,
  description   VARCHAR(500) NOT NULL,
  method        VARCHAR(10) NOT NULL,
  url           VARCHAR(500) NOT NULL,
  ip            VARCHAR(45) NOT NULL,
  params        JSONB,                             -- 请求参数
  response      JSONB,                             -- 响应数据
  start_time    TIMESTAMP NOT NULL,
  end_time      TIMESTAMP NOT NULL,
  duration      INTEGER NOT NULL,                  -- 耗时(毫秒)
  created_at    TIMESTAMP DEFAULT NOW()
) PARTITION BY RANGE (created_at);
```

## 🔧 Lowcode Schema 核心设计

### 项目管理

```sql
-- 低代码项目表
CREATE TABLE lowcode.lowcode_projects (
  id                VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name              VARCHAR(100) NOT NULL,
  code              VARCHAR(100) UNIQUE NOT NULL,
  description       TEXT,
  version           VARCHAR(20) DEFAULT '1.0.0',
  config            JSONB DEFAULT '{}',
  status            VARCHAR(20) DEFAULT 'ACTIVE',
  deployment_status VARCHAR(20) DEFAULT 'INACTIVE',
  deployment_port   INTEGER,
  deployment_config JSONB DEFAULT '{}',
  last_deployed_at  TIMESTAMP,
  created_by        VARCHAR(36) NOT NULL,
  created_at        TIMESTAMP DEFAULT NOW(),
  updated_at        TIMESTAMP DEFAULT NOW()
);
```

### 实体建模

```sql
-- 业务实体表
CREATE TABLE lowcode.lowcode_entities (
  id                VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id        VARCHAR(36) NOT NULL,
  name              VARCHAR(100) NOT NULL,
  code              VARCHAR(100) NOT NULL,
  table_name        VARCHAR(100) NOT NULL,
  description       TEXT,
  category          VARCHAR(50),
  diagram_position  JSONB,                          -- 图表位置
  config            JSONB DEFAULT '{}',
  status            VARCHAR(20) DEFAULT 'DRAFT',
  created_by        VARCHAR(36) NOT NULL,
  created_at        TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, code),
  UNIQUE(project_id, table_name),
  FOREIGN KEY (project_id) REFERENCES lowcode.lowcode_projects(id) ON DELETE CASCADE
);

-- 实体字段表
CREATE TABLE lowcode.lowcode_fields (
  id                VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  entity_id         VARCHAR(36) NOT NULL,
  name              VARCHAR(100) NOT NULL,
  code              VARCHAR(100) NOT NULL,
  type              VARCHAR(50) NOT NULL,           -- 字段类型
  length            INTEGER,
  nullable          BOOLEAN DEFAULT TRUE,
  unique_constraint BOOLEAN DEFAULT FALSE,
  primary_key       BOOLEAN DEFAULT FALSE,
  default_value     VARCHAR(255),
  validation_rules  JSONB,                          -- 验证规则
  enum_options      JSONB,                          -- 枚举选项
  sort_order        INTEGER DEFAULT 0,
  created_by        VARCHAR(36) NOT NULL,
  created_at        TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(entity_id, code),
  FOREIGN KEY (entity_id) REFERENCES lowcode.lowcode_entities(id) ON DELETE CASCADE
);

-- 实体关系表
CREATE TABLE lowcode.lowcode_relations (
  id                VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id        VARCHAR(36) NOT NULL,
  name              VARCHAR(100) NOT NULL,
  code              VARCHAR(100) NOT NULL,
  type              VARCHAR(50) NOT NULL,           -- oneToOne, oneToMany, manyToMany
  source_entity_id  VARCHAR(36) NOT NULL,
  target_entity_id  VARCHAR(36) NOT NULL,
  source_field_id   VARCHAR(36),
  target_field_id   VARCHAR(36),
  foreign_key_name  VARCHAR(100),
  join_table_config JSONB,                          -- 多对多连接表配置
  on_delete         VARCHAR(20) DEFAULT 'RESTRICT',
  on_update         VARCHAR(20) DEFAULT 'RESTRICT',
  status            VARCHAR(20) DEFAULT 'ACTIVE',
  created_by        VARCHAR(36) NOT NULL,
  created_at        TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, code),
  FOREIGN KEY (project_id) REFERENCES lowcode.lowcode_projects(id) ON DELETE CASCADE
);
```

### 代码生成系统

```sql
-- 代码模板表
CREATE TABLE lowcode.lowcode_code_templates (
  id            VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name          VARCHAR(100) NOT NULL,
  code          VARCHAR(100) UNIQUE NOT NULL,
  type          VARCHAR(50) NOT NULL,
  language      VARCHAR(20) NOT NULL,              -- typescript, javascript
  framework     VARCHAR(50) NOT NULL,              -- nestjs, express
  description   TEXT,
  content       TEXT DEFAULT '',                   -- 模板内容
  variables     JSONB DEFAULT '[]',                -- 模板变量定义
  version       VARCHAR(20) DEFAULT '1.0.0',
  status        VARCHAR(20) DEFAULT 'ACTIVE',
  category      VARCHAR(50) DEFAULT 'CONTROLLER',  -- 模板分类
  is_public     BOOLEAN DEFAULT FALSE,
  created_by    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMP DEFAULT NOW()
);

-- 代码生成任务表
CREATE TABLE lowcode.lowcode_codegen_tasks (
  id            VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id    VARCHAR(36) NOT NULL,
  name          VARCHAR(100) NOT NULL,
  type          VARCHAR(50) NOT NULL,              -- 任务类型
  config        JSONB DEFAULT '{}',
  status        VARCHAR(20) DEFAULT 'PENDING',     -- PENDING, RUNNING, SUCCESS, FAILED
  progress      INTEGER DEFAULT 0,                 -- 进度百分比
  result        JSONB,                             -- 生成结果
  error_msg     TEXT,                              -- 错误信息
  output_path   VARCHAR(500),                      -- 输出路径
  created_by    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMP DEFAULT NOW(),
  updated_at    TIMESTAMP DEFAULT NOW()
);
```

### API管理

```sql
-- API配置表
CREATE TABLE lowcode.lowcode_api_configs (
  id            VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id    VARCHAR(36) NOT NULL,
  name          VARCHAR(100) NOT NULL,
  code          VARCHAR(100) NOT NULL,
  method        VARCHAR(10) NOT NULL,              -- GET, POST, PUT, DELETE
  path          VARCHAR(500) NOT NULL,
  entity_id     VARCHAR(36),
  parameters    JSONB DEFAULT '[]',                -- 参数定义
  responses     JSONB DEFAULT '[]',                -- 响应定义
  security      JSONB DEFAULT '{"type": "none"}',  -- 安全配置
  status        VARCHAR(20) DEFAULT 'DRAFT',
  version       VARCHAR(20) DEFAULT '1.0.0',
  created_by    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, code),
  UNIQUE(project_id, method, path),
  FOREIGN KEY (project_id) REFERENCES lowcode.lowcode_projects(id) ON DELETE CASCADE
);

-- 查询构建器
CREATE TABLE lowcode.lowcode_queries (
  id                  VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id          VARCHAR(36) NOT NULL,
  name                VARCHAR(100) NOT NULL,
  base_entity_id      VARCHAR(36) NOT NULL,
  joins               JSONB DEFAULT '[]',           -- 连接配置
  fields              JSONB DEFAULT '[]',           -- 字段选择
  filters             JSONB DEFAULT '[]',           -- 过滤条件
  sorting             JSONB DEFAULT '[]',           -- 排序配置
  limit_count         INTEGER,
  sql_query           TEXT,                         -- 生成的SQL
  status              VARCHAR(20) DEFAULT 'DRAFT',
  created_by          VARCHAR(36) NOT NULL,
  created_at          TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, name),
  FOREIGN KEY (project_id) REFERENCES lowcode.lowcode_projects(id) ON DELETE CASCADE
);
```

## 🗄️ 数据库性能优化

### 索引策略

```sql
-- 用户相关索引
CREATE INDEX idx_sys_user_username ON backend.sys_user(username);
CREATE INDEX idx_sys_user_email ON backend.sys_user(email);
CREATE INDEX idx_sys_user_tenant ON backend.sys_user(tenant_id);
CREATE INDEX idx_sys_user_status ON backend.sys_user(status);

-- 日志相关索引
CREATE INDEX idx_login_log_user_time ON backend.sys_login_log(user_id, login_time);
CREATE INDEX idx_operation_log_user_time ON backend.sys_operation_log(user_id, created_at);

-- 低代码项目索引
CREATE INDEX idx_lowcode_entities_project_id ON lowcode.lowcode_entities(project_id);
CREATE INDEX idx_lowcode_fields_entity_id ON lowcode.lowcode_fields(entity_id);
CREATE INDEX idx_lowcode_relations_project_id ON lowcode.lowcode_relations(project_id);
```

### 分区策略

```sql
-- 操作日志按月分区
CREATE TABLE backend.sys_operation_log_y2024m01 
  PARTITION OF backend.sys_operation_log
  FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE backend.sys_operation_log_y2024m02 
  PARTITION OF backend.sys_operation_log
  FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

## 🔒 数据安全设计

### 行级安全策略

```sql
-- 租户数据隔离
ALTER TABLE backend.sys_user ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON backend.sys_user
  USING (tenant_id = current_setting('app.current_tenant_id')::VARCHAR);
```

### 数据审计

```sql
-- 审计触发器函数
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    NEW.updated_at = NOW();
    NEW.updated_by = current_setting('app.current_user_id')::VARCHAR;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 应用审计触发器
CREATE TRIGGER audit_sys_user_update
  BEFORE UPDATE ON backend.sys_user
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();
```

## 📊 数据库监控

### 性能监控视图

```sql
-- 活跃连接监控
CREATE VIEW monitor_active_connections AS
SELECT 
  datname,
  usename,
  client_addr,
  state,
  query_start,
  now() - query_start as duration,
  query
FROM pg_stat_activity 
WHERE state = 'active';

-- 表大小监控
CREATE VIEW monitor_table_sizes AS
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
  pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables 
ORDER BY size_bytes DESC;
```

这个数据库设计充分考虑了多租户、可扩展性、性能优化和数据安全等企业级需求，为整个低代码平台提供了坚实的数据基础。