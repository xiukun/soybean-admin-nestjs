# SoybeanAdmin NestJS æ•°æ®åº“è®¾è®¡ä¸æ¶æ„

## ğŸ—„ï¸ æ•°æ®åº“æ¶æ„æ¦‚è§ˆ

### å¤šSchemaæ¶æ„è®¾è®¡

SoybeanAdmin NestJS é‡‡ç”¨ PostgreSQL çš„å¤šSchemaæ¶æ„ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘çš„æ¸…æ™°åˆ†ç¦»ï¼š

```sql
-- æ•°æ®åº“: soybean-admin-nest-backend
â”œâ”€â”€ ğŸ“Š Schema: backend        # ä¸»ä¸šåŠ¡ç³»ç»Ÿæ•°æ®
â”œâ”€â”€ ğŸ”§ Schema: lowcode       # ä½ä»£ç å¹³å°æ•°æ®  
â””â”€â”€ ğŸ¯ Schema: amis          # åŠ¨æ€ç”Ÿæˆä¸šåŠ¡æ•°æ®
```

### è®¾è®¡åŸåˆ™
1. **é¢†åŸŸåˆ†ç¦»**: æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†Schema
2. **æ•°æ®éš”ç¦»**: ä¸åŒä¸šåŠ¡æ•°æ®ç‰©ç†éš”ç¦»
3. **æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„ä¸šåŠ¡åŸŸ
4. **å®‰å…¨æ€§**: ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶

## ğŸ“Š Backend Schema æ ¸å¿ƒè¡¨è®¾è®¡

### ç”¨æˆ·æƒé™ç®¡ç†

```sql
-- ç³»ç»Ÿç”¨æˆ·è¡¨
CREATE TABLE backend.sys_user (
  id            VARCHAR(36) PRIMARY KEY,           -- ç”¨æˆ·ID (ULID)
  username      VARCHAR(50) UNIQUE NOT NULL,       -- ç”¨æˆ·å
  password      VARCHAR(255) NOT NULL,             -- å¯†ç å“ˆå¸Œ
  domain        VARCHAR(50) NOT NULL,              -- æ‰€å±åŸŸ
  email         VARCHAR(100) UNIQUE,               -- é‚®ç®±
  phone_number  VARCHAR(20) UNIQUE,                -- æ‰‹æœºå·
  nick_name     VARCHAR(50) NOT NULL,              -- æ˜µç§°
  status        VARCHAR(20) DEFAULT 'ENABLED',     -- çŠ¶æ€
  tenant_id     VARCHAR(36),                       -- ç§Ÿæˆ·ID
  created_at    TIMESTAMP DEFAULT NOW(),
  created_by    VARCHAR(36) NOT NULL,
  updated_at    TIMESTAMP DEFAULT NOW(),
  updated_by    VARCHAR(36)
);

-- è§’è‰²è¡¨
CREATE TABLE backend.sys_role (
  id            VARCHAR(36) PRIMARY KEY,
  code          VARCHAR(50) UNIQUE NOT NULL,
  name          VARCHAR(100) NOT NULL,
  description   TEXT,
  pid           VARCHAR(36) DEFAULT '0',           -- æ”¯æŒè§’è‰²å±‚çº§
  status        VARCHAR(20) DEFAULT 'ENABLED',
  created_at    TIMESTAMP DEFAULT NOW(),
  created_by    VARCHAR(36) NOT NULL
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE backend.sys_user_role (
  user_id       VARCHAR(36) NOT NULL,
  role_id       VARCHAR(36) NOT NULL,
  PRIMARY KEY (user_id, role_id)
);

-- èœå•æƒé™è¡¨
CREATE TABLE backend.sys_menu (
  id            SERIAL PRIMARY KEY,
  menu_type     VARCHAR(20) NOT NULL,              -- directory/menu/lowcode
  menu_name     VARCHAR(64) NOT NULL,
  route_name    VARCHAR(64) UNIQUE NOT NULL,
  route_path    VARCHAR(128) NOT NULL,
  component     VARCHAR(64) NOT NULL,
  status        VARCHAR(20) DEFAULT 'ENABLED',
  pid           INTEGER DEFAULT 0,
  sequence      INTEGER NOT NULL,                  -- æ’åº
  lowcode_page_id VARCHAR(36),                     -- ä½ä»£ç é¡µé¢å…³è”
  created_at    TIMESTAMP DEFAULT NOW()
);

-- Casbinæƒé™è§„åˆ™è¡¨
CREATE TABLE backend.casbin_rule (
  id            SERIAL PRIMARY KEY,
  ptype         VARCHAR(255) NOT NULL,             -- ç­–ç•¥ç±»å‹
  v0            VARCHAR(255),                      -- ä¸»ä½“
  v1            VARCHAR(255),                      -- èµ„æº
  v2            VARCHAR(255),                      -- åŠ¨ä½œ
  v3            VARCHAR(255)                       -- æ•ˆæœ
);
```

### å¤šç§Ÿæˆ·æ¶æ„

```sql
-- ä¼ä¸šè¡¨
CREATE TABLE backend.enterprise (
  id            VARCHAR(36) PRIMARY KEY,
  name          VARCHAR(100) UNIQUE NOT NULL,
  description   TEXT,
  status        VARCHAR(20) DEFAULT 'ENABLED',
  created_at    TIMESTAMP DEFAULT NOW()
);

-- ç§Ÿæˆ·è¡¨
CREATE TABLE backend.tenant (
  id            VARCHAR(36) PRIMARY KEY,
  name          VARCHAR(100) NOT NULL,
  enterprise_id VARCHAR(36) NOT NULL,
  plan_id       VARCHAR(36),
  status        VARCHAR(20) DEFAULT 'ENABLED',
  created_at    TIMESTAMP DEFAULT NOW(),
  UNIQUE(enterprise_id, name),
  FOREIGN KEY (enterprise_id) REFERENCES backend.enterprise(id)
);

-- åº”ç”¨ç©ºé—´è¡¨
CREATE TABLE backend.app_space (
  id            VARCHAR(36) PRIMARY KEY,
  name          VARCHAR(100) NOT NULL,
  tenant_id     VARCHAR(36) NOT NULL,
  status        VARCHAR(20) DEFAULT 'ENABLED',
  created_at    TIMESTAMP DEFAULT NOW(),
  UNIQUE(tenant_id, name),
  FOREIGN KEY (tenant_id) REFERENCES backend.tenant(id)
);
```

### å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

```sql
-- ç™»å½•æ—¥å¿—è¡¨
CREATE TABLE backend.sys_login_log (
  id            VARCHAR(36) PRIMARY KEY,
  user_id       VARCHAR(36) NOT NULL,
  username      VARCHAR(50) NOT NULL,
  domain        VARCHAR(50) NOT NULL,
  login_time    TIMESTAMP DEFAULT NOW(),
  ip            VARCHAR(45) NOT NULL,              -- æ”¯æŒIPv6
  address       VARCHAR(255) NOT NULL,             -- åœ°ç†ä½ç½®
  user_agent    TEXT NOT NULL,
  request_id    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMP DEFAULT NOW()
);

-- æ“ä½œæ—¥å¿—è¡¨ï¼ˆæ”¯æŒåˆ†åŒºï¼‰
CREATE TABLE backend.sys_operation_log (
  id            VARCHAR(36) PRIMARY KEY,
  user_id       VARCHAR(36) NOT NULL,
  username      VARCHAR(50) NOT NULL,
  module_name   VARCHAR(100) NOT NULL,
  description   VARCHAR(500) NOT NULL,
  method        VARCHAR(10) NOT NULL,
  url           VARCHAR(500) NOT NULL,
  ip            VARCHAR(45) NOT NULL,
  params        JSONB,                             -- è¯·æ±‚å‚æ•°
  response      JSONB,                             -- å“åº”æ•°æ®
  start_time    TIMESTAMP NOT NULL,
  end_time      TIMESTAMP NOT NULL,
  duration      INTEGER NOT NULL,                  -- è€—æ—¶(æ¯«ç§’)
  created_at    TIMESTAMP DEFAULT NOW()
) PARTITION BY RANGE (created_at);
```

## ğŸ”§ Lowcode Schema æ ¸å¿ƒè®¾è®¡

### é¡¹ç›®ç®¡ç†

```sql
-- ä½ä»£ç é¡¹ç›®è¡¨
CREATE TABLE lowcode.lowcode_projects (
  id                VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name              VARCHAR(100) NOT NULL,
  code              VARCHAR(100) UNIQUE NOT NULL,
  description       TEXT,
  version           VARCHAR(20) DEFAULT '1.0.0',
  config            JSONB DEFAULT '{}',
  status            VARCHAR(20) DEFAULT 'ACTIVE',
  deployment_status VARCHAR(20) DEFAULT 'INACTIVE',
  deployment_port   INTEGER,
  deployment_config JSONB DEFAULT '{}',
  last_deployed_at  TIMESTAMP,
  created_by        VARCHAR(36) NOT NULL,
  created_at        TIMESTAMP DEFAULT NOW(),
  updated_at        TIMESTAMP DEFAULT NOW()
);
```

### å®ä½“å»ºæ¨¡

```sql
-- ä¸šåŠ¡å®ä½“è¡¨
CREATE TABLE lowcode.lowcode_entities (
  id                VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id        VARCHAR(36) NOT NULL,
  name              VARCHAR(100) NOT NULL,
  code              VARCHAR(100) NOT NULL,
  table_name        VARCHAR(100) NOT NULL,
  description       TEXT,
  category          VARCHAR(50),
  diagram_position  JSONB,                          -- å›¾è¡¨ä½ç½®
  config            JSONB DEFAULT '{}',
  status            VARCHAR(20) DEFAULT 'DRAFT',
  created_by        VARCHAR(36) NOT NULL,
  created_at        TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, code),
  UNIQUE(project_id, table_name),
  FOREIGN KEY (project_id) REFERENCES lowcode.lowcode_projects(id) ON DELETE CASCADE
);

-- å®ä½“å­—æ®µè¡¨
CREATE TABLE lowcode.lowcode_fields (
  id                VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  entity_id         VARCHAR(36) NOT NULL,
  name              VARCHAR(100) NOT NULL,
  code              VARCHAR(100) NOT NULL,
  type              VARCHAR(50) NOT NULL,           -- å­—æ®µç±»å‹
  length            INTEGER,
  nullable          BOOLEAN DEFAULT TRUE,
  unique_constraint BOOLEAN DEFAULT FALSE,
  primary_key       BOOLEAN DEFAULT FALSE,
  default_value     VARCHAR(255),
  validation_rules  JSONB,                          -- éªŒè¯è§„åˆ™
  enum_options      JSONB,                          -- æšä¸¾é€‰é¡¹
  sort_order        INTEGER DEFAULT 0,
  created_by        VARCHAR(36) NOT NULL,
  created_at        TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(entity_id, code),
  FOREIGN KEY (entity_id) REFERENCES lowcode.lowcode_entities(id) ON DELETE CASCADE
);

-- å®ä½“å…³ç³»è¡¨
CREATE TABLE lowcode.lowcode_relations (
  id                VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id        VARCHAR(36) NOT NULL,
  name              VARCHAR(100) NOT NULL,
  code              VARCHAR(100) NOT NULL,
  type              VARCHAR(50) NOT NULL,           -- oneToOne, oneToMany, manyToMany
  source_entity_id  VARCHAR(36) NOT NULL,
  target_entity_id  VARCHAR(36) NOT NULL,
  source_field_id   VARCHAR(36),
  target_field_id   VARCHAR(36),
  foreign_key_name  VARCHAR(100),
  join_table_config JSONB,                          -- å¤šå¯¹å¤šè¿æ¥è¡¨é…ç½®
  on_delete         VARCHAR(20) DEFAULT 'RESTRICT',
  on_update         VARCHAR(20) DEFAULT 'RESTRICT',
  status            VARCHAR(20) DEFAULT 'ACTIVE',
  created_by        VARCHAR(36) NOT NULL,
  created_at        TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, code),
  FOREIGN KEY (project_id) REFERENCES lowcode.lowcode_projects(id) ON DELETE CASCADE
);
```

### ä»£ç ç”Ÿæˆç³»ç»Ÿ

```sql
-- ä»£ç æ¨¡æ¿è¡¨
CREATE TABLE lowcode.lowcode_code_templates (
  id            VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name          VARCHAR(100) NOT NULL,
  code          VARCHAR(100) UNIQUE NOT NULL,
  type          VARCHAR(50) NOT NULL,
  language      VARCHAR(20) NOT NULL,              -- typescript, javascript
  framework     VARCHAR(50) NOT NULL,              -- nestjs, express
  description   TEXT,
  content       TEXT DEFAULT '',                   -- æ¨¡æ¿å†…å®¹
  variables     JSONB DEFAULT '[]',                -- æ¨¡æ¿å˜é‡å®šä¹‰
  version       VARCHAR(20) DEFAULT '1.0.0',
  status        VARCHAR(20) DEFAULT 'ACTIVE',
  category      VARCHAR(50) DEFAULT 'CONTROLLER',  -- æ¨¡æ¿åˆ†ç±»
  is_public     BOOLEAN DEFAULT FALSE,
  created_by    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMP DEFAULT NOW()
);

-- ä»£ç ç”Ÿæˆä»»åŠ¡è¡¨
CREATE TABLE lowcode.lowcode_codegen_tasks (
  id            VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id    VARCHAR(36) NOT NULL,
  name          VARCHAR(100) NOT NULL,
  type          VARCHAR(50) NOT NULL,              -- ä»»åŠ¡ç±»å‹
  config        JSONB DEFAULT '{}',
  status        VARCHAR(20) DEFAULT 'PENDING',     -- PENDING, RUNNING, SUCCESS, FAILED
  progress      INTEGER DEFAULT 0,                 -- è¿›åº¦ç™¾åˆ†æ¯”
  result        JSONB,                             -- ç”Ÿæˆç»“æœ
  error_msg     TEXT,                              -- é”™è¯¯ä¿¡æ¯
  output_path   VARCHAR(500),                      -- è¾“å‡ºè·¯å¾„
  created_by    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMP DEFAULT NOW(),
  updated_at    TIMESTAMP DEFAULT NOW()
);
```

### APIç®¡ç†

```sql
-- APIé…ç½®è¡¨
CREATE TABLE lowcode.lowcode_api_configs (
  id            VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id    VARCHAR(36) NOT NULL,
  name          VARCHAR(100) NOT NULL,
  code          VARCHAR(100) NOT NULL,
  method        VARCHAR(10) NOT NULL,              -- GET, POST, PUT, DELETE
  path          VARCHAR(500) NOT NULL,
  entity_id     VARCHAR(36),
  parameters    JSONB DEFAULT '[]',                -- å‚æ•°å®šä¹‰
  responses     JSONB DEFAULT '[]',                -- å“åº”å®šä¹‰
  security      JSONB DEFAULT '{"type": "none"}',  -- å®‰å…¨é…ç½®
  status        VARCHAR(20) DEFAULT 'DRAFT',
  version       VARCHAR(20) DEFAULT '1.0.0',
  created_by    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, code),
  UNIQUE(project_id, method, path),
  FOREIGN KEY (project_id) REFERENCES lowcode.lowcode_projects(id) ON DELETE CASCADE
);

-- æŸ¥è¯¢æ„å»ºå™¨
CREATE TABLE lowcode.lowcode_queries (
  id                  VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id          VARCHAR(36) NOT NULL,
  name                VARCHAR(100) NOT NULL,
  base_entity_id      VARCHAR(36) NOT NULL,
  joins               JSONB DEFAULT '[]',           -- è¿æ¥é…ç½®
  fields              JSONB DEFAULT '[]',           -- å­—æ®µé€‰æ‹©
  filters             JSONB DEFAULT '[]',           -- è¿‡æ»¤æ¡ä»¶
  sorting             JSONB DEFAULT '[]',           -- æ’åºé…ç½®
  limit_count         INTEGER,
  sql_query           TEXT,                         -- ç”Ÿæˆçš„SQL
  status              VARCHAR(20) DEFAULT 'DRAFT',
  created_by          VARCHAR(36) NOT NULL,
  created_at          TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, name),
  FOREIGN KEY (project_id) REFERENCES lowcode.lowcode_projects(id) ON DELETE CASCADE
);
```

## ğŸ—„ï¸ æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ç­–ç•¥

```sql
-- ç”¨æˆ·ç›¸å…³ç´¢å¼•
CREATE INDEX idx_sys_user_username ON backend.sys_user(username);
CREATE INDEX idx_sys_user_email ON backend.sys_user(email);
CREATE INDEX idx_sys_user_tenant ON backend.sys_user(tenant_id);
CREATE INDEX idx_sys_user_status ON backend.sys_user(status);

-- æ—¥å¿—ç›¸å…³ç´¢å¼•
CREATE INDEX idx_login_log_user_time ON backend.sys_login_log(user_id, login_time);
CREATE INDEX idx_operation_log_user_time ON backend.sys_operation_log(user_id, created_at);

-- ä½ä»£ç é¡¹ç›®ç´¢å¼•
CREATE INDEX idx_lowcode_entities_project_id ON lowcode.lowcode_entities(project_id);
CREATE INDEX idx_lowcode_fields_entity_id ON lowcode.lowcode_fields(entity_id);
CREATE INDEX idx_lowcode_relations_project_id ON lowcode.lowcode_relations(project_id);
```

### åˆ†åŒºç­–ç•¥

```sql
-- æ“ä½œæ—¥å¿—æŒ‰æœˆåˆ†åŒº
CREATE TABLE backend.sys_operation_log_y2024m01 
  PARTITION OF backend.sys_operation_log
  FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE backend.sys_operation_log_y2024m02 
  PARTITION OF backend.sys_operation_log
  FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

## ğŸ”’ æ•°æ®å®‰å…¨è®¾è®¡

### è¡Œçº§å®‰å…¨ç­–ç•¥

```sql
-- ç§Ÿæˆ·æ•°æ®éš”ç¦»
ALTER TABLE backend.sys_user ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON backend.sys_user
  USING (tenant_id = current_setting('app.current_tenant_id')::VARCHAR);
```

### æ•°æ®å®¡è®¡

```sql
-- å®¡è®¡è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    NEW.updated_at = NOW();
    NEW.updated_by = current_setting('app.current_user_id')::VARCHAR;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åº”ç”¨å®¡è®¡è§¦å‘å™¨
CREATE TRIGGER audit_sys_user_update
  BEFORE UPDATE ON backend.sys_user
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();
```

## ğŸ“Š æ•°æ®åº“ç›‘æ§

### æ€§èƒ½ç›‘æ§è§†å›¾

```sql
-- æ´»è·ƒè¿æ¥ç›‘æ§
CREATE VIEW monitor_active_connections AS
SELECT 
  datname,
  usename,
  client_addr,
  state,
  query_start,
  now() - query_start as duration,
  query
FROM pg_stat_activity 
WHERE state = 'active';

-- è¡¨å¤§å°ç›‘æ§
CREATE VIEW monitor_table_sizes AS
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
  pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables 
ORDER BY size_bytes DESC;
```

è¿™ä¸ªæ•°æ®åº“è®¾è®¡å……åˆ†è€ƒè™‘äº†å¤šç§Ÿæˆ·ã€å¯æ‰©å±•æ€§ã€æ€§èƒ½ä¼˜åŒ–å’Œæ•°æ®å®‰å…¨ç­‰ä¼ä¸šçº§éœ€æ±‚ï¼Œä¸ºæ•´ä¸ªä½ä»£ç å¹³å°æä¾›äº†åšå®çš„æ•°æ®åŸºç¡€ã€‚