# 低代码平台测试验证方案

## 🎯 测试目标

确保低代码平台的完整功能闭环能够正常运行，从项目创建到代码生成、部署的端到端流程无缺陷，满足生产环境使用要求。

## 📋 测试策略

### 测试金字塔
```
    🔺 E2E Tests (端到端测试)
   🔺🔺 Integration Tests (集成测试)  
  🔺🔺🔺 Unit Tests (单元测试)
```

### 测试类型分布
- **单元测试**: 70% - 核心业务逻辑
- **集成测试**: 20% - 模块间协作
- **端到端测试**: 10% - 完整用户流程

## 🧪 详细测试方案

### 1. 单元测试 (Unit Tests)

#### 1.1 后端服务测试
**目标**: 测试各个服务的核心业务逻辑
**覆盖率要求**: > 80%

##### 项目管理服务测试
```typescript
// test/unit/project/project.service.spec.ts
describe('ProjectService', () => {
  describe('createProject', () => {
    it('should create project with valid configuration', async () => {
      const projectData = {
        name: '测试项目',
        code: 'test-project',
        framework: 'nestjs',
        database: 'postgresql'
      };
      
      const result = await projectService.create(projectData);
      
      expect(result).toBeDefined();
      expect(result.id).toBeTruthy();
      expect(result.name).toBe(projectData.name);
      expect(result.status).toBe('ACTIVE');
    });
    
    it('should throw error for duplicate project code', async () => {
      const projectData = { code: 'existing-project', name: '重复项目' };
      
      await expect(projectService.create(projectData))
        .rejects.toThrow('Project code already exists');
    });
    
    it('should validate project configuration', async () => {
      const invalidData = { name: '', code: 'invalid' };
      
      await expect(projectService.create(invalidData))
        .rejects.toThrow('Project name is required');
    });
  });
  
  describe('deployProject', () => {
    it('should deploy project successfully', async () => {
      const projectId = 'test-project-id';
      const deployConfig = { port: 9522, environment: 'development' };
      
      const result = await projectService.deploy(projectId, deployConfig);
      
      expect(result.status).toBe('DEPLOYING');
      expect(result.port).toBe(9522);
    });
  });
});
```

##### 实体管理服务测试
```typescript
// test/unit/entity/entity.service.spec.ts
describe('EntityService', () => {
  describe('createEntity', () => {
    it('should create entity with fields', async () => {
      const entityData = {
        projectId: 'test-project',
        name: '用户',
        code: 'User',
        tableName: 'users',
        fields: [
          { name: '姓名', code: 'name', type: 'STRING', nullable: false },
          { name: '邮箱', code: 'email', type: 'STRING', unique: true }
        ]
      };
      
      const result = await entityService.create(entityData);
      
      expect(result.fields).toHaveLength(2);
      expect(result.fields[0].code).toBe('name');
    });
    
    it('should validate entity table name uniqueness', async () => {
      const entityData = { tableName: 'existing_table', projectId: 'test' };
      
      await expect(entityService.create(entityData))
        .rejects.toThrow('Table name already exists');
    });
  });
  
  describe('generateMigration', () => {
    it('should generate DDL for entity', async () => {
      const entityId = 'test-entity-id';
      
      const migration = await entityService.generateMigration(entityId);
      
      expect(migration.sql).toContain('CREATE TABLE');
      expect(migration.sql).toContain('users');
    });
  });
});
```

##### 代码生成服务测试
```typescript
// test/unit/code-generation/code-generator.service.spec.ts
describe('CodeGeneratorService', () => {
  describe('generateCode', () => {
    it('should generate NestJS controller', async () => {
      const request = {
        projectId: 'test-project',
        templateIds: ['nestjs-controller'],
        entityIds: ['user-entity'],
        architecture: 'base-biz'
      };
      
      const result = await codeGeneratorService.generate(request);
      
      expect(result.files).toContainEqual(
        expect.objectContaining({
          path: expect.stringContaining('user.controller.ts')
        })
      );
    });
    
    it('should validate template variables', async () => {
      const invalidRequest = {
        templateIds: ['invalid-template'],
        variables: { missingRequired: 'value' }
      };
      
      await expect(codeGeneratorService.generate(invalidRequest))
        .rejects.toThrow('Required template variable missing');
    });
  });
});
```

#### 1.2 前端组件测试
**目标**: 测试Vue组件的渲染和交互逻辑

```typescript
// test/unit/components/ProjectManagement.spec.ts
import { mount } from '@vue/test-utils';
import ProjectManagement from '@/views/lowcode/project/index.vue';

describe('ProjectManagement', () => {
  it('should render project list', async () => {
    const wrapper = mount(ProjectManagement, {
      props: {
        projects: [
          { id: '1', name: '测试项目', status: 'ACTIVE' }
        ]
      }
    });
    
    expect(wrapper.find('[data-testid="project-list"]').exists()).toBe(true);
    expect(wrapper.text()).toContain('测试项目');
  });
  
  it('should emit create event on button click', async () => {
    const wrapper = mount(ProjectManagement);
    
    await wrapper.find('[data-testid="create-project-btn"]').trigger('click');
    
    expect(wrapper.emitted('create')).toBeTruthy();
  });
});
```

### 2. 集成测试 (Integration Tests)

#### 2.1 API集成测试
**目标**: 测试API端点的完整请求-响应流程

```typescript
// test/integration/api/project.api.spec.ts
describe('Project API Integration', () => {
  let app: INestApplication;
  
  beforeAll(async () => {
    const module = await Test.createTestingModule({
      imports: [AppModule]
    }).compile();
    
    app = module.createNestApplication();
    await app.init();
  });
  
  describe('POST /api/v1/projects', () => {
    it('should create project and return 201', async () => {
      const projectData = {
        name: '集成测试项目',
        code: 'integration-test',
        framework: 'nestjs'
      };
      
      const response = await request(app.getHttpServer())
        .post('/api/v1/projects')
        .send(projectData)
        .expect(201);
        
      expect(response.body.status).toBe(0);
      expect(response.body.data.id).toBeTruthy();
    });
  });
  
  describe('GET /api/v1/projects/paginated', () => {
    it('should return paginated projects', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/projects/paginated?current=1&size=10')
        .expect(200);
        
      expect(response.body.data.meta).toBeDefined();
      expect(Array.isArray(response.body.data.records)).toBe(true);
    });
  });
});
```

#### 2.2 数据库集成测试
**目标**: 测试数据库操作的完整性和一致性

```typescript
// test/integration/database/project.db.spec.ts
describe('Project Database Integration', () => {
  let prisma: PrismaService;
  
  beforeEach(async () => {
    await prisma.project.deleteMany(); // 清理测试数据
  });
  
  it('should create project with related entities', async () => {
    const project = await prisma.project.create({
      data: {
        name: '数据库测试项目',
        code: 'db-test',
        entities: {
          create: [
            {
              name: '用户',
              code: 'User',
              tableName: 'users',
              fields: {
                create: [
                  { name: '姓名', code: 'name', type: 'STRING' }
                ]
              }
            }
          ]
        }
      },
      include: { entities: { include: { fields: true } } }
    });
    
    expect(project.entities).toHaveLength(1);
    expect(project.entities[0].fields).toHaveLength(1);
  });
  
  it('should cascade delete project entities', async () => {
    const project = await prisma.project.create({
      data: { name: '级联测试', code: 'cascade-test' }
    });
    
    await prisma.entity.create({
      data: {
        projectId: project.id,
        name: '测试实体',
        code: 'TestEntity',
        tableName: 'test_entities'
      }
    });
    
    await prisma.project.delete({ where: { id: project.id } });
    
    const remainingEntities = await prisma.entity.findMany({
      where: { projectId: project.id }
    });
    
    expect(remainingEntities).toHaveLength(0);
  });
});
```

#### 2.3 服务间通信测试
**目标**: 测试lowcode-platform-backend和amis-lowcode-backend的协作

```typescript
// test/integration/services/amis-integration.spec.ts
describe('Amis Service Integration', () => {
  it('should deploy project to amis-lowcode-backend', async () => {
    // 1. 在lowcode-platform-backend创建项目
    const project = await createTestProject();
    
    // 2. 生成代码
    const codeGenResult = await generateCode(project.id);
    expect(codeGenResult.success).toBe(true);
    
    // 3. 部署到amis-lowcode-backend
    const deployment = await deployToAmis(project.id);
    expect(deployment.status).toBe('RUNNING');
    
    // 4. 验证amis服务可用
    const healthCheck = await checkAmisHealth(deployment.port);
    expect(healthCheck.status).toBe('healthy');
  });
});
```

### 3. 端到端测试 (E2E Tests)

#### 3.1 完整用户流程测试
**目标**: 模拟真实用户操作，测试完整业务流程

```typescript
// test/e2e/complete-workflow.e2e.spec.ts
describe('Complete Lowcode Workflow (E2E)', () => {
  let browser: Browser;
  let page: Page;
  
  beforeAll(async () => {
    browser = await puppeteer.launch({ headless: false });
    page = await browser.newPage();
  });
  
  afterAll(async () => {
    await browser.close();
  });
  
  it('should complete full project lifecycle', async () => {
    // 1. 登录系统
    await page.goto('http://localhost:5173/login');
    await page.type('[data-testid="username"]', 'admin');
    await page.type('[data-testid="password"]', 'password');
    await page.click('[data-testid="login-btn"]');
    await page.waitForNavigation();
    
    // 2. 创建项目
    await page.goto('http://localhost:5173/lowcode/project');
    await page.click('[data-testid="create-project-btn"]');
    
    await page.type('[data-testid="project-name"]', 'E2E测试项目');
    await page.type('[data-testid="project-code"]', 'e2e-test-project');
    await page.select('[data-testid="framework"]', 'nestjs');
    await page.click('[data-testid="submit-btn"]');
    
    // 等待项目创建成功
    await page.waitForSelector('[data-testid="project-created"]');
    
    // 3. 创建实体
    await page.click('[data-testid="goto-entities"]');
    await page.click('[data-testid="create-entity-btn"]');
    
    await page.type('[data-testid="entity-name"]', '用户');
    await page.type('[data-testid="entity-code"]', 'User');
    
    // 添加字段
    await page.click('[data-testid="add-field-btn"]');
    await page.type('[data-testid="field-name-0"]', '姓名');
    await page.type('[data-testid="field-code-0"]', 'name');
    await page.select('[data-testid="field-type-0"]', 'STRING');
    
    await page.click('[data-testid="submit-entity-btn"]');
    await page.waitForSelector('[data-testid="entity-created"]');
    
    // 4. 生成代码
    await page.click('[data-testid="goto-code-generation"]');
    await page.click('[data-testid="select-all-entities"]');
    await page.click('[data-testid="select-default-templates"]');
    await page.click('[data-testid="generate-code-btn"]');
    
    // 等待代码生成完成
    await page.waitForSelector('[data-testid="generation-complete"]', {
      timeout: 30000
    });
    
    // 5. 部署项目
    await page.click('[data-testid="deploy-project-btn"]');
    await page.waitForSelector('[data-testid="deployment-success"]', {
      timeout: 60000
    });
    
    // 6. 验证API可用
    const apiResponse = await page.evaluate(async () => {
      const response = await fetch('http://localhost:9522/api/v1/health');
      return response.ok;
    });
    
    expect(apiResponse).toBe(true);
    
    // 7. 测试生成的CRUD API
    const crudTest = await page.evaluate(async () => {
      // 创建用户
      const createResponse = await fetch('http://localhost:9522/api/v1/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: '测试用户' })
      });
      
      if (!createResponse.ok) return false;
      
      // 获取用户列表
      const listResponse = await fetch('http://localhost:9522/api/v1/users');
      return listResponse.ok;
    });
    
    expect(crudTest).toBe(true);
  });
  
  it('should handle error scenarios gracefully', async () => {
    // 测试各种错误场景的处理
    
    // 1. 重复项目代码
    await page.goto('http://localhost:5173/lowcode/project');
    await page.click('[data-testid="create-project-btn"]');
    await page.type('[data-testid="project-code"]', 'existing-project');
    await page.click('[data-testid="submit-btn"]');
    
    await page.waitForSelector('[data-testid="error-message"]');
    const errorText = await page.textContent('[data-testid="error-message"]');
    expect(errorText).toContain('项目代码已存在');
    
    // 2. 无效字段配置
    // 3. 模板生成失败
    // 4. 部署失败处理
  });
});
```

#### 3.2 性能测试
**目标**: 测试系统在负载下的性能表现

```typescript
// test/e2e/performance.e2e.spec.ts
describe('Performance Tests', () => {
  it('should handle concurrent project creation', async () => {
    const concurrentRequests = 10;
    const promises = [];
    
    for (let i = 0; i < concurrentRequests; i++) {
      promises.push(
        request(app.getHttpServer())
          .post('/api/v1/projects')
          .send({
            name: `并发项目${i}`,
            code: `concurrent-${i}`,
            framework: 'nestjs'
          })
      );
    }
    
    const results = await Promise.all(promises);
    
    // 所有请求都应该成功
    results.forEach(result => {
      expect(result.status).toBe(201);
    });
  });
  
  it('should generate code within acceptable time', async () => {
    const startTime = Date.now();
    
    const result = await generateCode({
      projectId: 'performance-test',
      entityCount: 10,
      templatesCount: 5
    });
    
    const duration = Date.now() - startTime;
    
    expect(result.success).toBe(true);
    expect(duration).toBeLessThan(30000); // 30秒内完成
  });
});
```

#### 3.3 安全测试
**目标**: 验证系统的安全性

```typescript
// test/e2e/security.e2e.spec.ts
describe('Security Tests', () => {
  it('should require authentication for protected endpoints', async () => {
    const response = await request(app.getHttpServer())
      .get('/api/v1/projects')
      .expect(401);
      
    expect(response.body.message).toContain('Unauthorized');
  });
  
  it('should validate input to prevent injection', async () => {
    const maliciousInput = {
      name: '<script>alert("xss")</script>',
      code: 'DROP TABLE projects;--'
    };
    
    const response = await request(app.getHttpServer())
      .post('/api/v1/projects')
      .send(maliciousInput)
      .expect(400);
      
    expect(response.body.message).toContain('Invalid input');
  });
  
  it('should enforce rate limiting', async () => {
    const requests = [];
    
    // 发送大量请求测试限流
    for (let i = 0; i < 100; i++) {
      requests.push(
        request(app.getHttpServer())
          .get('/api/v1/projects')
          .set('Authorization', 'Bearer valid-token')
      );
    }
    
    const results = await Promise.all(requests);
    
    // 应该有部分请求被限流
    const rateLimitedCount = results.filter(r => r.status === 429).length;
    expect(rateLimitedCount).toBeGreaterThan(0);
  });
});
```

## 🎯 测试数据管理

### 测试数据准备
```typescript
// test/fixtures/test-data.ts
export const testProjects = [
  {
    name: '电商管理系统',
    code: 'ecommerce-admin',
    framework: 'nestjs',
    entities: [
      {
        name: '商品',
        code: 'Product',
        fields: [
          { name: '商品名称', code: 'name', type: 'STRING' },
          { name: '价格', code: 'price', type: 'DECIMAL' }
        ]
      }
    ]
  }
];

export const testTemplates = [
  {
    name: 'NestJS控制器',
    code: 'nestjs-controller',
    content: '...',
    variables: [...]
  }
];
```

### 测试环境隔离
```bash
# 测试数据库配置
TEST_DATABASE_URL="postgresql://test:test@localhost:25433/lowcode_test"

# 测试环境脚本
npm run test:setup    # 初始化测试环境
npm run test:teardown # 清理测试环境
npm run test:reset    # 重置测试数据
```

## 📊 测试报告和覆盖率

### 覆盖率配置
```json
// jest.config.js
{
  "collectCoverageFrom": [
    "src/**/*.{ts,js}",
    "!src/**/*.d.ts",
    "!src/**/index.ts"
  ],
  "coverageThreshold": {
    "global": {
      "branches": 80,
      "functions": 80,
      "lines": 80,
      "statements": 80
    }
  }
}
```

### 测试报告生成
```bash
# 生成测试报告
npm run test:coverage        # 覆盖率报告
npm run test:report         # 详细测试报告
npm run test:performance    # 性能测试报告
```

## 🚀 持续集成测试

### GitHub Actions配置
```yaml
# .github/workflows/test.yml
name: Test Suite

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run unit tests
        run: npm run test:unit
        
      - name: Run integration tests
        run: npm run test:integration
        
      - name: Run E2E tests
        run: npm run test:e2e
        
      - name: Upload coverage
        uses: codecov/codecov-action@v1
```

## 📝 测试执行检查清单

### 每日测试 (快速验证)
- [ ] 单元测试全部通过
- [ ] 关键API集成测试通过
- [ ] 基础E2E流程测试通过
- [ ] 代码覆盖率 > 80%

### 发布前测试 (完整验证)
- [ ] 所有单元测试通过
- [ ] 所有集成测试通过
- [ ] 完整E2E测试套件通过
- [ ] 性能测试达标
- [ ] 安全测试通过
- [ ] 兼容性测试通过

### 生产环境验证
- [ ] 健康检查通过
- [ ] 核心功能验证
- [ ] 性能监控正常
- [ ] 错误率在可接受范围

## 🔧 测试工具和框架

### 后端测试
- **Jest** - 测试框架
- **Supertest** - HTTP API测试
- **@nestjs/testing** - NestJS测试工具
- **Prisma Test** - 数据库测试

### 前端测试
- **Vitest** - Vue 3测试框架
- **@vue/test-utils** - Vue组件测试
- **jsdom** - DOM环境模拟
- **MSW** - API Mock服务

### E2E测试
- **Puppeteer** - 浏览器自动化
- **Playwright** - 跨浏览器测试
- **Cypress** - 可视化E2E测试

### 性能测试
- **Artillery** - API负载测试
- **Lighthouse** - 前端性能分析
- **New Relic** - 应用性能监控

---

**文档版本**: 1.0  
**创建时间**: 2025-08-22  
**测试负责人**: QA团队  
**技术负责人**: 开发团队