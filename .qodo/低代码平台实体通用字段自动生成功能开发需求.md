# 低代码平台实体通用字段自动生成功能开发需求

## 1. 项目概述

### 1.1 背景
在lowcode-platform-backend低代码平台子服务中（子服务，专注低代码平台相关功能实现），为了简化开发者的工作流程，需要实现实体通用字段的自动生成功能。当开发者创建实体时，系统应自动为每个实体添加标准的通用字段，并在项目代码生成时自动在数据库中创建对应的表结构。 前端frontend要实现对应的前端页面功能。
如果调整prisma结构，需要同步调整 deploy下的sql文件，保证我们docker和本地生成的表结构一致，我们现在的数据库在docker中运行，前后端子服务在本地运行， 同时后端服务还包含backend，amis-lowcode-backend和frontend低代码前端子服务，请充分理解本项目后生成开发需求，进行后续的开发工作，验证后 提交git.
### 1.2 目标
- 提高开发效率，减少重复性工作
- 确保所有实体都具有统一的基础字段结构
- 实现实体到数据库表的自动映射和创建
- 保证数据的一致性和完整性

## 2. 技术栈分析

### 2.1 现有技术架构
- **后端框架**: NestJS (TypeScript)
- **ORM**: Prisma
- **数据库**: PostgreSQL
- **开发语言**: TypeScript
- **架构模式**: 微服务架构

### 2.2 相关依赖
- `@nestjs/common`
- `@nestjs/core`
- `@prisma/client`
- `prisma`
- `class-validator`
- `class-transformer`

## 3. 功能需求详细说明

### 3.1 实体通用字段定义

系统需要为每个新创建的实体自动添加以下通用字段：

| 字段名 | 字段代码 | 数据类型 | 是否必填 | 默认值 | 描述 |
|--------|----------|----------|----------|--------|------|
| 主键 | id | UUID/String | 是 | 自动生成 | 实体唯一标识符 |
| 创建者 | createdBy | String | 是 | 当前用户ID | 记录创建者用户ID |
| 创建时间 | createdAt | DateTime | 是 | 当前时间 | 记录创建时间戳 |
| 更新者 | updatedBy | String | 否 | null | 记录最后更新者用户ID |
| 更新时间 | updatedAt | DateTime | 否 | null | 记录最后更新时间戳 |

### 3.2 核心功能模块

#### 3.2.1 实体创建自动字段添加
- **功能描述**: 当通过API创建新实体时，系统自动添加通用字段
- **实现方式**: 使用NestJS拦截器或装饰器在实体创建过程中自动注入通用字段
- **验证规则**: 确保通用字段符合预定义的数据类型和约束

#### 3.2.2 实体字段管理
- **功能描述**: 管理实体的所有字段，包括通用字段和业务字段
- **字段类型支持**: String, Number, Boolean, DateTime, UUID等
- **字段约束**: 必填性、长度限制、格式验证等

#### 3.2.3 数据库表自动生成
- **功能描述**: 根据实体定义自动生成对应的数据库表结构
- **实现方式**: 利用Prisma Schema生成器动态创建表结构
- **迁移管理**: 自动处理数据库迁移和版本控制

## 4. 技术实现方案

### 4.1 数据模型设计

#### 4.1.1 实体模型 (Entity)
```typescript
interface Entity {
  id: string;
  name: string;
  code: string;
  description?: string;
  fields: EntityField[];
  createdBy: string;
  createdAt: Date;
  updatedBy?: string;
  updatedAt?: Date;
}
```

#### 4.1.2 实体字段模型 (EntityField)
```typescript
interface EntityField {
  id: string;
  entityId: string;
  name: string;
  code: string;
  dataType: FieldDataType;
  isRequired: boolean;
  isCommon: boolean; // 标识是否为通用字段
  defaultValue?: any;
  constraints?: FieldConstraints;
  createdBy: string;
  createdAt: Date;
  updatedBy?: string;
  updatedAt?: Date;
}
```

#### 4.1.3 字段数据类型枚举
```typescript
enum FieldDataType {
  STRING = 'STRING',
  NUMBER = 'NUMBER',
  BOOLEAN = 'BOOLEAN',
  DATETIME = 'DATETIME',
  UUID = 'UUID',
  TEXT = 'TEXT'
}
```

### 4.2 核心服务设计

#### 4.2.1 实体服务 (EntityService)
```typescript
@Injectable()
export class EntityService {
  async createEntity(createEntityDto: CreateEntityDto): Promise<Entity>;
  async addCommonFields(entityId: string): Promise<EntityField[]>;
  async validateEntityFields(fields: EntityField[]): Promise<boolean>;
  async generateDatabaseSchema(entity: Entity): Promise<string>;
}
```

#### 4.2.2 通用字段服务 (CommonFieldService)
```typescript
@Injectable()
export class CommonFieldService {
  getCommonFieldDefinitions(): CommonFieldDefinition[];
  createCommonFields(entityId: string, userId: string): Promise<EntityField[]>;
  validateCommonFieldConstraints(field: EntityField): Promise<boolean>;
}
```

#### 4.2.3 数据库生成服务 (DatabaseGeneratorService)
```typescript
@Injectable()
export class DatabaseGeneratorService {
  generatePrismaSchema(entities: Entity[]): Promise<string>;
  createDatabaseTable(entity: Entity): Promise<void>;
  runMigration(): Promise<void>;
}
```

### 4.3 API接口设计

#### 4.3.1 创建实体接口
```typescript
POST /api/entities
Content-Type: application/json

{
  "name": "用户信息",
  "code": "user_info",
  "description": "用户基本信息实体",
  "customFields": [
    {
      "name": "用户名",
      "code": "username",
      "dataType": "STRING",
      "isRequired": true
    }
  ]
}
```

#### 4.3.2 响应格式
```typescript
{
  "success": true,
  "data": {
    "id": "uuid-string",
    "name": "用户信息",
    "code": "user_info",
    "fields": [
      {
        "id": "field-uuid-1",
        "name": "主键",
        "code": "id",
        "dataType": "UUID",
        "isRequired": true,
        "isCommon": true
      },
      // ... 其他通用字段
      {
        "id": "field-uuid-6",
        "name": "用户名",
        "code": "username",
        "dataType": "STRING",
        "isRequired": true,
        "isCommon": false
      }
    ]
  }
}
```

## 5. 实现计划

### 5.1 开发阶段划分

#### 阶段一：基础架构搭建
- [ ] 分析现有实体管理模块结构和API接口
- [ ] 设计通用字段的数据结构和类型定义
- [ ] 创建相关的数据模型和接口定义

#### 阶段二：核心功能实现
- [ ] 实现实体创建时的自动字段添加逻辑
- [ ] 开发通用字段服务和验证机制
- [ ] 实现实体字段的管理功能

#### 阶段三：数据库集成
- [ ] 开发Prisma Schema动态生成功能
- [ ] 实现数据库表的自动创建和迁移
- [ ] 集成数据库操作和实体管理

#### 阶段四：API接口完善
- [ ] 更新实体创建API接口
- [ ] 实现实体查询和更新接口
- [ ] 添加字段验证和错误处理

#### 阶段五：测试和优化
- [ ] 编写单元测试和集成测试
- [ ] 测试实体创建和代码生成功能
- [ ] 性能优化和代码重构

### 5.2 时间估算
- 阶段一：2-3天
- 阶段二：4-5天
- 阶段三：3-4天
- 阶段四：2-3天
- 阶段五：3-4天

**总计：14-19个工作日**

## 6. 技术风险和解决方案

### 6.1 潜在风险
1. **数据库迁移复杂性**: 动态生成的表结构可能导致迁移问题
2. **字段冲突**: 通用字段与业务字段可能存在命名冲突
3. **性能影响**: 自动字段添加可能影响实体创建性能
4. **类型安全**: 动态生成的字段可能存在类型安全问题

### 6.2 解决方案
1. **迁移管理**: 使用Prisma的迁移功能，建立完善的版本控制机制
2. **命名规范**: 建立严格的字段命名规范，避免冲突
3. **性能优化**: 使用批量操作和缓存机制提高性能
4. **类型检查**: 使用TypeScript严格模式和运行时验证

## 7. 验收标准

### 7.1 功能验收
- [ ] 创建实体时自动添加所有通用字段
- [ ] 通用字段数据类型和约束正确
- [ ] 数据库表能够正确生成和创建
- [ ] API接口响应格式符合规范
- [ ] 字段验证和错误处理正常工作

### 7.2 性能验收
- [ ] 实体创建响应时间 < 500ms
- [ ] 数据库表生成时间 < 2s
- [ ] 支持并发创建实体操作

### 7.3 质量验收
- [ ] 代码覆盖率 > 80%
- [ ] 所有单元测试通过
- [ ] 集成测试通过
- [ ] 代码符合项目规范

## 8. 后续扩展

### 8.1 功能扩展
- 支持自定义通用字段模板
- 实现字段级别的权限控制
- 添加字段变更历史记录
- 支持字段的软删除功能

### 8.2 技术优化
- 实现字段的懒加载机制
- 添加字段缓存策略
- 优化数据库查询性能
- 支持分布式部署

---

**文档版本**: v1.0  
**创建日期**: 2024年12月  
**负责人**: 开发团队  
**审核人**: 技术负责人