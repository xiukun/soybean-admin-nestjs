# 低代码平台实现方案

## 项目概述

基于 soybean-admin-nestjs 项目实现的低代码平台，提供可视化页面设计、数据模型管理、API管理等核心功能，并支持docker部署运行。
根据以下实现方案，逐步开发完成需求,并标记完成项。

## 技术架构

### 后端技术栈
- **框架**: NestJS + TypeScript
- **数据库**: PostgreSQL + Prisma ORM
- **缓存**: Redis
- **连接池**: PGBouncer
- **认证**: JWT
- **API文档**: Swagger

### 前端技术栈
- **框架**: Vue 3 + TypeScript
- **UI组件**: Naive UI
- **状态管理**: Pinia
- **路由**: Vue Router
- **构建工具**: Vite

## 数据库设计

### 核心表结构（扩展）
根据postgres数据库中现有表，

#### 1. 低代码页面表 (sys_lowcode_page)
```sql
CREATE TABLE "sys_lowcode_page" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" TEXT NOT NULL,                    -- 页面名称
    "title" TEXT NOT NULL,                   -- 页面标题
    "code" TEXT NOT NULL UNIQUE,             -- 页面编码
    "description" TEXT,                      -- 页面描述
    "path" TEXT NOT NULL,                    -- 页面路径
    "schema" TEXT NOT NULL,                  -- 页面Schema配置
    "menu_id" INTEGER,                       -- 关联菜单ID
    "status" "Status" NOT NULL,              -- 状态
    "created_at" TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP,
    "created_by" TEXT NOT NULL,
    "updated_at" TIMESTAMP(3),
    "updated_by" TEXT
);
```

#### 2. 低代码模型表 (sys_lowcode_model)
```sql
CREATE TABLE "sys_lowcode_model" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" TEXT NOT NULL,                    -- 模型名称
    "code" TEXT NOT NULL UNIQUE,             -- 模型编码
    "description" TEXT,                      -- 模型描述
    "table_name" TEXT NOT NULL,              -- 对应表名
    "status" "Status" NOT NULL,              -- 状态
    "created_at" TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP,
    "created_by" TEXT NOT NULL,
    "updated_at" TIMESTAMP(3),
    "updated_by" TEXT
);
```

#### 3. 低代码模型属性表 (sys_lowcode_model_property)
```sql
CREATE TABLE "sys_lowcode_model_property" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "model_id" UUID NOT NULL,                -- 关联模型ID
    "name" TEXT NOT NULL,                    -- 属性名称
    "code" TEXT NOT NULL,                    -- 属性编码
    "description" TEXT,                      -- 属性描述
    "type" TEXT NOT NULL,                    -- 数据类型
    "length" INTEGER,                        -- 长度
    "precision" INTEGER,                     -- 精度
    "scale" INTEGER,                         -- 小数位数
    "nullable" BOOLEAN DEFAULT true,         -- 是否可为空
    "default_value" TEXT,                    -- 默认值
    "is_primary_key" BOOLEAN DEFAULT false,  -- 是否主键
    "is_unique" BOOLEAN DEFAULT false,       -- 是否唯一
    "is_index" BOOLEAN DEFAULT false,        -- 是否索引
    "created_at" TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP,
    "created_by" TEXT NOT NULL,
    "updated_at" TIMESTAMP(3),
    "updated_by" TEXT,
    FOREIGN KEY ("model_id") REFERENCES "lowcode_model"("id") ON DELETE CASCADE
);
```

#### 4. 低代码模型关联表 (sys_lowcode_model_reference)
```sql
CREATE TABLE "sys_lowcode_model_reference" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "model_id" UUID NOT NULL,                -- 关联模型ID
    "name" TEXT NOT NULL,                    -- 关联名称
    "source_model" TEXT NOT NULL,            -- 源模型
    "source_property" TEXT NOT NULL,         -- 源���性
    "target_model" TEXT NOT NULL,            -- 目标模型
    "target_property" TEXT NOT NULL,         -- 目标属性
    "relation_type" TEXT NOT NULL,           -- 关联类型
    "on_delete" TEXT,                        -- 删除时操作
    "on_update" TEXT,                        -- 更新时操作
    "created_at" TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP,
    "created_by" TEXT NOT NULL,
    "updated_at" TIMESTAMP(3),
    "updated_by" TEXT,
    FOREIGN KEY ("model_id") REFERENCES "lowcode_model"("id") ON DELETE CASCADE
);
```

#### 5. 低代码API表 (sys_lowcode_api)
```sql
CREATE TABLE "sys_lowcode_api" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" TEXT NOT NULL,                    -- API名称
    "path" TEXT NOT NULL,                    -- API路径
    "method" TEXT NOT NULL,                  -- HTTP方法
    "description" TEXT,                      -- API描述
    "model_id" TEXT,                         -- 关联模型ID
    "request_schema" TEXT,                   -- 请求Schema
    "response_schema" TEXT,                  -- 响应Schema
    "status" "Status" NOT NULL,              -- 状态
    "created_at" TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP,
    "created_by" TEXT NOT NULL,
    "updated_at" TIMESTAMP(3),
    "updated_by" TEXT
);
```

## 后端架构实现

### 1. 分层架构

结合项目结构，生成DDD架构结构，根据base-system的结构继续扩展

### 2. 核心功能模块

#### 页面管理模块
- **功能**: 低代码页面的CRUD操作
- **特性**: 
  - 页面Schema配置存储
  - 页面状态管理
  - 页面编码唯一性校验

#### 模型管理模块
- **功能**: 数据模型定义和管理
- **特性**:
  - 模型属性定义
  - 模型关联关系管理
  - 支持事务创建模型及其关联数据

#### API管理模块
- **功能**: 低代码API的定义和管理
- **特性**:
  - API路径和方法唯一性校验
  - 请求/响应Schema定义
  - API状态管理

### 3. API接口设计

#### 页面管理接口
```typescript
// 创建页面
POST /api/v1/lowcode/pages
// 获取页面列表
GET /api/v1/lowcode/pages
// 根据ID获取页面
GET /api/v1/lowcode/pages/:id
// 根据编码获取页面
GET /api/v1/lowcode/pages/code/:code
// 更新页面
PUT /api/v1/lowcode/pages/:id
// 更新页面状态
PUT /api/v1/lowcode/pages/:id/status
// 删除页面
DELETE /api/v1/lowcode/pages/:id
```

#### 模型管理接口
```typescript
// 创建模型
POST /api/v1/lowcode/models
// 获取模型列表
GET /api/v1/lowcode/models
// 获取模型列表（包含关联数据）
GET /api/v1/lowcode/models/with-relations
// 根据ID获取模型
GET /api/v1/lowcode/models/:id
// 根据编码获取模型
GET /api/v1/lowcode/models/code/:code
// 更新模型
PUT /api/v1/lowcode/models/:id
// 更新模型状态
PUT /api/v1/lowcode/models/:id/status
// 删除模型
DELETE /api/v1/lowcode/models/:id
```

#### API管理接口
```typescript
// 创建API
POST /api/v1/lowcode/apis
// 获取API列表
GET /api/v1/lowcode/apis
// 根据ID获取API
GET /api/v1/lowcode/apis/:id
// 根据路径和方法获取API
GET /api/v1/lowcode/apis/path/:path/:method
// 更新API
PUT /api/v1/lowcode/apis/:id
// 更新API状态
PUT /api/v1/lowcode/apis/:id/status
// 删除API
DELETE /api/v1/lowcode/apis/:id
```

## 部署和运行

### 1. 环境要求
- Node.js >= 18
- PostgreSQL >= 14
- Redis >= 6
- Docker & Docker Compose

### 2. 启动步骤

#### 启动数据库服务
```bash
docker-compose up -d postgres redis pgbouncer
```

#### 数据库迁移
```bash
cd backend
npx prisma migrate deploy
npx prisma generate
```

#### 启动后端服务
```bash
cd backend
npm install
npm run start:dev
```

#### 启动前端服务
```bash
cd frontend
npm install
npm run dev
```

### 3. 访问地址
- 前端应用: http://localhost:9527
- 后端API: http://localhost:9528
- API文档: http://localhost:9528/api-docs

## 功能特性

### 1. 已完成功能
- ✅ 数据库表结构设计
- ✅ Prisma模型定义
- ✅ 低代码页面管理后端API接口实现
- ✅ 分层架构设计（DDD架构）
- ✅ 数据验证和错误处理
- ✅ Swagger API文档

### 2. 待实现功能
- 🔄 集成低代码渲染引擎 实现低代码渲染页面(项目：cd /Users/a1234/Documents/GitHub/amisVueAdmin 对应的src/components/amis-renderer/amis.vue)
- 实现后端模块对应的前端页面，并在sys_menu表中创建对应模块。
- 完成低代码模型管理API - 正在进行中
- 实现低代码API管理功能
- 开发前端管理界面
- 添加菜单配置
- 完善权限管理
- 实现数据字典管理

### 3. 扩展功能
- 📋 页面版本管理
- 📋 组件市场
- 📋 多租户支持
- 📋 权限控制集成
- 📋 性能监控
- 📋 日志审计

## 开发指南

### 1. 添加新的低代码组件
1. 在 `lowcode-component` 目录下创建组件定义
2. 实现组件的渲染逻辑
3. 添加组件配置Schema
4. 注册到组件库

### 2. 扩展数据模型
1. 更新 Prisma Schema
2. 创建数据库迁移
3. 实现仓储层接口
4. 添加业务服务层
5. 创建API控制器

### 3. 集成外部数据源
1. 实现数据源连接器
2. 定义数据转换规则
3. 添加数据源管理界面
4. 支持数据源测试连接

## 总结

本低代码平台基于 soybean-admin-nestjs 项目构建，采用现代化的技术栈和分层架构设计，提供了完整的后端API支持。通过模块化的设计，可以灵活扩展各种低代码功能，为业务人员提供高效的应用开发体验。

当前已完成核心的数据模型和API接口实现，后续将重点开发前端可视化设计器和��件库，逐步完善整个低代码平台的功能。