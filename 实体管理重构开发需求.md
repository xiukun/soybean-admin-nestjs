# 实体管理重构开发需求

## 📋 项目概述

基于现有的低代码平台实体管理功能，进行全面的UI/UX重构和技术升级。主要目标是优化空间利用率，提升用户体验，并使用现代化的图形引擎重构实体设计器。

## 🎯 核心需求

### 1. UI布局重构
- **移除Tabs布局**: 不再使用NTabs组件展示列表视图和设计器视图
- **顶部切换按钮**: 在实体管理页面顶部增加视图切换按钮组
- **空间优化**: 最大化利用页面空间，提供更好的视觉体验
- **默认视图**: 默认展示设计器的可视化界面

### 2. 实体设计器重构
- **技术栈升级**: 使用Vue3 + AntV X6重构实体设计器
- **可视化增强**: 提供更丰富的图形交互和视觉效果
- **性能优化**: 支持大量实体的流畅渲染和操作
- **交互改进**: 更直观的拖拽、连线、编辑操作

### 3. 前后端逻辑梳理
- **接口规范**: 重新梳理和优化实体管理相关API接口
- **数据流**: 优化前后端数据交互流程
- **状态管理**: 完善前端状态管理和数据缓存

## 🏗️ 技术架构

### 前端技术栈
```typescript
// 核心框架
Vue 3.5+ (Composition API)
TypeScript 5.0+
Vite 6+

// UI组件库
Naive UI 2.41+

// 图形引擎
AntV X6 2.18+

// 状态管理
Pinia 3.0+

// 工具库
VueUse
Lodash-es
```

### 后端技术栈
```typescript
// 框架
NestJS 11.x
Prisma ORM
PostgreSQL

// 架构模式
DDD (领域驱动设计)
CQRS + Event Sourcing
```

## 📐 详细设计

### 1. 页面布局设计

#### 1.1 顶部工具栏
```vue
<template>
  <div class="entity-management">
    <!-- 顶部工具栏 -->
    <div class="toolbar">
      <div class="view-switcher">
        <NButtonGroup>
          <NButton 
            :type="currentView === 'designer' ? 'primary' : 'default'"
            @click="switchView('designer')"
          >
            <template #icon>
              <NIcon><icon-mdi-vector-polyline /></NIcon>
            </template>
            设计器视图
          </NButton>
          <NButton 
            :type="currentView === 'list' ? 'primary' : 'default'"
            @click="switchView('list')"
          >
            <template #icon>
              <NIcon><icon-mdi-table /></NIcon>
            </template>
            列表视图
          </NButton>
        </NButtonGroup>
      </div>
      
      <div class="actions">
        <NButton type="primary" @click="createEntity">
          <template #icon>
            <NIcon><icon-mdi-plus /></NIcon>
          </template>
          创建实体
        </NButton>
        <NButton @click="importEntities">
          <template #icon>
            <NIcon><icon-mdi-import /></NIcon>
          </template>
          导入实体
        </NButton>
      </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
      <EntityDesigner v-if="currentView === 'designer'" />
      <EntityList v-else-if="currentView === 'list'" />
    </div>
  </div>
</template>
```

#### 1.2 设计器布局
```vue
<template>
  <div class="entity-designer">
    <!-- 左侧工具面板 -->
    <div class="left-panel">
      <EntityToolbox />
    </div>
    
    <!-- 中央画布区域 -->
    <div class="canvas-area">
      <X6Canvas ref="canvasRef" />
    </div>
    
    <!-- 右侧属性面板 -->
    <div class="right-panel">
      <EntityPropertyPanel />
    </div>
  </div>
</template>
```

### 2. AntV X6 设计器实现

#### 2.1 画布初始化
```typescript
// composables/useX6Canvas.ts
import { Graph, Node, Edge } from '@antv/x6'
import { Selection } from '@antv/x6-plugin-selection'
import { Snapline } from '@antv/x6-plugin-snapline'
import { Keyboard } from '@antv/x6-plugin-keyboard'
import { Clipboard } from '@antv/x6-plugin-clipboard'
import { History } from '@antv/x6-plugin-history'

export function useX6Canvas() {
  const graph = ref<Graph | null>(null)
  const container = ref<HTMLElement | null>(null)
  
  /**
   * 初始化X6画布
   */
  const initGraph = () => {
    if (!container.value) return
    
    graph.value = new Graph({
      container: container.value,
      width: container.value.clientWidth,
      height: container.value.clientHeight,
      grid: {
        visible: true,
        type: 'doubleMesh',
        args: [
          {
            color: '#E7E8EA',
            thickness: 1,
          },
          {
            color: '#CBCED3',
            thickness: 1,
            factor: 4,
          },
        ],
      },
      selecting: {
        enabled: true,
        rubberband: true,
        movable: true,
        showNodeSelectionBox: true,
      },
      connecting: {
        router: 'manhattan',
        connector: {
          name: 'rounded',
          args: {
            radius: 8,
          },
        },
        anchor: 'center',
        connectionPoint: 'anchor',
        allowBlank: false,
        snap: {
          radius: 20,
        },
        createEdge() {
          return new Edge({
            attrs: {
              line: {
                stroke: '#A2B1C3',
                strokeWidth: 2,
                targetMarker: {
                  name: 'block',
                  width: 12,
                  height: 8,
                },
              },
            },
            zIndex: 0,
          })
        },
        validateConnection({ targetMagnet }) {
          return !!targetMagnet
        },
      },
      highlighting: {
        magnetAdsorbed: {
          name: 'stroke',
          args: {
            attrs: {
              fill: '#5F95FF',
              stroke: '#5F95FF',
            },
          },
        },
      },
      resizing: true,
      rotating: true,
      history: true,
      clipboard: true,
      keyboard: true,
    })
    
    // 注册插件
    graph.value
      .use(new Selection({ enabled: true, multiple: true, rubberband: true }))
      .use(new Snapline({ enabled: true }))
      .use(new Keyboard({ enabled: true }))
      .use(new Clipboard({ enabled: true }))
      .use(new History({ enabled: true }))
  }
  
  return {
    graph,
    container,
    initGraph
  }
}
```

#### 2.2 实体节点定义
```typescript
// components/EntityNode.ts
import { Node } from '@antv/x6'

/**
 * 实体节点类
 */
export class EntityNode extends Node {
  constructor(options: EntityNodeOptions) {
    super({
      ...options,
      shape: 'entity-node',
      width: 200,
      height: 'auto',
      attrs: {
        body: {
          stroke: '#5F95FF',
          strokeWidth: 1,
          fill: '#EFF4FF',
          rx: 6,
          ry: 6,
        },
        header: {
          fill: '#5F95FF',
          height: 40,
          rx: 6,
          ry: 6,
        },
        title: {
          fontSize: 14,
          fontWeight: 'bold',
          fill: '#FFFFFF',
          textAnchor: 'middle',
          textVerticalAnchor: 'middle',
        },
        fields: {
          fontSize: 12,
          fill: '#262626',
        },
      },
      markup: [
        {
          tagName: 'rect',
          selector: 'body',
        },
        {
          tagName: 'rect',
          selector: 'header',
        },
        {
          tagName: 'text',
          selector: 'title',
        },
        {
          tagName: 'foreignObject',
          selector: 'fields',
        },
      ],
      ports: {
        groups: {
          top: {
            position: 'top',
            attrs: {
              circle: {
                r: 4,
                magnet: true,
                stroke: '#5F95FF',
                strokeWidth: 1,
                fill: '#fff',
                style: {
                  visibility: 'hidden',
                },
              },
            },
          },
          right: {
            position: 'right',
            attrs: {
              circle: {
                r: 4,
                magnet: true,
                stroke: '#5F95FF',
                strokeWidth: 1,
                fill: '#fff',
                style: {
                  visibility: 'hidden',
                },
              },
            },
          },
          bottom: {
            position: 'bottom',
            attrs: {
              circle: {
                r: 4,
                magnet: true,
                stroke: '#5F95FF',
                strokeWidth: 1,
                fill: '#fff',
                style: {
                  visibility: 'hidden',
                },
              },
            },
          },
          left: {
            position: 'left',
            attrs: {
              circle: {
                r: 4,
                magnet: true,
                stroke: '#5F95FF',
                strokeWidth: 1,
                fill: '#fff',
                style: {
                  visibility: 'hidden',
                },
              },
            },
          },
        },
        items: [
          {
            group: 'top',
          },
          {
            group: 'right',
          },
          {
            group: 'bottom',
          },
          {
            group: 'left',
          },
        ],
      },
    })
  }
  
  /**
   * 更新实体字段显示
   */
  updateFields(fields: EntityField[]) {
    const fieldsHtml = this.generateFieldsHtml(fields)
    this.attr('fields/html', fieldsHtml)
    
    // 动态调整节点高度
    const height = 40 + fields.length * 24 + 20
    this.resize(200, height)
  }
  
  /**
   * 生成字段HTML
   */
  private generateFieldsHtml(fields: EntityField[]): string {
    return `
      <div style="padding: 10px; font-size: 12px;">
        ${fields.map(field => `
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span style="${field.isPrimaryKey ? 'font-weight: bold; color: #f5222d;' : ''}">
              ${field.isPrimaryKey ? '🔑 ' : ''}${field.name}
            </span>
            <span style="color: #8c8c8c; font-size: 11px;">${field.dataType}</span>
          </div>
        `).join('')}
      </div>
    `
  }
}

// 注册自定义节点
Node.registry.register('entity-node', EntityNode, true)
```

### 3. 状态管理设计

#### 3.1 实体管理Store
```typescript
// stores/entityStore.ts
import { defineStore } from 'pinia'
import type { Entity, EntityField, EntityRelationship } from '@/types/entity'

export const useEntityStore = defineStore('entity', () => {
  // 状态
  const entities = ref<Entity[]>([])
  const selectedEntity = ref<Entity | null>(null)
  const currentView = ref<'designer' | 'list'>('designer')
  const loading = ref(false)
  const currentProjectId = ref<string | null>(null)
  
  // 计算属性
  const entitiesByProject = computed(() => {
    if (!currentProjectId.value) return []
    return entities.value.filter(entity => entity.projectId === currentProjectId.value)
  })
  
  const entityCount = computed(() => entitiesByProject.value.length)
  
  const relationshipCount = computed(() => {
    return entitiesByProject.value.reduce((count, entity) => {
      return count + (entity.relationships?.length || 0)
    }, 0)
  })
  
  // 操作方法
  
  /**
   * 加载项目实体列表
   */
  const loadEntities = async (projectId: string) => {
    loading.value = true
    try {
      const response = await fetchEntitiesByProject(projectId)
      entities.value = response.data
      currentProjectId.value = projectId
    } catch (error) {
      console.error('Failed to load entities:', error)
      throw error
    } finally {
      loading.value = false
    }
  }
  
  /**
   * 创建实体
   */
  const createEntity = async (entityData: CreateEntityDto) => {
    try {
      const response = await fetchCreateEntity(entityData)
      entities.value.push(response.data)
      return response.data
    } catch (error) {
      console.error('Failed to create entity:', error)
      throw error
    }
  }
  
  /**
   * 更新实体
   */
  const updateEntity = async (entityId: string, entityData: UpdateEntityDto) => {
    try {
      const response = await fetchUpdateEntity(entityId, entityData)
      const index = entities.value.findIndex(e => e.id === entityId)
      if (index > -1) {
        entities.value[index] = response.data
      }
      return response.data
    } catch (error) {
      console.error('Failed to update entity:', error)
      throw error
    }
  }
  
  /**
   * 删除实体
   */
  const deleteEntity = async (entityId: string) => {
    try {
      await fetchDeleteEntity(entityId)
      const index = entities.value.findIndex(e => e.id === entityId)
      if (index > -1) {
        entities.value.splice(index, 1)
      }
      if (selectedEntity.value?.id === entityId) {
        selectedEntity.value = null
      }
    } catch (error) {
      console.error('Failed to delete entity:', error)
      throw error
    }
  }
  
  /**
   * 选择实体
   */
  const selectEntity = (entity: Entity | null) => {
    selectedEntity.value = entity
  }
  
  /**
   * 切换视图
   */
  const switchView = (view: 'designer' | 'list') => {
    currentView.value = view
  }
  
  return {
    // 状态
    entities,
    selectedEntity,
    currentView,
    loading,
    currentProjectId,
    
    // 计算属性
    entitiesByProject,
    entityCount,
    relationshipCount,
    
    // 方法
    loadEntities,
    createEntity,
    updateEntity,
    deleteEntity,
    selectEntity,
    switchView
  }
})
```

### 4. API接口优化

#### 4.1 实体管理API
```typescript
// api/entity.ts
import { request } from '@/utils/request'
import type { 
  Entity, 
  CreateEntityDto, 
  UpdateEntityDto, 
  EntityListQuery,
  EntityListResponse 
} from '@/types/entity'

/**
 * 获取项目实体列表
 */
export function fetchEntitiesByProject(projectId: string): Promise<ApiResponse<Entity[]>> {
  return request.get(`/api/v1/entities/project/${projectId}`)
}

/**
 * 获取实体分页列表
 */
export function fetchEntitiesPaginated(
  projectId: string, 
  query: EntityListQuery
): Promise<ApiResponse<EntityListResponse>> {
  return request.get(`/api/v1/entities/project/${projectId}/paginated`, {
    params: query
  })
}

/**
 * 获取实体详情
 */
export function fetchEntityById(entityId: string): Promise<ApiResponse<Entity>> {
  return request.get(`/api/v1/entities/${entityId}`)
}

/**
 * 创建实体
 */
export function fetchCreateEntity(data: CreateEntityDto): Promise<ApiResponse<Entity>> {
  return request.post('/api/v1/entities', data)
}

/**
 * 更新实体
 */
export function fetchUpdateEntity(
  entityId: string, 
  data: UpdateEntityDto
): Promise<ApiResponse<Entity>> {
  return request.put(`/api/v1/entities/${entityId}`, data)
}

/**
 * 删除实体
 */
export function fetchDeleteEntity(entityId: string): Promise<ApiResponse<void>> {
  return request.delete(`/api/v1/entities/${entityId}`)
}

/**
 * 获取实体设计器数据
 */
export function fetchEntityDesignerData(
  projectId: string
): Promise<ApiResponse<EntityDesignerData>> {
  return request.get(`/api/v1/entities/project/${projectId}/designer-data`)
}

/**
 * 保存实体设计器数据
 */
export function saveEntityDesignerData(
  projectId: string,
  data: EntityDesignerData
): Promise<ApiResponse<void>> {
  return request.post(`/api/v1/entities/project/${projectId}/designer-data`, data)
}
```

## 📋 开发任务清单

### Phase 1: 基础重构 (1-2周)

#### 1.1 UI布局重构
- [ ] 移除现有的NTabs组件
- [ ] 实现顶部视图切换按钮组
- [ ] 调整页面布局和样式
- [ ] 实现视图状态管理

#### 1.2 组件结构调整
- [ ] 重构EntityManagement主组件
- [ ] 分离EntityDesigner和EntityList组件
- [ ] 优化组件间通信机制

### Phase 2: X6设计器开发 (2-3周)

#### 2.1 X6画布集成
- [ ] 安装和配置AntV X6
- [ ] 实现基础画布组件
- [ ] 配置画布插件(选择、对齐线、键盘、剪贴板等)

#### 2.2 实体节点开发
- [ ] 设计实体节点样式
- [ ] 实现自定义EntityNode类
- [ ] 支持字段动态显示
- [ ] 实现节点拖拽和调整大小

#### 2.3 关系连线开发
- [ ] 实现实体间连线功能
- [ ] 支持不同关系类型的视觉区分
- [ ] 实现连线编辑和删除

#### 2.4 交互功能
- [ ] 实现节点选择和多选
- [ ] 支持右键菜单操作
- [ ] 实现撤销/重做功能
- [ ] 支持画布缩放和平移

### Phase 3: 功能完善 (1-2周)

#### 3.1 属性面板
- [ ] 重构EntityPropertyPanel组件
- [ ] 实现实体属性编辑
- [ ] 实现字段管理功能
- [ ] 支持关系属性编辑

#### 3.2 工具面板
- [ ] 实现EntityToolbox组件
- [ ] 提供实体模板拖拽
- [ ] 实现快捷操作按钮

#### 3.3 数据持久化
- [ ] 实现设计器数据保存
- [ ] 支持自动保存功能
- [ ] 实现版本历史记录

### Phase 4: 后端API优化 (1周)

#### 4.1 接口梳理
- [ ] 审查现有实体管理API
- [ ] 优化数据传输格式
- [ ] 增加设计器专用接口

#### 4.2 性能优化
- [ ] 实现增量数据更新
- [ ] 优化大量实体的查询性能
- [ ] 添加数据缓存机制

### Phase 5: 测试和优化 (1周)

#### 5.1 功能测试
- [ ] 单元测试编写
- [ ] 集成测试
- [ ] E2E测试

#### 5.2 性能测试
- [ ] 大数据量测试
- [ ] 内存泄漏检查
- [ ] 渲染性能优化

#### 5.3 用户体验优化
- [ ] 交互细节优化
- [ ] 错误处理完善
- [ ] 加载状态优化

## 🔧 技术实现要点

### 1. 性能优化策略

#### 1.1 虚拟化渲染
```typescript
// 对于大量实体的场景，实现虚拟化渲染
const useVirtualization = () => {
  const visibleNodes = computed(() => {
    // 只渲染可视区域内的节点
    return entities.value.filter(entity => {
      return isInViewport(entity.position, viewport.value)
    })
  })
  
  return { visibleNodes }
}
```

#### 1.2 增量更新
```typescript
// 实现增量数据更新，避免全量刷新
const updateEntityIncremental = (entityId: string, changes: Partial<Entity>) => {
  const entity = entities.value.find(e => e.id === entityId)
  if (entity) {
    Object.assign(entity, changes)
    // 只更新变化的节点
    updateNodeInGraph(entityId, changes)
  }
}
```

### 2. 数据结构设计

#### 2.1 实体数据结构
```typescript
interface Entity {
  id: string
  projectId: string
  name: string
  code: string
  tableName: string
  description?: string
  category: string
  status: EntityStatus
  
  // 设计器相关
  position: { x: number; y: number }
  size: { width: number; height: number }
  style: EntityStyle
  
  // 业务数据
  fields: EntityField[]
  relationships: EntityRelationship[]
  
  // 元数据
  createdAt: string
  updatedAt: string
  createdBy: string
  updatedBy?: string
}

interface EntityField {
  id: string
  entityId: string
  name: string
  code: string
  dataType: string
  length?: number
  precision?: number
  scale?: number
  nullable: boolean
  unique: boolean
  primaryKey: boolean
  autoIncrement: boolean
  defaultValue?: string
  comment?: string
  sortOrder: number
}

interface EntityRelationship {
  id: string
  sourceEntityId: string
  targetEntityId: string
  sourceFieldId: string
  targetFieldId: string
  type: RelationshipType
  name: string
  description?: string
  onDelete: CascadeAction
  onUpdate: CascadeAction
}
```

### 3. 错误处理和用户反馈

#### 3.1 全局错误处理
```typescript
// 实现全局错误处理机制
const useErrorHandler = () => {
  const handleError = (error: Error, context: string) => {
    console.error(`Error in ${context}:`, error)
    
    // 用户友好的错误提示
    const userMessage = getUserFriendlyMessage(error)
    window.$message?.error(userMessage)
    
    // 错误上报
    reportError(error, context)
  }
  
  return { handleError }
}
```

#### 3.2 操作反馈
```typescript
// 提供及时的操作反馈
const useOperationFeedback = () => {
  const showSuccess = (message: string) => {
    window.$message?.success(message)
  }
  
  const showLoading = (message: string) => {
    return window.$loading?.start(message)
  }
  
  return { showSuccess, showLoading }
}
```

## 📊 验收标准

### 1. 功能验收
- [ ] 顶部切换按钮正常工作，默认显示设计器视图
- [ ] 设计器支持实体的创建、编辑、删除操作
- [ ] 支持实体间关系的可视化连线
- [ ] 属性面板能正确显示和编辑实体/字段信息
- [ ] 列表视图保持原有功能不变
- [ ] 数据保存和加载功能正常

### 2. 性能验收
- [ ] 支持100+实体的流畅渲染
- [ ] 画布操作响应时间 < 100ms
- [ ] 页面初始加载时间 < 2s
- [ ] 内存使用稳定，无明显泄漏

### 3. 用户体验验收
- [ ] 界面布局合理，空间利用率高
- [ ] 交互操作直观易懂
- [ ] 错误提示清晰友好
- [ ] 支持键盘快捷键操作

### 4. 兼容性验收
- [ ] 支持主流浏览器(Chrome, Firefox, Safari, Edge)
- [ ] 响应式设计，支持不同屏幕尺寸
- [ ] 与现有系统功能无冲突

## 🚀 部署和发布

### 1. 开发环境配置
```bash
# 安装新依赖
pnpm add @antv/x6 @antv/x6-plugin-selection @antv/x6-plugin-snapline
pnpm add @antv/x6-plugin-keyboard @antv/x6-plugin-clipboard @antv/x6-plugin-history

# 开发调试
pnpm run dev
```

### 2. 构建和测试
```bash
# 类型检查
pnpm run type-check

# 单元测试
pnpm run test:unit

# E2E测试
pnpm run test:e2e

# 构建生产版本
pnpm run build
```

### 3. 发布流程
1. 代码审查和测试
2. 版本标记和发布说明
3. 生产环境部署
4. 功能验证和监控

## 📝 文档和培训

### 1. 技术文档
- [ ] API接口文档更新
- [ ] 组件使用说明
- [ ] 架构设计文档

### 2. 用户文档
- [ ] 功能使用指南
- [ ] 操作视频教程
- [ ] 常见问题解答

### 3. 开发者文档
- [ ] 代码结构说明
- [ ] 扩展开发指南
- [ ] 调试和故障排除

---

**项目负责人**: 开发团队  
**预计工期**: 6-8周  
**优先级**: 高  
**风险评估**: 中等（主要风险在于X6集成和性能优化）