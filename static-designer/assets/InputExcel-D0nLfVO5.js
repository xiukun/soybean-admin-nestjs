const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-DWd47z6R.js","assets/react-vendor-DeqkGhWy.js","assets/amis-CpcGROCB.js"])))=>i.map(i=>d[i]);
import{b as A,d as C,F as D,aY as F,ag as W,bW as w,e_ as B,au as P,aC as O,$ as _,af as I,a$ as T,aq as N,dK as j,as as z,R as y,f1 as U,c as R,a1 as S,a2 as E}from"./amis-CpcGROCB.js";import"./react-vendor-DeqkGhWy.js";var M=function(g){A(p,g);function p(){var t=g!==null&&g.apply(this,arguments)||this;return t.state={filename:""},t}return p.prototype.componentDidUpdate=function(t){t.value!==this.props.value&&!this.props.value&&this.setState({filename:""})},p.prototype.syncAutoFill=function(t){var a=this.props,i=a.autoFill,o=a.onBulkChange,l=a.data,c=a.name;if(!(i!=null&&i.hasOwnProperty("api")||!F(i))){var e=c?W(i,c):i;if(!w(e)&&o){var n=B(e,{filename:t});Object.keys(n).forEach(function(r){P(n[r])&&P(l[r])&&(n[r]=O({},l[r],n[r]))}),o(n)}}},p.prototype.handleDrop=function(t){var a=this,i=t[0],o=i.name,l=new FileReader;l.readAsArrayBuffer(i),l.onload=function(){return _(a,void 0,void 0,function(){var c=this;return I(this,function(e){return l.result&&(o.toLowerCase().endsWith(".xls")?T(()=>import("./xlsx-CfQreh1U.js"),[]).then(function(n){var r=n.read(new Uint8Array(l.result),{cellDates:!0}),h=n.writeXLSX(r,{type:"array"});c.processExcelFile(h,o)}):this.processExcelFile(l.result,o)),[2]})})}},p.prototype.processExcelFile=function(t,a){var i=this,o=this.props,l=o.allSheets,c=o.onChange,e=o.parseImage,n=o.autoFill;T(()=>import("./exceljs.min-DWd47z6R.js").then(r=>r.e),__vite__mapDeps([0,1,2])).then(function(r){return _(i,void 0,void 0,function(){var h,d,s,u,x,v,f=this;return I(this,function(b){switch(b.label){case 0:return h=r.default||r,this.ExcelJS=h,d=new h.Workbook,[4,d.xlsx.load(t)];case 1:return b.sent(),s=[],l?d.eachSheet(function(m){var k=m.state||"visible";k!=="hidden"&&(e?s.push({sheetName:m.name,data:f.readWorksheet(m),images:f.readImages(m,d)}):s.push({sheetName:m.name,data:f.readWorksheet(m)}))}):(u=d.worksheets.find(function(m){return m.state!=="hidden"}),e?(x=this.readImages(u,d),s={data:this.readWorksheet(u),images:x}):s=this.readWorksheet(u)),[4,this.dispatchEvent("change",s)];case 2:return v=b.sent(),v!=null&&v.prevented?[2]:(c(s),n&&this.syncAutoFill(a),this.setState({filename:a}),[2])}})})})},p.prototype.readImages=function(t,a){var i,o,l=this.props.imageDataURI,c=t.getImages(),e=[];try{for(var n=N(c),r=n.next();!r.done;r=n.next()){var h=r.value,d=a.getImage(+h.imageId),s=this.encodeBase64Bytes(d.buffer);if(l){var u=d.extension||"png";e.push("data:image/".concat(u,";base64,")+s)}else e.push(s)}}catch(x){i={error:x}}finally{try{r&&!r.done&&(o=n.return)&&o.call(n)}finally{if(i)throw i.error}}return e},p.prototype.encodeBase64Bytes=function(t){return btoa(t.reduce(function(a,i){return a+String.fromCharCode(i)},""))},p.prototype.dispatchEvent=function(t,a){return _(this,void 0,void 0,function(){var i,o;return I(this,function(l){switch(l.label){case 0:return i=this.props,o=i.dispatchEvent,i.data,[4,o(t,j(this.props,{value:a}))];case 1:return[2,l.sent()]}})})},p.prototype.isRichTextValue=function(t){return!!(t&&F(t)&&t.hasOwnProperty("richText")&&Array.isArray(t==null?void 0:t.richText))},p.prototype.richText2PlainString=function(t,a){a===void 0&&(a=!1);var i=t.richText.map(function(o){var l=o.text,c=o.font,e=c===void 0?{}:c,n=l;if(a){var r="",h=e!=null&&e.bold?"strong":e!=null&&e.italic?"em":(e==null?void 0:e.vertAlign)==="superscript"?"sup":(e==null?void 0:e.vertAlign)==="subscript"?"sub":"span";e!=null&&e.strike?r+="text-decoration: line-through;":e!=null&&e.underline&&(r+="text-decoration: underline;"),e!=null&&e.outline&&(r+="outline: solid;"),e!=null&&e.size&&(r+="font-size: ".concat(e.size,"px;")),n="<".concat(h," ").concat(r?"style=".concat(r):"",">").concat(l,"</").concat(h,">")}return n});return i.join("")},p.prototype.readWorksheet=function(t){var a=this,i=[],o=this.props,l=o.parseMode,c=o.plainText,e=o.includeEmpty;if(l==="array")return t.eachRow(function(r,h){var d=r.values;d.shift(),c&&(d=d.map(function(s){if(s instanceof Object){if(s.hyperlink)return s.hyperlink.startsWith("mailto:")?s.hyperlink.substring(7):s.hyperlink;if(s.result)return s.result;if(s.richText)return a.richText2PlainString(s)}return s})),i.push(d)}),i;var n=[];return t.eachRow(function(r,h){var d;if(h==1)n=((d=r.values)!==null&&d!==void 0?d:[]).map(function(u){return a.isRichTextValue(u)?a.richText2PlainString(u):u});else{var s={};e&&n.forEach(function(u){s[u]=""}),r.eachCell(function(u,x){if(n[x]){var v=u.value;if(c){var f=a.ExcelJS.ValueType;u.type===f.Hyperlink?(v=u.value.hyperlink,v.startsWith("mailto:")&&(v=v.substring(7))):u.type===f.Formula?v=u.value.result:u.type===f.RichText?v=a.richText2PlainString(u.value):u.type===f.Error&&(v="")}s[n[x]]=v}}),i.push(s)}}),i},p.prototype.doAction=function(t,a,i){var o,l,c=t==null?void 0:t.actionType,e=this.props,n=e.onChange,r=e.resetValue,h=e.formStore,d=e.store,s=e.name;if(c==="clear")n("");else if(c==="reset"){var u=(l=z((o=h==null?void 0:h.pristine)!==null&&o!==void 0?o:d==null?void 0:d.pristine,s))!==null&&l!==void 0?l:r;n(u??"")}},p.prototype.render=function(){var t=this,a=this.props,i=a.className,o=a.classnames;a.classPrefix;var l=a.disabled,c=a.translate,e=a.placeholder,n=a.testIdBuilder;return y.createElement("div",{className:o("ExcelControl",i)},y.createElement(U,{key:"drop-zone",onDrop:this.handleDrop,accept:".xlsx,.xls",multiple:!1,disabled:l},function(r){var h=r.getRootProps,d=r.getInputProps;return y.createElement("section",{className:o("ExcelControl-container",i)},y.createElement("div",R({},h({className:o("ExcelControl-dropzone")}),n==null?void 0:n.getTestId()),y.createElement("input",R({},d(),n==null?void 0:n.getChild("input").getTestId())),t.state.filename?c("Excel.parsed",{filename:t.state.filename}):y.createElement("p",null,e??c("Excel.placeholder"))))}))},p.defaultProps={allSheets:!1,parseMode:"object",includeEmpty:!0,plainText:!0,parseImage:!1,imageDataURI:!0},C([S,E("design:type",Function),E("design:paramtypes",[String]),E("design:returntype",void 0)],p.prototype,"syncAutoFill",null),C([S,E("design:type",Function),E("design:paramtypes",[Array]),E("design:returntype",void 0)],p.prototype,"handleDrop",null),p}(y.PureComponent),$=function(g){A(p,g);function p(){return g!==null&&g.apply(this,arguments)||this}return p=C([D({type:"input-excel"})],p),p}(M);export{$ as ExcelControlRenderer,M as default};
