import{fN as S,fO as b,ak as w,b as M,b_ as g,h as m,cb as E,cc as N,by as O,R as c,aY as f,c as h,ae as R,dM as x,d as P,L as $,a5 as j,fP as z,af as D,bP as C}from"./amis-WMe1Knp9.js";import"./react-vendor-DeqkGhWy.js";var y,A=b.named("MappingStore").props({fetching:!1,errorMsg:"",valueField:"value",map:j.frozen({})}).actions(function(l){var s=z(function(e,n,a){var r,t,i;return D(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,3,4]),l.fetching=!0,[4,e.fetcher(n,a)];case 1:if(r=o.sent(),r.ok)t=C(r.data),l.setMap(Array.isArray(t.options)?t.options:Array.isArray(t.items)?t.items:Array.isArray(t.records)?t.records:t);else throw new Error(r.msg||"fetch error");return[3,4];case 2:return i=o.sent(),l.errorMsg=i.message,[3,4];case 3:return l.fetching=!1,[7];case 4:return[2]}})});return{load:s,setMap:function(e){Array.isArray(e)&&(e=e.reduce(function(n,a){if(a==null)return n;if(f(a)){var r=Object.keys(a);r.length===1||r.length==2&&r.includes("$$id")?(r=r.filter(function(t){return t!=="$$id"}),n[r[0]]=a[r[0]]):r.length>1&&(n[a[l.valueField]]=a)}return n},{})),f(e)&&(l.map=h({},e))}}}),I=S(function(l){return A.create({id:w(),storeType:A.name},l.env)})((y=function(l){M(s,l);function s(e){var n=l.call(this,e)||this;return e.store.syncProps(e,void 0,["valueField","map"]),n}return s.prototype.componentDidMount=function(){this.reload()},s.prototype.componentDidUpdate=function(e){var n=this.props,a=this.props,r=a.store,t=a.source,i=a.data;if(r.syncProps(n,e,t?["valueField"]:["valueField","map"]),g(t)){var o=m(e.source,e.data,"| raw"),d=m(t,i,"| raw");o!==d&&r.setMap(d)}else E(e.source,n.source,e.data,n.data)&&this.reload()},s.prototype.reload=function(){var e,n=this.props,a=n.source,r=n.data,t=n.env,i=this.props.store;if(g(a))i.setMap(m(a,r,"| raw"));else if(N(a,r)){var o=O(a,"get");o.cache=(e=o.cache)!==null&&e!==void 0?e:30*1e3,i.load(t,o,r)}},s.prototype.renderSingleValue=function(e,n,a){var r,t=this.props,i=t.className,o=t.style,d=t.placeholder,v=t.classnames,u=t.store,V=c.createElement("span",{className:"text-muted"},d),p=u.map,_=void 0;e=typeof e=="string"?e.trim():e;var F=a?o:void 0;return typeof e<"u"&&p&&(_=(r=this.renderValue(p,e))!==null&&r!==void 0?r:e===!0&&p[1]?p[1]:e===!1&&p[0]?p[0]:p["*"])!==void 0&&(V=this.renderViewValue(_,e)),c.createElement("span",{key:"map-".concat(n),className:v("MappingField",i),style:F},V)},s.prototype.renderViewValue=function(e,n){var a=this.props,r=a.render,t=a.itemSchema,i=a.renderViewValue,o=a.data,d=a.labelField,v=a.name;if(i)return i(e,n);if(!t){var u=e;return f(e)&&(d===void 0||d===""?e.hasOwnProperty("type")?u=h({name:v},u):u=e.label:u=e[d||"label"]),f(u)&&u.type==="tag"&&!f(u.label)&&u.label!=null?r("mapping-tag",u,{value:null}):r("tpl",u)}return r("mappingItemSchema",t,h({data:R(o,f(e)?e:{item:e})},(t==null?void 0:t.type)==="tag"?{value:null}:{}))},s.prototype.renderValue=function(e,n){var a=this.props.renderValue;return a?a(e,n):e[n]},s.prototype.render=function(){var e=this,n=this.props,a=n.style,r=n.defaultValue,t=n.data,i=x(this.props);return r&&g(r)&&r===i&&(i=m(r,t,"| raw")),Array.isArray(i)?c.createElement("span",{style:a},i.map(function(o,d){return e.renderSingleValue(o,d)})):this.renderSingleValue(i,0,!0)},s}(c.Component),y.defaultProps={placeholder:"-",map:{"*":"通配值"}},y)),T=function(l){M(s,l);function s(){return l!==null&&l.apply(this,arguments)||this}return s.prototype.render=function(){return c.createElement(I,h({},this.props))},s=P([$({type:"mapping",alias:["map"],name:"mapping"})],s),s}(c.Component);export{I as MappingField,T as MappingFieldRenderer,A as Store};
