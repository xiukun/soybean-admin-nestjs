# SoybeanAdmin NestJS 低代码平台项目架构总览

## 项目简介

SoybeanAdmin NestJS 是一个基于微服务架构的企业级低代码平台，采用 Monorepo 结构设计。项目集成了完整的后台管理系统、可视化低代码设计器和代码生成平台，为开发者提供了从设计到部署的全流程低代码开发解决方案。

## 整体架构设计

### 架构模式
- **微服务架构**: 将不同功能模块拆分为独立的服务，便于维护和扩展
- **Monorepo 管理**: 统一管理多个相关项目，共享代码和配置
- **前后端分离**: 前端和后端完全解耦，支持独立开发和部署
- **容器化部署**: 基于 Docker 的容器化部署方案

### 技术选型原则
1. **现代化技术栈**: 采用最新稳定版本的主流技术
2. **类型安全**: 全面使用 TypeScript 确保代码质量
3. **高性能**: 选择高性能的框架和工具
4. **可扩展性**: 支持水平扩展和功能扩展
5. **开发体验**: 优化开发工具链和调试体验

## 服务架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户访问层                                 │
├─────────────────────────────────────────────────────────────────┤
│  Frontend (9527)     │  Lowcode Designer (9555)                │
│  管理后台前端         │  低代码可视化设计器                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        API 网关层                                │
├─────────────────────────────────────────────────────────────────┤
│                      Nginx / 负载均衡                            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        业务服务层                                 │
├─────────────────────────────────────────────────────────────────┤
│  Backend (9528)      │  Lowcode Platform (3000)  │  Amis Backend │
│  主业务后端服务       │  低代码平台核心服务         │  (9522)       │
│  - 用户管理          │  - 项目管理                │  生成代码运行时 │
│  - 权限控制          │  - 实体管理                │  - 动态API     │
│  - 系统配置          │  - 代码生成                │  - 数据操作    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储层                                 │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL (25432)  │  Redis (26379)     │  PgBouncer (6432)   │
│  主数据库            │  缓存和会话存储     │  连接池管理           │
│  - backend schema    │  - 缓存数据        │  - 连接复用           │
│  - lowcode schema    │  - 会话管理        │  - 性能优化           │
│  - amis schema       │  - 分布式锁        │                      │
└─────────────────────────────────────────────────────────────────┘
```

## 核心技术栈

### 前端技术栈

#### Frontend (管理后台)
- **框架**: Vue 3.5.16 + TypeScript 5.8.3
- **构建工具**: Vite 6.3.5
- **UI 组件库**: Naive UI 2.41.1
- **状态管理**: Pinia 3.0.3
- **路由管理**: Vue Router 4.5.1
- **样式方案**: UnoCSS + Sass
- **国际化**: Vue I18n 11.1.5
- **图表库**: ECharts 5.6.0
- **工具库**: VueUse 13.3.0, Dayjs 1.11.13

#### Lowcode Designer (设计器)
- **框架**: React 18.3.1 + TypeScript 5.6.2
- **构建工具**: Vite 6.0.5
- **UI 组件库**: Ant Design 5.24.4
- **低代码引擎**: Amis 6.11.0 + Amis Editor 6.11.0
- **状态管理**: Zustand 5.0.3 + MobX 4
- **样式方案**: Ant Design Style 3.7.1 + Sass 1.83.1
- **代码编辑器**: Monaco Editor 0.30.1

### 后端技术栈

#### Backend (主后端服务)
- **框架**: NestJS 11.0.12 + TypeScript 5.8.2
- **HTTP 服务器**: Fastify 5.2.2
- **ORM**: Prisma 6.5.0
- **数据库**: PostgreSQL 16.3
- **缓存**: Redis + IORedis 5.6.0
- **认证**: JWT + Passport
- **权限控制**: Casbin 5.38.0
- **API 文档**: Swagger 11.1.0
- **日志**: Winston 3.17.0
- **任务调度**: @nestjs/schedule 5.0.1

#### Lowcode Platform Backend (低代码平台)
- **框架**: NestJS 11.0.0 + TypeScript 5.1.0
- **架构模式**: DDD + CQRS
- **HTTP 服务器**: Fastify 5.2.2
- **ORM**: Prisma 6.5.0
- **模板引擎**: Handlebars 4.7.8
- **文件监控**: Chokidar 3.5.3
- **监控**: Prometheus Client 15.0.0

#### Amis Lowcode Backend (业务后端)
- **框架**: NestJS 11.0.12 + TypeScript 5.8.2
- **HTTP 服务器**: Fastify 5.2.2
- **ORM**: Prisma 6.5.0
- **模板引擎**: Handlebars 4.7.8
- **加密**: BCrypt 6.0.0

### 基础设施技术栈

#### 数据存储
- **主数据库**: PostgreSQL 16.3
- **连接池**: PgBouncer 1.23.1
- **缓存**: Redis Stack 7.2.0
- **数据迁移**: Prisma Migrate

#### 容器化部署
- **容器引擎**: Docker
- **编排工具**: Docker Compose
- **基础镜像**: Node.js 18+ Alpine
- **反向代理**: Nginx (可选)

## 数据库架构设计

### Schema 分离策略
项目采用单数据库多 Schema 的设计模式，实现逻辑隔离：

```sql
-- 主数据库: soybean-admin-nest-backend
├── backend schema     -- 主后端业务数据
│   ├── users         -- 用户表
│   ├── roles         -- 角色表
│   ├── permissions   -- 权限表
│   └── ...
├── lowcode schema    -- 低代码平台数据
│   ├── projects      -- 项目表
│   ├── entities      -- 实体表
│   ├── fields        -- 字段表
│   └── ...
└── amis schema       -- 生成代码运行时数据
    ├── dynamic_tables -- 动态生成的业务表
    └── ...
```

### 连接配置
- **Backend**: `postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=backend`
- **Lowcode Platform**: `postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=lowcode`
- **Amis Backend**: `postgresql://soybean:soybean@123.@postgres:5432/soybean-admin-nest-backend?schema=amis`

## 服务通信架构

### 服务间通信
```
Frontend ──HTTP──> Backend (9528)
    │
    └──HTTP──> Lowcode Platform (3000)
    │
    └──HTTP──> Amis Backend (9522)

Lowcode Designer ──HTTP──> Lowcode Platform (3000)

Backend ←──HTTP──→ Lowcode Platform ←──HTTP──→ Amis Backend
```

### API 设计规范
- **RESTful API**: 遵循 REST 设计原则
- **统一响应格式**: 标准化的 JSON 响应结构
- **版本控制**: URL 路径版本控制 (`/api/v1/`)
- **错误处理**: 统一的错误码和错误信息
- **认证授权**: JWT Token + RBAC 权限控制

## 部署架构

### Docker 容器化部署
```yaml
services:
  frontend:          # 前端服务 (端口: 9527)
  lowcode-designer:  # 设计器服务 (端口: 9555)
  backend:           # 主后端服务 (端口: 9528)
  lowcode-platform:  # 低代码平台 (端口: 3000)
  amis-backend:      # Amis后端 (端口: 9522)
  postgres:          # 数据库 (端口: 25432)
  pgbouncer:         # 连接池 (端口: 6432)
  redis:             # 缓存 (端口: 26379)
```

### 网络架构
- **网络隔离**: 使用 Docker 网络实现服务间隔离
- **服务发现**: 基于 Docker Compose 的服务名解析
- **负载均衡**: 支持多实例部署和负载均衡
- **健康检查**: 内置健康检查机制

## 安全架构

### 认证与授权
- **JWT 认证**: 无状态的 Token 认证机制
- **RBAC 权限**: 基于角色的访问控制
- **Casbin 引擎**: 灵活的权限策略引擎
- **密码加密**: BCrypt 加密存储

### 安全防护
- **CORS 配置**: 跨域请求安全控制
- **Rate Limiting**: API 请求频率限制
- **Helmet 防护**: HTTP 安全头设置
- **CSRF 防护**: 跨站请求伪造防护

## 监控与日志

### 日志系统
- **结构化日志**: Winston 日志框架
- **日志轮转**: 按日期自动轮转日志文件
- **日志级别**: 支持多级别日志输出
- **集中收集**: 支持日志集中收集和分析

### 监控指标
- **健康检查**: 服务健康状态监控
- **性能指标**: Prometheus 指标收集
- **资源监控**: CPU、内存、磁盘使用监控
- **业务指标**: 自定义业务指标监控

## 开发工作流

### 代码管理
- **Monorepo**: 统一代码仓库管理
- **工作空间**: pnpm workspace 依赖管理
- **代码规范**: ESLint + Prettier 代码格式化
- **提交规范**: 标准化的 Git 提交信息

### 开发环境
- **热重载**: 开发环境自动重载
- **类型检查**: TypeScript 类型安全
- **调试支持**: 完整的调试配置
- **测试框架**: Jest 单元测试和集成测试

## 扩展性设计

### 水平扩展
- **无状态设计**: 服务无状态，支持多实例部署
- **数据库分离**: 读写分离和分库分表支持
- **缓存策略**: 多级缓存提升性能
- **消息队列**: 支持异步任务处理

### 功能扩展
- **插件机制**: 支持功能插件扩展
- **模板系统**: 可扩展的代码生成模板
- **组件库**: 可复用的业务组件
- **API 扩展**: 灵活的 API 扩展机制

---

**文档版本**: v1.0.0  
**更新时间**: 2024年12月  
**维护团队**: SoybeanAdmin 开发团队